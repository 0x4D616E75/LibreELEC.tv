#!/bin/sh

. config/options

XORG_SRC="$PKG_BUILD/hw/xfree86"

get_graphicdrivers

$SCRIPTS/build toolchain

$SCRIPTS/build util-macros
$SCRIPTS/build font-util
$SCRIPTS/build fontsproto
$SCRIPTS/build randrproto
$SCRIPTS/build renderproto
$SCRIPTS/build scrnsaverproto
$SCRIPTS/build videoproto
$SCRIPTS/build inputproto
$SCRIPTS/build xf86dgaproto
$SCRIPTS/build xf86driproto
$SCRIPTS/build xf86miscproto
$SCRIPTS/build libfontenc
$SCRIPTS/build libpciaccess
$SCRIPTS/build libX11
$SCRIPTS/build libXfont
$SCRIPTS/build libxkbfile
$SCRIPTS/build libdrm
$SCRIPTS/build Mesa
$SCRIPTS/build openssl
$SCRIPTS/build freetype
$SCRIPTS/build pixman
$SCRIPTS/build fontsproto
$SCRIPTS/build udev

# Fails to compile with GCC's link time optimization.
  CFLAGS=`echo $CFLAGS | sed -e "s|-flto||" -e "s|-fuse-linker-plugin||"`
  CXXFLAGS=`echo $CXXFLAGS | sed -e "s|-flto||" -e "s|-fuse-linker-plugin||"`
  LDFLAGS=`echo $LDFLAGS | sed -e "s|-flto||" -e "s|-fuse-linker-plugin||" -e "s|-fwhole-program||"`

if [ "$XINERAMA_SUPPORT" = "yes" ]; then
  $SCRIPTS/build libXinerama
  XORG_XINERAMA="--enable-xinerama"
else
  XORG_XINERAMA="--disable-xinerama"
fi

cd $PKG_BUILD

$AUTORECONF

./configure --host=$TARGET_NAME \
            --build=$HOST_NAME \
            --prefix=/usr \
            --sysconfdir=/etc \
            --localstatedir=/var \
            --datarootdir=/usr/share \
            --disable-static \
            --enable-shared \
            --disable-debug \
            --disable-builddocs \
            --enable-largefile \
            --enable-install-libxf86config \
            --disable-xselinux \
            --with-pic \
            --enable-aiglx \
            --enable-glx-tls \
            --enable-registry \
            --disable-composite \
            $XORG_XINERAMA \
            --enable-mitshm \
            --disable-xres \
            --disable-record \
            --enable-xv \
            --disable-xvmc \
            --enable-dga \
            --disable-screensaver \
            --disable-xdmcp \
            --disable-xdm-auth-1 \
            --enable-glx \
            --enable-dri \
            --enable-dri2 \
            --enable-xf86vidmode \
            --enable-xace \
            --disable-xcsecurity \
            --disable-xcalibrate \
            --disable-tslib \
            --disable-multibuffer \
            --enable-dbe \
            --disable-xf86bigfont \
            --enable-dpms \
            --enable-config-udev \
            --disable-config-dbus \
            --disable-config-hal \
            --enable-xfree86-utils \
            --enable-xorg \
            --disable-dmx \
            --disable-xvfb \
            --disable-xnest \
            --disable-xquartz \
            --disable-standalone-xpbproxy \
            --disable-xwin \
            --disable-kdrive \
            --disable-xephyr \
            --disable-xfake \
            --enable-xfbdev \
            --disable-install-setuid \
            --disable-secure-rpc \
            --with-int10=x86emu \
            --disable-ipv6 \
            --with-gnu-ld \
            --with-sha1=libcrypto \
            --with-os-vendor="OpenELEC" \
            --with-module-dir=$XORG_PATH_MODULES \
            --with-xkb-path=$XORG_PATH_XKB \
            --with-xkb-output=/var/cache/xkb \
            --with-log-dir=/var/log \
            --with-dri-driver-path=$XORG_PATH_DRI \
            --with-fontrootdir=$XORG_PATH_FONTS \
            --with-default-font-path="$XORG_PATH_FONTS/misc,built-ins"

make

make DESTDIR=$SYSROOT_PREFIX install
