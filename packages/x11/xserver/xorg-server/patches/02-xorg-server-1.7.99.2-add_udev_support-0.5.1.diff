diff -Naur xorg-server-1.7.99.2/aclocal.m4 xorg-server-1.7.99.2.patch/aclocal.m4
diff -Naur xorg-server-1.7.99.2/composite/Makefile.in xorg-server-1.7.99.2.patch/composite/Makefile.in
--- xorg-server-1.7.99.2/composite/Makefile.in	2009-12-19 08:06:05.000000000 +0100
+++ xorg-server-1.7.99.2.patch/composite/Makefile.in	2009-12-20 14:08:16.171986972 +0100
@@ -292,6 +292,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/config/config-backends.h xorg-server-1.7.99.2.patch/config/config-backends.h
--- xorg-server-1.7.99.2/config/config-backends.h	2008-11-14 22:27:05.000000000 +0100
+++ xorg-server-1.7.99.2.patch/config/config-backends.h	2009-12-20 14:00:53.096864213 +0100
@@ -26,8 +26,18 @@
 #ifdef HAVE_DIX_CONFIG_H
 #include <dix-config.h>
 #endif
+#include "input.h"
 
-#ifdef CONFIG_NEED_DBUS
+void remove_devices(const char *backend, const char *config_info);
+BOOL device_is_duplicate(const char *config_info);
+void add_option(InputOption **options, const char *key, const char *value);
+
+#ifdef CONFIG_UDEV
+int config_udev_init(void);
+void config_udev_fini(void);
+#else
+
+# ifdef CONFIG_NEED_DBUS
 #include <dbus/dbus.h>
 
 typedef void (*config_dbus_core_connect_hook)(DBusConnection *connection,
@@ -46,14 +56,15 @@
 void config_dbus_core_fini(void);
 int config_dbus_core_add_hook(struct config_dbus_core_hook *hook);
 void config_dbus_core_remove_hook(struct config_dbus_core_hook *hook);
-#endif
+# endif
 
-#ifdef CONFIG_DBUS_API
+# ifdef CONFIG_DBUS_API
 int config_dbus_init(void);
 void config_dbus_fini(void);
-#endif
+# endif
 
-#ifdef CONFIG_HAL
+# ifdef CONFIG_HAL
 int config_hal_init(void);
 void config_hal_fini(void);
+# endif
 #endif
diff -Naur xorg-server-1.7.99.2/config/config.c xorg-server-1.7.99.2.patch/config/config.c
--- xorg-server-1.7.99.2/config/config.c	2009-11-04 17:25:50.000000000 +0100
+++ xorg-server-1.7.99.2.patch/config/config.c	2009-12-20 14:00:53.097895133 +0100
@@ -28,13 +28,17 @@
 #endif
 
 #include "os.h"
+#include "inputstr.h"
 #include "hotplug.h"
 #include "config-backends.h"
 
 void
 config_init(void)
 {
-#if defined(CONFIG_DBUS_API) || defined(CONFIG_HAL)
+#ifdef CONFIG_UDEV
+    if (!config_udev_init())
+        ErrorF("[config] failed to initialise udev\n");
+#elif defined(CONFIG_NEED_DBUS)
     if (config_dbus_core_init()) {
 # ifdef CONFIG_DBUS_API
        if (!config_dbus_init())
@@ -54,7 +58,9 @@
 void
 config_fini(void)
 {
-#if defined(CONFIG_DBUS_API) || defined(CONFIG_HAL)
+#if defined(CONFIG_UDEV)
+    config_udev_fini();
+#elif defined(CONFIG_NEED_DBUS)
 # ifdef CONFIG_HAL
     config_hal_fini();
 # endif
@@ -64,3 +70,70 @@
     config_dbus_core_fini();
 #endif
 }
+
+static void
+remove_device(const char *backend, DeviceIntPtr dev)
+{
+    /* this only gets called for devices that have already been added */
+    LogMessage(X_INFO, "config/%s: removing device %s\n", backend, dev->name);
+
+    /* Call PIE here so we don't try to dereference a device that's
+     * already been removed. */
+    OsBlockSignals();
+    ProcessInputEvents();
+    DeleteInputDeviceRequest(dev);
+    OsReleaseSignals();
+}
+
+void
+remove_devices(const char *backend, const char *config_info)
+{
+    DeviceIntPtr dev, next;
+
+    for (dev = inputInfo.devices; dev; dev = next) {
+        next = dev->next;
+        if (dev->config_info && strcmp(dev->config_info, config_info) == 0)
+            remove_device(backend, dev);
+    }
+    for (dev = inputInfo.off_devices; dev; dev = next) {
+        next = dev->next;
+        if (dev->config_info && strcmp(dev->config_info, config_info) == 0)
+            remove_device(backend, dev);
+    }
+}
+
+BOOL
+device_is_duplicate(const char *config_info)
+{
+    DeviceIntPtr dev;
+
+    for (dev = inputInfo.devices; dev; dev = dev->next)
+    {
+        if (dev->config_info && (strcmp(dev->config_info, config_info) == 0))
+            return TRUE;
+    }
+
+    for (dev = inputInfo.off_devices; dev; dev = dev->next)
+    {
+        if (dev->config_info && (strcmp(dev->config_info, config_info) == 0))
+            return TRUE;
+    }
+
+    return FALSE;
+}
+
+void
+add_option(InputOption **options, const char *key, const char *value)
+{
+    if (!value || *value == '\0')
+        return;
+
+    for (; *options; options = &(*options)->next)
+        ;
+    *options = xcalloc(sizeof(**options), 1);
+    if (!*options) /* Yeesh. */
+        return;
+    (*options)->key = xstrdup(key);
+    (*options)->value = xstrdup(value);
+    (*options)->next = NULL;
+}
diff -Naur xorg-server-1.7.99.2/config/hal.c xorg-server-1.7.99.2.patch/config/hal.c
--- xorg-server-1.7.99.2/config/hal.c	2009-08-26 04:46:15.000000000 +0200
+++ xorg-server-1.7.99.2.patch/config/hal.c	2009-12-20 14:00:53.098988908 +0100
@@ -58,25 +58,9 @@
     char* options;
 };
 
-
-static void
-remove_device(DeviceIntPtr dev)
-{
-    /* this only gets called for devices that have already been added */
-    LogMessage(X_INFO, "config/hal: removing device %s\n", dev->name);
-
-    /* Call PIE here so we don't try to dereference a device that's
-     * already been removed. */
-    OsBlockSignals();
-    ProcessInputEvents();
-    DeleteInputDeviceRequest(dev);
-    OsReleaseSignals();
-}
-
 static void
 device_removed(LibHalContext *ctx, const char *udi)
 {
-    DeviceIntPtr dev, next;
     char *value;
 
     value = xalloc(strlen(udi) + 5); /* "hal:" + NULL */
@@ -84,36 +68,11 @@
         return;
     sprintf(value, "hal:%s", udi);
 
-    for (dev = inputInfo.devices; dev; dev = next) {
-	next = dev->next;
-        if (dev->config_info && strcmp(dev->config_info, value) == 0)
-            remove_device(dev);
-    }
-    for (dev = inputInfo.off_devices; dev; dev = next) {
-	next = dev->next;
-        if (dev->config_info && strcmp(dev->config_info, value) == 0)
-            remove_device(dev);
-    }
+    remove_devices("hal", value);
 
     xfree(value);
 }
 
-static void
-add_option(InputOption **options, const char *key, const char *value)
-{
-    if (!value || *value == '\0')
-        return;
-
-    for (; *options; options = &(*options)->next)
-        ;
-    *options = xcalloc(sizeof(**options), 1);
-    if (!*options) /* Yeesh. */
-        return;
-    (*options)->key = xstrdup(key);
-    (*options)->value = xstrdup(value);
-    (*options)->next = NULL;
-}
-
 static char *
 get_prop_string(LibHalContext *hal_ctx, const char *udi, const char *name)
 {
@@ -166,26 +125,6 @@
     return ret;
 }
 
-static BOOL
-device_is_duplicate(char *config_info)
-{
-    DeviceIntPtr dev;
-
-    for (dev = inputInfo.devices; dev; dev = dev->next)
-    {
-        if (dev->config_info && (strcmp(dev->config_info, config_info) == 0))
-            return TRUE;
-    }
-
-    for (dev = inputInfo.off_devices; dev; dev = dev->next)
-    {
-        if (dev->config_info && (strcmp(dev->config_info, config_info) == 0))
-            return TRUE;
-    }
-
-    return FALSE;
-}
-
 static void
 device_added(LibHalContext *hal_ctx, const char *udi)
 {
diff -Naur xorg-server-1.7.99.2/config/Makefile.am xorg-server-1.7.99.2.patch/config/Makefile.am
--- xorg-server-1.7.99.2/config/Makefile.am	2009-11-04 17:25:50.000000000 +0100
+++ xorg-server-1.7.99.2.patch/config/Makefile.am	2009-12-20 14:00:53.099988888 +0100
@@ -3,10 +3,18 @@
 noinst_LTLIBRARIES = libconfig.la
 libconfig_la_SOURCES = config.c config-backends.h
 
+if CONFIG_UDEV
+
+AM_CFLAGS += @UDEV_CFLAGS@
+libconfig_la_SOURCES += udev.c
+libconfig_la_LIBADD = @UDEV_LIBS@
+
+else
+
 if CONFIG_NEED_DBUS
 AM_CFLAGS += @DBUS_CFLAGS@
 libconfig_la_SOURCES += dbus-core.c
-endif
+libconfig_la_LIBADD = @DBUS_LIBS@
 
 if CONFIG_DBUS_API
 dbusconfigdir = $(sysconfdir)/dbus-1/system.d
@@ -16,7 +24,13 @@
 endif
 
 if CONFIG_HAL
+AM_CFLAGS += @HAL_CFLAGS@
 libconfig_la_SOURCES += hal.c
+libconfig_la_LIBADD += @HAL_LIBS@
 endif
 
+endif # CONFIG_NEED_DBUS
+
+endif # !CONFIG_UDEV
+
 EXTRA_DIST = xorg-server.conf x11-input.fdi
diff -Naur xorg-server-1.7.99.2/config/Makefile.in xorg-server-1.7.99.2.patch/config/Makefile.in
--- xorg-server-1.7.99.2/config/Makefile.in	2009-12-19 08:06:05.000000000 +0100
+++ xorg-server-1.7.99.2.patch/config/Makefile.in	2009-12-20 14:08:16.365986653 +0100
@@ -35,10 +35,14 @@
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
-@CONFIG_NEED_DBUS_TRUE@am__append_1 = @DBUS_CFLAGS@
-@CONFIG_NEED_DBUS_TRUE@am__append_2 = dbus-core.c
-@CONFIG_DBUS_API_TRUE@am__append_3 = dbus.c
-@CONFIG_HAL_TRUE@am__append_4 = hal.c
+@CONFIG_UDEV_TRUE@am__append_1 = @UDEV_CFLAGS@
+@CONFIG_UDEV_TRUE@am__append_2 = udev.c
+@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@am__append_3 = @DBUS_CFLAGS@
+@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@am__append_4 = dbus-core.c
+@CONFIG_DBUS_API_TRUE@@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@am__append_5 = dbus.c
+@CONFIG_HAL_TRUE@@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@am__append_6 = @HAL_CFLAGS@
+@CONFIG_HAL_TRUE@@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@am__append_7 = hal.c
+@CONFIG_HAL_TRUE@@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@am__append_8 = @HAL_LIBS@
 subdir = config
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
@@ -61,14 +65,18 @@
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
 LTLIBRARIES = $(noinst_LTLIBRARIES)
-libconfig_la_LIBADD =
-am__libconfig_la_SOURCES_DIST = config.c config-backends.h dbus-core.c \
-	dbus.c hal.c
-@CONFIG_NEED_DBUS_TRUE@am__objects_1 = dbus-core.lo
-@CONFIG_DBUS_API_TRUE@am__objects_2 = dbus.lo
-@CONFIG_HAL_TRUE@am__objects_3 = hal.lo
+am__DEPENDENCIES_1 =
+@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@libconfig_la_DEPENDENCIES = $(am__DEPENDENCIES_1)
+@CONFIG_UDEV_TRUE@libconfig_la_DEPENDENCIES = $(am__DEPENDENCIES_1)
+am__libconfig_la_SOURCES_DIST = config.c config-backends.h udev.c \
+	dbus-core.c dbus.c hal.c
+@CONFIG_UDEV_TRUE@am__objects_1 = udev.lo
+@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@am__objects_2 =  \
+@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@	dbus-core.lo
+@CONFIG_DBUS_API_TRUE@@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@am__objects_3 = dbus.lo
+@CONFIG_HAL_TRUE@@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@am__objects_4 = hal.lo
 am_libconfig_la_OBJECTS = config.lo $(am__objects_1) $(am__objects_2) \
-	$(am__objects_3)
+	$(am__objects_3) $(am__objects_4)
 libconfig_la_OBJECTS = $(am_libconfig_la_OBJECTS)
 AM_V_lt = $(am__v_lt_$(V))
 am__v_lt_ = $(am__v_lt_$(AM_DEFAULT_VERBOSITY))
@@ -299,6 +307,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
@@ -421,12 +431,17 @@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
-AM_CFLAGS = @DIX_CFLAGS@ $(am__append_1)
+AM_CFLAGS = @DIX_CFLAGS@ $(am__append_1) $(am__append_3) \
+	$(am__append_6)
 noinst_LTLIBRARIES = libconfig.la
 libconfig_la_SOURCES = config.c config-backends.h $(am__append_2) \
-	$(am__append_3) $(am__append_4)
-@CONFIG_DBUS_API_TRUE@dbusconfigdir = $(sysconfdir)/dbus-1/system.d
-@CONFIG_DBUS_API_TRUE@dbusconfig_DATA = xorg-server.conf
+	$(am__append_4) $(am__append_5) $(am__append_7)
+@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@libconfig_la_LIBADD =  \
+@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@	@DBUS_LIBS@ \
+@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@	$(am__append_8)
+@CONFIG_UDEV_TRUE@libconfig_la_LIBADD = @UDEV_LIBS@ $(am__append_8)
+@CONFIG_DBUS_API_TRUE@@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@dbusconfigdir = $(sysconfdir)/dbus-1/system.d
+@CONFIG_DBUS_API_TRUE@@CONFIG_NEED_DBUS_TRUE@@CONFIG_UDEV_FALSE@dbusconfig_DATA = xorg-server.conf
 EXTRA_DIST = xorg-server.conf x11-input.fdi
 all: all-am
 
@@ -484,6 +499,7 @@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dbus-core.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dbus.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/hal.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/udev.Plo@am__quote@
 
 .c.o:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
diff -Naur xorg-server-1.7.99.2/config/udev.c xorg-server-1.7.99.2.patch/config/udev.c
--- xorg-server-1.7.99.2/config/udev.c	1970-01-01 01:00:00.000000000 +0100
+++ xorg-server-1.7.99.2.patch/config/udev.c	2009-12-20 14:00:53.100987890 +0100
@@ -0,0 +1,245 @@
+/*
+ * Copyright Â© 2009 Julien Cristau
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a
+ * copy of this software and associated documentation files (the "Software"),
+ * to deal in the Software without restriction, including without limitation
+ * the rights to use, copy, modify, merge, publish, distribute, sublicense,
+ * and/or sell copies of the Software, and to permit persons to whom the
+ * Software is furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice (including the next
+ * paragraph) shall be included in all copies or substantial portions of the
+ * Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+ * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+ * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
+ * DEALINGS IN THE SOFTWARE.
+ *
+ * Author: Julien Cristau <jcristau at debian.org>
+ */
+
+#ifdef HAVE_DIX_CONFIG_H
+#include <dix-config.h>
+#endif
+
+#include <libudev.h>
+
+#include "input.h"
+#include "inputstr.h"
+#include "hotplug.h"
+#include "config-backends.h"
+#include "os.h"
+
+#define UDEV_XKB_PROP_KEY "xkb"
+#define UDEV_PROP_KEY "x11_options."
+
+static struct udev_monitor *udev_monitor;
+
+static void
+device_added(struct udev_device *udev_device)
+{
+    const char *path = NULL, *driver = NULL, *name = NULL;
+    char *config_info = NULL;
+    const char *syspath;
+    const char *key, *value, *tmp;
+    InputOption *options = NULL, *tmpo;
+    DeviceIntPtr dev = NULL;
+    struct udev_list_entry *set, *entry;
+    struct udev_device *parent;
+    int rc;
+
+    driver = udev_device_get_property_value(udev_device, "x11_driver");
+
+    path = udev_device_get_devnode(udev_device);
+
+    syspath = udev_device_get_syspath(udev_device);
+
+    parent = udev_device_get_parent(udev_device);
+    if (parent)
+        name = udev_device_get_property_value(parent, "NAME");
+    else
+        name = "(unnamed)";
+
+    if (!driver || !path || !syspath)
+        return;
+    options = xcalloc(sizeof(*options), 1);
+    if (!options)
+        return;
+
+    options->key = xstrdup("_source");
+    options->value = xstrdup("server/udev");
+    if (!options->key || !options->value)
+        goto unwind;
+
+    add_option(&options, "path", path);
+    add_option(&options, "device", path);
+    add_option(&options, "driver", driver);
+
+    config_info = Xprintf("udev:%s", syspath);
+    if (!config_info)
+        goto unwind;
+
+    if (device_is_duplicate(config_info)) {
+        LogMessage(X_WARNING, "config/udev: device %s already added. "
+                              "Ignoring.\n", name);
+        goto unwind;
+    }
+
+    set = udev_device_get_properties_list_entry(udev_device);
+    udev_list_entry_foreach(entry, set) {
+        key = udev_list_entry_get_name(entry);
+        if (!key)
+            continue;
+        if (!strncasecmp(key, UDEV_PROP_KEY, sizeof(UDEV_PROP_KEY) - 1)) {
+            value = udev_list_entry_get_value(entry);
+            add_option(&options, key + sizeof(UDEV_PROP_KEY) - 1, value);
+        } else if (!strncasecmp(key, UDEV_XKB_PROP_KEY,
+                                sizeof(UDEV_XKB_PROP_KEY) - 1)) {
+            tmp = key + sizeof(UDEV_XKB_PROP_KEY) - 1;
+            value = udev_list_entry_get_value(entry);
+            if (!strcasecmp(tmp, "rules"))
+                add_option(&options, "xkb_rules", value);
+            else if (!strcasecmp(tmp, "layout"))
+                add_option(&options, "xkb_layout", value);
+            else if (!strcasecmp(tmp, "variant"))
+                add_option(&options, "xkb_variant", value);
+            else if (!strcasecmp(tmp, "model"))
+                add_option(&options, "xkb_model", value);
+            else if (!strcasecmp(tmp, "options"))
+                add_option(&options, "xkb_options", value);
+        }
+    }
+    add_option(&options, "name", name);
+    LogMessage(X_INFO, "config/udev: Adding input device %s (%s)\n",
+               name, path);
+    rc = NewInputDeviceRequest(options, &dev);
+    if (rc != Success)
+        goto unwind;
+
+    for (; dev; dev = dev->next) {
+        xfree(dev->config_info);
+        dev->config_info = xstrdup(config_info);
+    }
+
+ unwind:
+    xfree(config_info);
+    while (!dev && (tmpo = options)) {
+        options = tmpo->next;
+        xfree(tmpo->key);
+        xfree(tmpo->value);
+        xfree(tmpo);
+    }
+
+    return;
+}
+
+static void
+device_removed(struct udev_device *device)
+{
+    char *value;
+    const char *syspath = udev_device_get_syspath(device);
+
+    value = Xprintf("udev:%s", syspath);
+    if (!value)
+        return;
+
+    remove_devices("udev", value);
+
+    xfree(value);
+}
+
+static void
+wakeup_handler(pointer data, int err, pointer read_mask)
+{
+    int udev_fd = udev_monitor_get_fd(udev_monitor);
+    struct udev_device *udev_device;
+    const char *action;
+
+    if (err < 0)
+        return;
+
+    if (FD_ISSET(udev_fd, (fd_set *)read_mask)) {
+        udev_device = udev_monitor_receive_device(udev_monitor);
+        if (!udev_device)
+            return;
+        action = udev_device_get_action(udev_device);
+        if (!action)
+            ;
+        else if (!strcmp(action, "add"))
+            device_added(udev_device);
+        else if (!strcmp(action, "remove"))
+            device_removed(udev_device);
+        udev_device_unref(udev_device);
+    }
+}
+
+static void
+block_handler(pointer data, struct timeval **tv, pointer read_mask)
+{
+}
+
+int
+config_udev_init(void)
+{
+    struct udev *udev;
+    struct udev_enumerate *enumerate;
+    struct udev_list_entry *devices, *device;
+    int rc;
+
+    udev = udev_new();
+    if (!udev)
+        return 0;
+    udev_monitor = udev_monitor_new_from_netlink(udev, "udev");
+    if (!udev_monitor)
+        return 0;
+    rc = udev_monitor_filter_add_match_subsystem_devtype(udev_monitor,
+                                                         "input", NULL);
+    if (rc < 0)
+        return 0;
+
+    if (udev_monitor_enable_receiving(udev_monitor)) {
+        ErrorF("config/udev: failed to bind the udev monitor\n");
+	return 0;
+    }
+
+    enumerate = udev_enumerate_new(udev);
+    if (!enumerate)
+        return 0;
+    udev_enumerate_add_match_subsystem(enumerate, "input");
+    udev_enumerate_scan_devices(enumerate);
+    devices = udev_enumerate_get_list_entry(enumerate);
+    udev_list_entry_foreach(device, devices) {
+        const char *syspath = udev_list_entry_get_name(device);
+        struct udev_device *udev_device = udev_device_new_from_syspath(udev, syspath);
+        device_added(udev_device);
+        udev_device_unref(udev_device);
+    }
+    udev_enumerate_unref(enumerate);
+
+    RegisterBlockAndWakeupHandlers(block_handler, wakeup_handler, NULL);
+    AddGeneralSocket(udev_monitor_get_fd(udev_monitor));
+
+    return 1;
+}
+
+void
+config_udev_fini(void)
+{
+    struct udev *udev;
+
+    if (!udev_monitor)
+        return;
+
+    udev = udev_monitor_get_udev(udev_monitor);
+
+    RemoveGeneralSocket(udev_monitor_get_fd(udev_monitor));
+    RemoveBlockAndWakeupHandlers(block_handler, wakeup_handler, udev_monitor);
+    udev_monitor_unref(udev_monitor);
+    udev_monitor = NULL;
+    udev_unref(udev);
+}
diff -Naur xorg-server-1.7.99.2/config/x11-input.rules xorg-server-1.7.99.2.patch/config/x11-input.rules
--- xorg-server-1.7.99.2/config/x11-input.rules	1970-01-01 01:00:00.000000000 +0100
+++ xorg-server-1.7.99.2.patch/config/x11-input.rules	2009-12-20 14:00:53.100987890 +0100
@@ -0,0 +1,14 @@
+SUBSYSTEM!="input", GOTO="x11_input_end"
+ACTION!="change|add", GOTO="x11_input_end"
+KERNEL!="event*", GOTO="x11_input_end"
+
+# use the evdev driver by default
+ENV{x11_driver}="evdev"
+
+# set xkb layout if we have keys
+ENV{ID_INPUT_KEY}=="?*", ENV{xkblayout}="us"
+
+# use synaptics for touchpads
+ENV{ID_INPUT_TOUCHPAD}=="?*", ENV{x11_driver}="synaptics"
+
+LABEL="x11_input_end"
diff -Naur xorg-server-1.7.99.2/configure xorg-server-1.7.99.2.patch/configure
--- xorg-server-1.7.99.2/configure	2009-12-19 08:06:02.000000000 +0100
+++ xorg-server-1.7.99.2.patch/configure	2009-12-20 14:08:13.965861423 +0100
@@ -1025,6 +1025,10 @@
 HAVE_DBUS_TRUE
 DBUS_LIBS
 DBUS_CFLAGS
+CONFIG_UDEV_FALSE
+CONFIG_UDEV_TRUE
+UDEV_LIBS
+UDEV_CFLAGS
 INSTALL_LIBXF86CONFIG_FALSE
 INSTALL_LIBXF86CONFIG_TRUE
 MAKE_HTML
@@ -1320,6 +1324,7 @@
 enable_dbe
 enable_xf86bigfont
 enable_dpms
+enable_config_udev
 enable_config_dbus
 enable_config_hal
 enable_xfree86_utils
@@ -1361,6 +1366,8 @@
 CCASFLAGS
 YACC
 YFLAGS
+UDEV_CFLAGS
+UDEV_LIBS
 DBUS_CFLAGS
 DBUS_LIBS
 HAL_CFLAGS
@@ -2098,6 +2105,7 @@
   --disable-dbe           Build DBE extension (default: enabled)
   --disable-xf86bigfont   Build XF86 Big Font extension (default: disabled)
   --disable-dpms          Build DPMS extension (default: enabled)
+  --enable-config-udev    Build udev support (default: auto)
   --enable-config-dbus    Build D-BUS API support (default: no)
   --disable-config-hal    Build HAL support (default: auto)
   --enable-xfree86-utils  Build xfree86 DDX utilities (default: enabled)
@@ -2124,7 +2132,7 @@
                           (default: auto)
   --enable-unix-transport Enable UNIX domain socket transport
   --enable-tcp-transport  Enable TCP socket transport
-  --enable-ipv6           Enable IPv6 support
+  --enable-IPv6           Enable IPv6 support
   --enable-local-transport
                           Enable os-specific local transport
   --enable-secure-rpc     Enable Secure RPC
@@ -2216,6 +2224,8 @@
   YFLAGS      The list of arguments that will be passed by default to $YACC.
               This script will default YFLAGS to the empty string to avoid a
               default value of `-d' given by some make applications.
+  UDEV_CFLAGS C compiler flags for UDEV, overriding pkg-config
+  UDEV_LIBS   linker flags for UDEV, overriding pkg-config
   DBUS_CFLAGS C compiler flags for DBUS, overriding pkg-config
   DBUS_LIBS   linker flags for DBUS, overriding pkg-config
   HAL_CFLAGS  C compiler flags for HAL, overriding pkg-config
@@ -7570,13 +7580,13 @@
 else
   lt_cv_nm_interface="BSD nm"
   echo "int some_variable = 0;" > conftest.$ac_ext
-  (eval echo "\"\$as_me:7573: $ac_compile\"" >&5)
+  (eval echo "\"\$as_me:7583: $ac_compile\"" >&5)
   (eval "$ac_compile" 2>conftest.err)
   cat conftest.err >&5
-  (eval echo "\"\$as_me:7576: $NM \\\"conftest.$ac_objext\\\"\"" >&5)
+  (eval echo "\"\$as_me:7586: $NM \\\"conftest.$ac_objext\\\"\"" >&5)
   (eval "$NM \"conftest.$ac_objext\"" 2>conftest.err > conftest.out)
   cat conftest.err >&5
-  (eval echo "\"\$as_me:7579: output\"" >&5)
+  (eval echo "\"\$as_me:7589: output\"" >&5)
   cat conftest.out >&5
   if $GREP 'External.*some_variable' conftest.out > /dev/null; then
     lt_cv_nm_interface="MS dumpbin"
@@ -8767,7 +8777,7 @@
   ;;
 *-*-irix6*)
   # Find out which ABI we are using.
-  echo '#line 8770 "configure"' > conftest.$ac_ext
+  echo '#line 8780 "configure"' > conftest.$ac_ext
   if { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_compile\""; } >&5
   (eval $ac_compile) 2>&5
   ac_status=$?
@@ -9997,11 +10007,11 @@
    -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
    -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
    -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:10000: $lt_compile\"" >&5)
+   (eval echo "\"\$as_me:10010: $lt_compile\"" >&5)
    (eval "$lt_compile" 2>conftest.err)
    ac_status=$?
    cat conftest.err >&5
-   echo "$as_me:10004: \$? = $ac_status" >&5
+   echo "$as_me:10014: \$? = $ac_status" >&5
    if (exit $ac_status) && test -s "$ac_outfile"; then
      # The compiler can only warn and ignore the option if not recognized
      # So say no if there are warnings other than the usual output.
@@ -10336,11 +10346,11 @@
    -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
    -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
    -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:10339: $lt_compile\"" >&5)
+   (eval echo "\"\$as_me:10349: $lt_compile\"" >&5)
    (eval "$lt_compile" 2>conftest.err)
    ac_status=$?
    cat conftest.err >&5
-   echo "$as_me:10343: \$? = $ac_status" >&5
+   echo "$as_me:10353: \$? = $ac_status" >&5
    if (exit $ac_status) && test -s "$ac_outfile"; then
      # The compiler can only warn and ignore the option if not recognized
      # So say no if there are warnings other than the usual output.
@@ -10441,11 +10451,11 @@
    -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
    -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
    -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:10444: $lt_compile\"" >&5)
+   (eval echo "\"\$as_me:10454: $lt_compile\"" >&5)
    (eval "$lt_compile" 2>out/conftest.err)
    ac_status=$?
    cat out/conftest.err >&5
-   echo "$as_me:10448: \$? = $ac_status" >&5
+   echo "$as_me:10458: \$? = $ac_status" >&5
    if (exit $ac_status) && test -s out/conftest2.$ac_objext
    then
      # The compiler can only warn and ignore the option if not recognized
@@ -10496,11 +10506,11 @@
    -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
    -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
    -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:10499: $lt_compile\"" >&5)
+   (eval echo "\"\$as_me:10509: $lt_compile\"" >&5)
    (eval "$lt_compile" 2>out/conftest.err)
    ac_status=$?
    cat out/conftest.err >&5
-   echo "$as_me:10503: \$? = $ac_status" >&5
+   echo "$as_me:10513: \$? = $ac_status" >&5
    if (exit $ac_status) && test -s out/conftest2.$ac_objext
    then
      # The compiler can only warn and ignore the option if not recognized
@@ -12880,7 +12890,7 @@
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-#line 12883 "configure"
+#line 12893 "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -12976,7 +12986,7 @@
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-#line 12979 "configure"
+#line 12989 "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -16493,6 +16503,13 @@
   DPMSExtension=yes
 fi
 
+# Check whether --enable-config-udev was given.
+if test "${enable_config_udev+set}" = set; then :
+  enableval=$enable_config_udev; CONFIG_UDEV=$enableval
+else
+  CONFIG_UDEV=auto
+fi
+
 # Check whether --enable-config-dbus was given.
 if test "${enable_config_dbus+set}" = set; then :
   enableval=$enable_config_dbus; CONFIG_DBUS_API=$enableval
@@ -16845,46 +16862,6 @@
 
 fi
 
- { $as_echo "$as_me:${as_lineno-$LINENO}: checking for main in -lws2_32" >&5
-$as_echo_n "checking for main in -lws2_32... " >&6; }
-if test "${ac_cv_lib_ws2_32_main+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lws2_32  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-
-int
-main ()
-{
-return main ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ws2_32_main=yes
-else
-  ac_cv_lib_ws2_32_main=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ws2_32_main" >&5
-$as_echo "$ac_cv_lib_ws2_32_main" >&6; }
-if test "x$ac_cv_lib_ws2_32_main" = x""yes; then :
-  cat >>confdefs.h <<_ACEOF
-#define HAVE_LIBWS2_32 1
-_ACEOF
-
-  LIBS="-lws2_32 $LIBS"
-
-fi
-ac_cv_lib_ws2_32=ac_cv_lib_ws2_32_main
-
 
  # Needs to come after above checks for libsocket & libnsl for SVR4 systems
  # Check whether --enable-ipv6 was given.
@@ -17383,17 +17360,111 @@
 LIBXTST="xtst >= 1.0.99.2"
 LIBPCIACCESS="pciaccess >= 0.8.0"
 LIBGLIB="glib-2.0 >= 2.16"
+LIBUDEV="libudev >= 143"
+
+if test "x$CONFIG_UDEV" = xyes &&
+ { test "x$CONFIG_DBUS_API" = xyes || test "x$CONFIG_HAL" = xyes; }; then
+	as_fn_error "Hotplugging through both libudev and dbus/hal not allowed" "$LINENO" 5
+fi
+
+
+pkg_failed=no
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for UDEV" >&5
+$as_echo_n "checking for UDEV... " >&6; }
+
+if test -n "$UDEV_CFLAGS"; then
+    pkg_cv_UDEV_CFLAGS="$UDEV_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
+    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBUDEV\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "$LIBUDEV") 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; then
+  pkg_cv_UDEV_CFLAGS=`$PKG_CONFIG --cflags "$LIBUDEV" 2>/dev/null`
+else
+  pkg_failed=yes
+fi
+ else
+    pkg_failed=untried
+fi
+if test -n "$UDEV_LIBS"; then
+    pkg_cv_UDEV_LIBS="$UDEV_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
+    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBUDEV\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "$LIBUDEV") 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; then
+  pkg_cv_UDEV_LIBS=`$PKG_CONFIG --libs "$LIBUDEV" 2>/dev/null`
+else
+  pkg_failed=yes
+fi
+ else
+    pkg_failed=untried
+fi
+
+
+
+if test $pkg_failed = yes; then
+
+if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
+        _pkg_short_errors_supported=yes
+else
+        _pkg_short_errors_supported=no
+fi
+        if test $_pkg_short_errors_supported = yes; then
+	        UDEV_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$LIBUDEV" 2>&1`
+        else
+	        UDEV_PKG_ERRORS=`$PKG_CONFIG --print-errors "$LIBUDEV" 2>&1`
+        fi
+	# Put the nasty error message in config.log where it belongs
+	echo "$UDEV_PKG_ERRORS" >&5
+
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+                HAVE_LIBUDEV=no
+elif test $pkg_failed = untried; then
+	HAVE_LIBUDEV=no
+else
+	UDEV_CFLAGS=$pkg_cv_UDEV_CFLAGS
+	UDEV_LIBS=$pkg_cv_UDEV_LIBS
+        { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+	HAVE_LIBUDEV=yes
+fi
+if test "x$CONFIG_UDEV" = xauto; then
+	CONFIG_UDEV="$HAVE_LIBUDEV"
+fi
+ if test "x$CONFIG_UDEV" = xyes; then
+  CONFIG_UDEV_TRUE=
+  CONFIG_UDEV_FALSE='#'
+else
+  CONFIG_UDEV_TRUE='#'
+  CONFIG_UDEV_FALSE=
+fi
+
+if test "x$CONFIG_UDEV" = xyes; then
+	CONFIG_DBUS_API=no
+	CONFIG_HAL=no
+	if ! test "x$HAVE_LIBUDEV" = xyes; then
+		as_fn_error "udev configuration API requested, but libudev is not installed" "$LINENO" 5
+	fi
+
+$as_echo "#define CONFIG_UDEV 1" >>confdefs.h
+
+fi
 
 
 pkg_failed=no
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for DBUS" >&5
 $as_echo_n "checking for DBUS... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DBUS_CFLAGS"; then
-        pkg_cv_DBUS_CFLAGS="$DBUS_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DBUS_CFLAGS"; then
+    pkg_cv_DBUS_CFLAGS="$DBUS_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"dbus-1\""; } >&5
   ($PKG_CONFIG --exists --print-errors "dbus-1") 2>&5
   ac_status=$?
@@ -17403,15 +17474,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DBUS_LIBS"; then
-        pkg_cv_DBUS_LIBS="$DBUS_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DBUS_LIBS"; then
+    pkg_cv_DBUS_LIBS="$DBUS_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"dbus-1\""; } >&5
   ($PKG_CONFIG --exists --print-errors "dbus-1") 2>&5
   ac_status=$?
@@ -17421,9 +17490,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -17436,9 +17504,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        DBUS_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "dbus-1"`
+	        DBUS_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "dbus-1" 2>&1`
         else
-	        DBUS_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "dbus-1"`
+	        DBUS_PKG_ERRORS=`$PKG_CONFIG --print-errors "dbus-1" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$DBUS_PKG_ERRORS" >&5
@@ -17496,11 +17564,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for HAL" >&5
 $as_echo_n "checking for HAL... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$HAL_CFLAGS"; then
-        pkg_cv_HAL_CFLAGS="$HAL_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$HAL_CFLAGS"; then
+    pkg_cv_HAL_CFLAGS="$HAL_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"hal\""; } >&5
   ($PKG_CONFIG --exists --print-errors "hal") 2>&5
   ac_status=$?
@@ -17510,15 +17577,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$HAL_LIBS"; then
-        pkg_cv_HAL_LIBS="$HAL_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$HAL_LIBS"; then
+    pkg_cv_HAL_LIBS="$HAL_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"hal\""; } >&5
   ($PKG_CONFIG --exists --print-errors "hal") 2>&5
   ac_status=$?
@@ -17528,9 +17593,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -17543,9 +17607,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        HAL_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "hal"`
+	        HAL_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "hal" 2>&1`
         else
-	        HAL_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "hal"`
+	        HAL_PKG_ERRORS=`$PKG_CONFIG --print-errors "hal" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$HAL_PKG_ERRORS" >&5
@@ -17573,7 +17637,6 @@
 
 $as_echo "#define CONFIG_HAL 1" >>confdefs.h
 
-        REQUIRED_LIBS="$REQUIRED_LIBS hal"
 	CONFIG_NEED_DBUS="yes"
 fi
  if test "x$CONFIG_HAL" = xyes; then
@@ -17586,7 +17649,6 @@
 
 
 if test "x$CONFIG_NEED_DBUS" = xyes; then
-	REQUIRED_LIBS="$REQUIRED_LIBS dbus-1"
 
 $as_echo "#define CONFIG_NEED_DBUS 1" >>confdefs.h
 
@@ -17883,11 +17945,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XLIB" >&5
 $as_echo_n "checking for XLIB... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XLIB_CFLAGS"; then
-        pkg_cv_XLIB_CFLAGS="$XLIB_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XLIB_CFLAGS"; then
+    pkg_cv_XLIB_CFLAGS="$XLIB_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "x11") 2>&5
   ac_status=$?
@@ -17897,15 +17958,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XLIB_LIBS"; then
-        pkg_cv_XLIB_LIBS="$XLIB_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XLIB_LIBS"; then
+    pkg_cv_XLIB_LIBS="$XLIB_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "x11") 2>&5
   ac_status=$?
@@ -17915,9 +17974,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -17930,9 +17988,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XLIB_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "x11"`
+	        XLIB_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "x11" 2>&1`
         else
-	        XLIB_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "x11"`
+	        XLIB_PKG_ERRORS=`$PKG_CONFIG --print-errors "x11" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XLIB_PKG_ERRORS" >&5
@@ -17973,11 +18031,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GL" >&5
 $as_echo_n "checking for GL... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$GL_CFLAGS"; then
-        pkg_cv_GL_CFLAGS="$GL_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$GL_CFLAGS"; then
+    pkg_cv_GL_CFLAGS="$GL_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$GLPROTO \$LIBGL\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$GLPROTO $LIBGL") 2>&5
   ac_status=$?
@@ -17987,15 +18044,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$GL_LIBS"; then
-        pkg_cv_GL_LIBS="$GL_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$GL_LIBS"; then
+    pkg_cv_GL_LIBS="$GL_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$GLPROTO \$LIBGL\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$GLPROTO $LIBGL") 2>&5
   ac_status=$?
@@ -18005,9 +18060,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -18020,9 +18074,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        GL_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$GLPROTO $LIBGL"`
+	        GL_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$GLPROTO $LIBGL" 2>&1`
         else
-	        GL_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$GLPROTO $LIBGL"`
+	        GL_PKG_ERRORS=`$PKG_CONFIG --print-errors "$GLPROTO $LIBGL" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$GL_PKG_ERRORS" >&5
@@ -18115,11 +18169,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for DRIPROTO" >&5
 $as_echo_n "checking for DRIPROTO... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DRIPROTO_CFLAGS"; then
-        pkg_cv_DRIPROTO_CFLAGS="$DRIPROTO_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DRIPROTO_CFLAGS"; then
+    pkg_cv_DRIPROTO_CFLAGS="$DRIPROTO_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$DRIPROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$DRIPROTO") 2>&5
   ac_status=$?
@@ -18129,15 +18182,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DRIPROTO_LIBS"; then
-        pkg_cv_DRIPROTO_LIBS="$DRIPROTO_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DRIPROTO_LIBS"; then
+    pkg_cv_DRIPROTO_LIBS="$DRIPROTO_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$DRIPROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$DRIPROTO") 2>&5
   ac_status=$?
@@ -18147,9 +18198,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -18162,9 +18212,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        DRIPROTO_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$DRIPROTO"`
+	        DRIPROTO_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$DRIPROTO" 2>&1`
         else
-	        DRIPROTO_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$DRIPROTO"`
+	        DRIPROTO_PKG_ERRORS=`$PKG_CONFIG --print-errors "$DRIPROTO" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$DRIPROTO_PKG_ERRORS" >&5
@@ -18205,11 +18255,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for DRI" >&5
 $as_echo_n "checking for DRI... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DRI_CFLAGS"; then
-        pkg_cv_DRI_CFLAGS="$DRI_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DRI_CFLAGS"; then
+    pkg_cv_DRI_CFLAGS="$DRI_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$GLPROTO \$LIBDRI\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$GLPROTO $LIBDRI") 2>&5
   ac_status=$?
@@ -18219,15 +18268,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DRI_LIBS"; then
-        pkg_cv_DRI_LIBS="$DRI_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DRI_LIBS"; then
+    pkg_cv_DRI_LIBS="$DRI_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$GLPROTO \$LIBDRI\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$GLPROTO $LIBDRI") 2>&5
   ac_status=$?
@@ -18237,9 +18284,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -18252,9 +18298,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        DRI_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$GLPROTO $LIBDRI"`
+	        DRI_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$GLPROTO $LIBDRI" 2>&1`
         else
-	        DRI_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$GLPROTO $LIBDRI"`
+	        DRI_PKG_ERRORS=`$PKG_CONFIG --print-errors "$GLPROTO $LIBDRI" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$DRI_PKG_ERRORS" >&5
@@ -18298,11 +18344,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for DRI2PROTO" >&5
 $as_echo_n "checking for DRI2PROTO... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DRI2PROTO_CFLAGS"; then
-        pkg_cv_DRI2PROTO_CFLAGS="$DRI2PROTO_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DRI2PROTO_CFLAGS"; then
+    pkg_cv_DRI2PROTO_CFLAGS="$DRI2PROTO_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$DRI2PROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$DRI2PROTO") 2>&5
   ac_status=$?
@@ -18312,15 +18357,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DRI2PROTO_LIBS"; then
-        pkg_cv_DRI2PROTO_LIBS="$DRI2PROTO_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DRI2PROTO_LIBS"; then
+    pkg_cv_DRI2PROTO_LIBS="$DRI2PROTO_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$DRI2PROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$DRI2PROTO") 2>&5
   ac_status=$?
@@ -18330,9 +18373,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -18345,9 +18387,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        DRI2PROTO_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$DRI2PROTO"`
+	        DRI2PROTO_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$DRI2PROTO" 2>&1`
         else
-	        DRI2PROTO_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$DRI2PROTO"`
+	        DRI2PROTO_PKG_ERRORS=`$PKG_CONFIG --print-errors "$DRI2PROTO" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$DRI2PROTO_PKG_ERRORS" >&5
@@ -18390,11 +18432,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for LIBDRM" >&5
 $as_echo_n "checking for LIBDRM... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$LIBDRM_CFLAGS"; then
-        pkg_cv_LIBDRM_CFLAGS="$LIBDRM_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$LIBDRM_CFLAGS"; then
+    pkg_cv_LIBDRM_CFLAGS="$LIBDRM_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBDRM\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBDRM") 2>&5
   ac_status=$?
@@ -18404,15 +18445,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$LIBDRM_LIBS"; then
-        pkg_cv_LIBDRM_LIBS="$LIBDRM_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$LIBDRM_LIBS"; then
+    pkg_cv_LIBDRM_LIBS="$LIBDRM_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBDRM\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBDRM") 2>&5
   ac_status=$?
@@ -18422,9 +18461,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -18437,9 +18475,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        LIBDRM_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$LIBDRM"`
+	        LIBDRM_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$LIBDRM" 2>&1`
         else
-	        LIBDRM_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$LIBDRM"`
+	        LIBDRM_PKG_ERRORS=`$PKG_CONFIG --print-errors "$LIBDRM" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$LIBDRM_PKG_ERRORS" >&5
@@ -19022,11 +19060,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XDMCP" >&5
 $as_echo_n "checking for XDMCP... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XDMCP_CFLAGS"; then
-        pkg_cv_XDMCP_CFLAGS="$XDMCP_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XDMCP_CFLAGS"; then
+    pkg_cv_XDMCP_CFLAGS="$XDMCP_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"xdmcp\""; } >&5
   ($PKG_CONFIG --exists --print-errors "xdmcp") 2>&5
   ac_status=$?
@@ -19036,15 +19073,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XDMCP_LIBS"; then
-        pkg_cv_XDMCP_LIBS="$XDMCP_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XDMCP_LIBS"; then
+    pkg_cv_XDMCP_LIBS="$XDMCP_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"xdmcp\""; } >&5
   ($PKG_CONFIG --exists --print-errors "xdmcp") 2>&5
   ac_status=$?
@@ -19054,9 +19089,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -19069,9 +19103,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XDMCP_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "xdmcp"`
+	        XDMCP_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "xdmcp" 2>&1`
         else
-	        XDMCP_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "xdmcp"`
+	        XDMCP_PKG_ERRORS=`$PKG_CONFIG --print-errors "xdmcp" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XDMCP_PKG_ERRORS" >&5
@@ -19359,11 +19393,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GLIB" >&5
 $as_echo_n "checking for GLIB... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$GLIB_CFLAGS"; then
-        pkg_cv_GLIB_CFLAGS="$GLIB_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$GLIB_CFLAGS"; then
+    pkg_cv_GLIB_CFLAGS="$GLIB_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBGLIB\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBGLIB") 2>&5
   ac_status=$?
@@ -19373,15 +19406,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$GLIB_LIBS"; then
-        pkg_cv_GLIB_LIBS="$GLIB_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$GLIB_LIBS"; then
+    pkg_cv_GLIB_LIBS="$GLIB_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBGLIB\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBGLIB") 2>&5
   ac_status=$?
@@ -19391,9 +19422,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -19406,9 +19436,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        GLIB_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$LIBGLIB"`
+	        GLIB_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$LIBGLIB" 2>&1`
         else
-	        GLIB_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$LIBGLIB"`
+	        GLIB_PKG_ERRORS=`$PKG_CONFIG --print-errors "$LIBGLIB" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$GLIB_PKG_ERRORS" >&5
@@ -19766,11 +19796,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for OPENSSL" >&5
 $as_echo_n "checking for OPENSSL... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$OPENSSL_CFLAGS"; then
-        pkg_cv_OPENSSL_CFLAGS="$OPENSSL_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$OPENSSL_CFLAGS"; then
+    pkg_cv_OPENSSL_CFLAGS="$OPENSSL_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"openssl\""; } >&5
   ($PKG_CONFIG --exists --print-errors "openssl") 2>&5
   ac_status=$?
@@ -19780,15 +19809,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$OPENSSL_LIBS"; then
-        pkg_cv_OPENSSL_LIBS="$OPENSSL_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$OPENSSL_LIBS"; then
+    pkg_cv_OPENSSL_LIBS="$OPENSSL_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"openssl\""; } >&5
   ($PKG_CONFIG --exists --print-errors "openssl") 2>&5
   ac_status=$?
@@ -19798,9 +19825,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -19813,9 +19839,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        OPENSSL_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "openssl"`
+	        OPENSSL_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "openssl" 2>&1`
         else
-	        OPENSSL_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "openssl"`
+	        OPENSSL_PKG_ERRORS=`$PKG_CONFIG --print-errors "openssl" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$OPENSSL_PKG_ERRORS" >&5
@@ -19864,11 +19890,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XSERVERCFLAGS" >&5
 $as_echo_n "checking for XSERVERCFLAGS... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XSERVERCFLAGS_CFLAGS"; then
-        pkg_cv_XSERVERCFLAGS_CFLAGS="$XSERVERCFLAGS_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XSERVERCFLAGS_CFLAGS"; then
+    pkg_cv_XSERVERCFLAGS_CFLAGS="$XSERVERCFLAGS_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$REQUIRED_MODULES \$REQUIRED_LIBS\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$REQUIRED_MODULES $REQUIRED_LIBS") 2>&5
   ac_status=$?
@@ -19878,15 +19903,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XSERVERCFLAGS_LIBS"; then
-        pkg_cv_XSERVERCFLAGS_LIBS="$XSERVERCFLAGS_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XSERVERCFLAGS_LIBS"; then
+    pkg_cv_XSERVERCFLAGS_LIBS="$XSERVERCFLAGS_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$REQUIRED_MODULES \$REQUIRED_LIBS\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$REQUIRED_MODULES $REQUIRED_LIBS") 2>&5
   ac_status=$?
@@ -19896,9 +19919,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -19911,9 +19933,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XSERVERCFLAGS_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$REQUIRED_MODULES $REQUIRED_LIBS"`
+	        XSERVERCFLAGS_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$REQUIRED_MODULES $REQUIRED_LIBS" 2>&1`
         else
-	        XSERVERCFLAGS_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$REQUIRED_MODULES $REQUIRED_LIBS"`
+	        XSERVERCFLAGS_PKG_ERRORS=`$PKG_CONFIG --print-errors "$REQUIRED_MODULES $REQUIRED_LIBS" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XSERVERCFLAGS_PKG_ERRORS" >&5
@@ -19954,11 +19976,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XSERVERLIBS" >&5
 $as_echo_n "checking for XSERVERLIBS... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XSERVERLIBS_CFLAGS"; then
-        pkg_cv_XSERVERLIBS_CFLAGS="$XSERVERLIBS_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XSERVERLIBS_CFLAGS"; then
+    pkg_cv_XSERVERLIBS_CFLAGS="$XSERVERLIBS_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$REQUIRED_LIBS\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$REQUIRED_LIBS") 2>&5
   ac_status=$?
@@ -19968,15 +19989,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XSERVERLIBS_LIBS"; then
-        pkg_cv_XSERVERLIBS_LIBS="$XSERVERLIBS_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XSERVERLIBS_LIBS"; then
+    pkg_cv_XSERVERLIBS_LIBS="$XSERVERLIBS_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$REQUIRED_LIBS\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$REQUIRED_LIBS") 2>&5
   ac_status=$?
@@ -19986,9 +20005,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -20001,9 +20019,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XSERVERLIBS_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$REQUIRED_LIBS"`
+	        XSERVERLIBS_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$REQUIRED_LIBS" 2>&1`
         else
-	        XSERVERLIBS_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$REQUIRED_LIBS"`
+	        XSERVERLIBS_PKG_ERRORS=`$PKG_CONFIG --print-errors "$REQUIRED_LIBS" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XSERVERLIBS_PKG_ERRORS" >&5
@@ -20134,11 +20152,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XNESTMODULES" >&5
 $as_echo_n "checking for XNESTMODULES... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XNESTMODULES_CFLAGS"; then
-        pkg_cv_XNESTMODULES_CFLAGS="$XNESTMODULES_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XNESTMODULES_CFLAGS"; then
+    pkg_cv_XNESTMODULES_CFLAGS="$XNESTMODULES_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"xfont \$LIBXEXT x11 xau \$XDMCP_MODULES\""; } >&5
   ($PKG_CONFIG --exists --print-errors "xfont $LIBXEXT x11 xau $XDMCP_MODULES") 2>&5
   ac_status=$?
@@ -20148,15 +20165,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XNESTMODULES_LIBS"; then
-        pkg_cv_XNESTMODULES_LIBS="$XNESTMODULES_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XNESTMODULES_LIBS"; then
+    pkg_cv_XNESTMODULES_LIBS="$XNESTMODULES_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"xfont \$LIBXEXT x11 xau \$XDMCP_MODULES\""; } >&5
   ($PKG_CONFIG --exists --print-errors "xfont $LIBXEXT x11 xau $XDMCP_MODULES") 2>&5
   ac_status=$?
@@ -20166,9 +20181,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -20181,9 +20195,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XNESTMODULES_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "xfont $LIBXEXT x11 xau $XDMCP_MODULES"`
+	        XNESTMODULES_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "xfont $LIBXEXT x11 xau $XDMCP_MODULES" 2>&1`
         else
-	        XNESTMODULES_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "xfont $LIBXEXT x11 xau $XDMCP_MODULES"`
+	        XNESTMODULES_PKG_ERRORS=`$PKG_CONFIG --print-errors "xfont $LIBXEXT x11 xau $XDMCP_MODULES" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XNESTMODULES_PKG_ERRORS" >&5
@@ -20313,11 +20327,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for PCIACCESS" >&5
 $as_echo_n "checking for PCIACCESS... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$PCIACCESS_CFLAGS"; then
-        pkg_cv_PCIACCESS_CFLAGS="$PCIACCESS_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$PCIACCESS_CFLAGS"; then
+    pkg_cv_PCIACCESS_CFLAGS="$PCIACCESS_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBPCIACCESS\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBPCIACCESS") 2>&5
   ac_status=$?
@@ -20327,15 +20340,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$PCIACCESS_LIBS"; then
-        pkg_cv_PCIACCESS_LIBS="$PCIACCESS_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$PCIACCESS_LIBS"; then
+    pkg_cv_PCIACCESS_LIBS="$PCIACCESS_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBPCIACCESS\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBPCIACCESS") 2>&5
   ac_status=$?
@@ -20345,9 +20356,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -20360,9 +20370,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        PCIACCESS_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$LIBPCIACCESS"`
+	        PCIACCESS_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$LIBPCIACCESS" 2>&1`
         else
-	        PCIACCESS_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$LIBPCIACCESS"`
+	        PCIACCESS_PKG_ERRORS=`$PKG_CONFIG --print-errors "$LIBPCIACCESS" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$PCIACCESS_PKG_ERRORS" >&5
@@ -20630,11 +20640,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for DGA" >&5
 $as_echo_n "checking for DGA... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DGA_CFLAGS"; then
-        pkg_cv_DGA_CFLAGS="$DGA_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DGA_CFLAGS"; then
+    pkg_cv_DGA_CFLAGS="$DGA_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$DGAPROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$DGAPROTO") 2>&5
   ac_status=$?
@@ -20644,15 +20653,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DGA_LIBS"; then
-        pkg_cv_DGA_LIBS="$DGA_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DGA_LIBS"; then
+    pkg_cv_DGA_LIBS="$DGA_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$DGAPROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$DGAPROTO") 2>&5
   ac_status=$?
@@ -20662,9 +20669,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -20677,9 +20683,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        DGA_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$DGAPROTO"`
+	        DGA_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$DGAPROTO" 2>&1`
         else
-	        DGA_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$DGAPROTO"`
+	        DGA_PKG_ERRORS=`$PKG_CONFIG --print-errors "$DGAPROTO" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$DGA_PKG_ERRORS" >&5
@@ -20704,11 +20710,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for DGA" >&5
 $as_echo_n "checking for DGA... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DGA_CFLAGS"; then
-        pkg_cv_DGA_CFLAGS="$DGA_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DGA_CFLAGS"; then
+    pkg_cv_DGA_CFLAGS="$DGA_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$DGAPROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$DGAPROTO") 2>&5
   ac_status=$?
@@ -20718,15 +20723,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DGA_LIBS"; then
-        pkg_cv_DGA_LIBS="$DGA_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DGA_LIBS"; then
+    pkg_cv_DGA_LIBS="$DGA_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$DGAPROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$DGAPROTO") 2>&5
   ac_status=$?
@@ -20736,9 +20739,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -20751,9 +20753,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        DGA_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$DGAPROTO"`
+	        DGA_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$DGAPROTO" 2>&1`
         else
-	        DGA_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$DGAPROTO"`
+	        DGA_PKG_ERRORS=`$PKG_CONFIG --print-errors "$DGAPROTO" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$DGA_PKG_ERRORS" >&5
@@ -20803,11 +20805,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XF86VIDMODE" >&5
 $as_echo_n "checking for XF86VIDMODE... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XF86VIDMODE_CFLAGS"; then
-        pkg_cv_XF86VIDMODE_CFLAGS="$XF86VIDMODE_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XF86VIDMODE_CFLAGS"; then
+    pkg_cv_XF86VIDMODE_CFLAGS="$XF86VIDMODE_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$VIDMODEPROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$VIDMODEPROTO") 2>&5
   ac_status=$?
@@ -20817,15 +20818,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XF86VIDMODE_LIBS"; then
-        pkg_cv_XF86VIDMODE_LIBS="$XF86VIDMODE_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XF86VIDMODE_LIBS"; then
+    pkg_cv_XF86VIDMODE_LIBS="$XF86VIDMODE_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$VIDMODEPROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$VIDMODEPROTO") 2>&5
   ac_status=$?
@@ -20835,9 +20834,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -20850,9 +20848,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XF86VIDMODE_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$VIDMODEPROTO"`
+	        XF86VIDMODE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$VIDMODEPROTO" 2>&1`
         else
-	        XF86VIDMODE_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$VIDMODEPROTO"`
+	        XF86VIDMODE_PKG_ERRORS=`$PKG_CONFIG --print-errors "$VIDMODEPROTO" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XF86VIDMODE_PKG_ERRORS" >&5
@@ -20877,11 +20875,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XF86VIDMODE" >&5
 $as_echo_n "checking for XF86VIDMODE... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XF86VIDMODE_CFLAGS"; then
-        pkg_cv_XF86VIDMODE_CFLAGS="$XF86VIDMODE_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XF86VIDMODE_CFLAGS"; then
+    pkg_cv_XF86VIDMODE_CFLAGS="$XF86VIDMODE_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$VIDMODEPROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$VIDMODEPROTO") 2>&5
   ac_status=$?
@@ -20891,15 +20888,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XF86VIDMODE_LIBS"; then
-        pkg_cv_XF86VIDMODE_LIBS="$XF86VIDMODE_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XF86VIDMODE_LIBS"; then
+    pkg_cv_XF86VIDMODE_LIBS="$XF86VIDMODE_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$VIDMODEPROTO\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$VIDMODEPROTO") 2>&5
   ac_status=$?
@@ -20909,9 +20904,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -20924,9 +20918,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XF86VIDMODE_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$VIDMODEPROTO"`
+	        XF86VIDMODE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$VIDMODEPROTO" 2>&1`
         else
-	        XF86VIDMODE_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$VIDMODEPROTO"`
+	        XF86VIDMODE_PKG_ERRORS=`$PKG_CONFIG --print-errors "$VIDMODEPROTO" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XF86VIDMODE_PKG_ERRORS" >&5
@@ -20973,11 +20967,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XORG_MODULES" >&5
 $as_echo_n "checking for XORG_MODULES... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XORG_MODULES_CFLAGS"; then
-        pkg_cv_XORG_MODULES_CFLAGS="$XORG_MODULES_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XORG_MODULES_CFLAGS"; then
+    pkg_cv_XORG_MODULES_CFLAGS="$XORG_MODULES_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$XORG_MODULES\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$XORG_MODULES") 2>&5
   ac_status=$?
@@ -20987,15 +20980,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XORG_MODULES_LIBS"; then
-        pkg_cv_XORG_MODULES_LIBS="$XORG_MODULES_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XORG_MODULES_LIBS"; then
+    pkg_cv_XORG_MODULES_LIBS="$XORG_MODULES_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$XORG_MODULES\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$XORG_MODULES") 2>&5
   ac_status=$?
@@ -21005,9 +20996,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -21020,9 +21010,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XORG_MODULES_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$XORG_MODULES"`
+	        XORG_MODULES_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$XORG_MODULES" 2>&1`
         else
-	        XORG_MODULES_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$XORG_MODULES"`
+	        XORG_MODULES_PKG_ERRORS=`$PKG_CONFIG --print-errors "$XORG_MODULES" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XORG_MODULES_PKG_ERRORS" >&5
@@ -21484,11 +21474,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XWINMODULES" >&5
 $as_echo_n "checking for XWINMODULES... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XWINMODULES_CFLAGS"; then
-        pkg_cv_XWINMODULES_CFLAGS="$XWINMODULES_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XWINMODULES_CFLAGS"; then
+    pkg_cv_XWINMODULES_CFLAGS="$XWINMODULES_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"x11 xdmcp xau xfont\""; } >&5
   ($PKG_CONFIG --exists --print-errors "x11 xdmcp xau xfont") 2>&5
   ac_status=$?
@@ -21498,15 +21487,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XWINMODULES_LIBS"; then
-        pkg_cv_XWINMODULES_LIBS="$XWINMODULES_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XWINMODULES_LIBS"; then
+    pkg_cv_XWINMODULES_LIBS="$XWINMODULES_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"x11 xdmcp xau xfont\""; } >&5
   ($PKG_CONFIG --exists --print-errors "x11 xdmcp xau xfont") 2>&5
   ac_status=$?
@@ -21516,9 +21503,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -21531,9 +21517,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XWINMODULES_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "x11 xdmcp xau xfont"`
+	        XWINMODULES_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "x11 xdmcp xau xfont" 2>&1`
         else
-	        XWINMODULES_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "x11 xdmcp xau xfont"`
+	        XWINMODULES_PKG_ERRORS=`$PKG_CONFIG --print-errors "x11 xdmcp xau xfont" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XWINMODULES_PKG_ERRORS" >&5
@@ -21589,11 +21575,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XWINMODULES" >&5
 $as_echo_n "checking for XWINMODULES... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XWINMODULES_CFLAGS"; then
-        pkg_cv_XWINMODULES_CFLAGS="$XWINMODULES_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XWINMODULES_CFLAGS"; then
+    pkg_cv_XWINMODULES_CFLAGS="$XWINMODULES_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"x11 xdmcp xau xfont\""; } >&5
   ($PKG_CONFIG --exists --print-errors "x11 xdmcp xau xfont") 2>&5
   ac_status=$?
@@ -21603,15 +21588,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XWINMODULES_LIBS"; then
-        pkg_cv_XWINMODULES_LIBS="$XWINMODULES_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XWINMODULES_LIBS"; then
+    pkg_cv_XWINMODULES_LIBS="$XWINMODULES_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"x11 xdmcp xau xfont\""; } >&5
   ($PKG_CONFIG --exists --print-errors "x11 xdmcp xau xfont") 2>&5
   ac_status=$?
@@ -21621,9 +21604,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -21636,9 +21618,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XWINMODULES_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "x11 xdmcp xau xfont"`
+	        XWINMODULES_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "x11 xdmcp xau xfont" 2>&1`
         else
-	        XWINMODULES_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "x11 xdmcp xau xfont"`
+	        XWINMODULES_PKG_ERRORS=`$PKG_CONFIG --print-errors "x11 xdmcp xau xfont" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XWINMODULES_PKG_ERRORS" >&5
@@ -21845,11 +21827,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XPBPROXY" >&5
 $as_echo_n "checking for XPBPROXY... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XPBPROXY_CFLAGS"; then
-        pkg_cv_XPBPROXY_CFLAGS="$XPBPROXY_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XPBPROXY_CFLAGS"; then
+    pkg_cv_XPBPROXY_CFLAGS="$XPBPROXY_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$APPLEWMPROTO \$LIBAPPLEWM xfixes x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$APPLEWMPROTO $LIBAPPLEWM xfixes x11") 2>&5
   ac_status=$?
@@ -21859,15 +21840,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XPBPROXY_LIBS"; then
-        pkg_cv_XPBPROXY_LIBS="$XPBPROXY_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XPBPROXY_LIBS"; then
+    pkg_cv_XPBPROXY_LIBS="$XPBPROXY_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$APPLEWMPROTO \$LIBAPPLEWM xfixes x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$APPLEWMPROTO $LIBAPPLEWM xfixes x11") 2>&5
   ac_status=$?
@@ -21877,9 +21856,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -21892,9 +21870,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XPBPROXY_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$APPLEWMPROTO $LIBAPPLEWM xfixes x11"`
+	        XPBPROXY_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$APPLEWMPROTO $LIBAPPLEWM xfixes x11" 2>&1`
         else
-	        XPBPROXY_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$APPLEWMPROTO $LIBAPPLEWM xfixes x11"`
+	        XPBPROXY_PKG_ERRORS=`$PKG_CONFIG --print-errors "$APPLEWMPROTO $LIBAPPLEWM xfixes x11" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XPBPROXY_PKG_ERRORS" >&5
@@ -22110,11 +22088,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for DMXMODULES" >&5
 $as_echo_n "checking for DMXMODULES... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DMXMODULES_CFLAGS"; then
-        pkg_cv_DMXMODULES_CFLAGS="$DMXMODULES_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DMXMODULES_CFLAGS"; then
+    pkg_cv_DMXMODULES_CFLAGS="$DMXMODULES_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"xmuu \$LIBXEXT x11 xrender xfixes xfont \$LIBXI \$DMXPROTO xau \$XDMCP_MODULES\""; } >&5
   ($PKG_CONFIG --exists --print-errors "xmuu $LIBXEXT x11 xrender xfixes xfont $LIBXI $DMXPROTO xau $XDMCP_MODULES") 2>&5
   ac_status=$?
@@ -22124,15 +22101,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DMXMODULES_LIBS"; then
-        pkg_cv_DMXMODULES_LIBS="$DMXMODULES_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DMXMODULES_LIBS"; then
+    pkg_cv_DMXMODULES_LIBS="$DMXMODULES_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"xmuu \$LIBXEXT x11 xrender xfixes xfont \$LIBXI \$DMXPROTO xau \$XDMCP_MODULES\""; } >&5
   ($PKG_CONFIG --exists --print-errors "xmuu $LIBXEXT x11 xrender xfixes xfont $LIBXI $DMXPROTO xau $XDMCP_MODULES") 2>&5
   ac_status=$?
@@ -22142,9 +22117,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -22157,9 +22131,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        DMXMODULES_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "xmuu $LIBXEXT x11 xrender xfixes xfont $LIBXI $DMXPROTO xau $XDMCP_MODULES"`
+	        DMXMODULES_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "xmuu $LIBXEXT x11 xrender xfixes xfont $LIBXI $DMXPROTO xau $XDMCP_MODULES" 2>&1`
         else
-	        DMXMODULES_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "xmuu $LIBXEXT x11 xrender xfixes xfont $LIBXI $DMXPROTO xau $XDMCP_MODULES"`
+	        DMXMODULES_PKG_ERRORS=`$PKG_CONFIG --print-errors "xmuu $LIBXEXT x11 xrender xfixes xfont $LIBXI $DMXPROTO xau $XDMCP_MODULES" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$DMXMODULES_PKG_ERRORS" >&5
@@ -22179,11 +22153,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XDMXCONFIG_DEP" >&5
 $as_echo_n "checking for XDMXCONFIG_DEP... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XDMXCONFIG_DEP_CFLAGS"; then
-        pkg_cv_XDMXCONFIG_DEP_CFLAGS="$XDMXCONFIG_DEP_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XDMXCONFIG_DEP_CFLAGS"; then
+    pkg_cv_XDMXCONFIG_DEP_CFLAGS="$XDMXCONFIG_DEP_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"xaw7 xmu xt xpm x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "xaw7 xmu xt xpm x11") 2>&5
   ac_status=$?
@@ -22193,15 +22166,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XDMXCONFIG_DEP_LIBS"; then
-        pkg_cv_XDMXCONFIG_DEP_LIBS="$XDMXCONFIG_DEP_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XDMXCONFIG_DEP_LIBS"; then
+    pkg_cv_XDMXCONFIG_DEP_LIBS="$XDMXCONFIG_DEP_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"xaw7 xmu xt xpm x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "xaw7 xmu xt xpm x11") 2>&5
   ac_status=$?
@@ -22211,9 +22182,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -22226,9 +22196,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XDMXCONFIG_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "xaw7 xmu xt xpm x11"`
+	        XDMXCONFIG_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "xaw7 xmu xt xpm x11" 2>&1`
         else
-	        XDMXCONFIG_DEP_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "xaw7 xmu xt xpm x11"`
+	        XDMXCONFIG_DEP_PKG_ERRORS=`$PKG_CONFIG --print-errors "xaw7 xmu xt xpm x11" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XDMXCONFIG_DEP_PKG_ERRORS" >&5
@@ -22304,11 +22274,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for DMXEXAMPLES_DEP" >&5
 $as_echo_n "checking for DMXEXAMPLES_DEP... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DMXEXAMPLES_DEP_CFLAGS"; then
-        pkg_cv_DMXEXAMPLES_DEP_CFLAGS="$DMXEXAMPLES_DEP_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DMXEXAMPLES_DEP_CFLAGS"; then
+    pkg_cv_DMXEXAMPLES_DEP_CFLAGS="$DMXEXAMPLES_DEP_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBDMX \$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBDMX $LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22318,15 +22287,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DMXEXAMPLES_DEP_LIBS"; then
-        pkg_cv_DMXEXAMPLES_DEP_LIBS="$DMXEXAMPLES_DEP_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DMXEXAMPLES_DEP_LIBS"; then
+    pkg_cv_DMXEXAMPLES_DEP_LIBS="$DMXEXAMPLES_DEP_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBDMX \$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBDMX $LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22336,9 +22303,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -22351,9 +22317,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        DMXEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$LIBDMX $LIBXEXT x11"`
+	        DMXEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$LIBDMX $LIBXEXT x11" 2>&1`
         else
-	        DMXEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$LIBDMX $LIBXEXT x11"`
+	        DMXEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --print-errors "$LIBDMX $LIBXEXT x11" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$DMXEXAMPLES_DEP_PKG_ERRORS" >&5
@@ -22395,11 +22361,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for DMXXMUEXAMPLES_DEP" >&5
 $as_echo_n "checking for DMXXMUEXAMPLES_DEP... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DMXXMUEXAMPLES_DEP_CFLAGS"; then
-        pkg_cv_DMXXMUEXAMPLES_DEP_CFLAGS="$DMXXMUEXAMPLES_DEP_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DMXXMUEXAMPLES_DEP_CFLAGS"; then
+    pkg_cv_DMXXMUEXAMPLES_DEP_CFLAGS="$DMXXMUEXAMPLES_DEP_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBDMX xmu \$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBDMX xmu $LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22409,15 +22374,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DMXXMUEXAMPLES_DEP_LIBS"; then
-        pkg_cv_DMXXMUEXAMPLES_DEP_LIBS="$DMXXMUEXAMPLES_DEP_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DMXXMUEXAMPLES_DEP_LIBS"; then
+    pkg_cv_DMXXMUEXAMPLES_DEP_LIBS="$DMXXMUEXAMPLES_DEP_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBDMX xmu \$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBDMX xmu $LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22427,9 +22390,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -22442,9 +22404,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        DMXXMUEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$LIBDMX xmu $LIBXEXT x11"`
+	        DMXXMUEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$LIBDMX xmu $LIBXEXT x11" 2>&1`
         else
-	        DMXXMUEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$LIBDMX xmu $LIBXEXT x11"`
+	        DMXXMUEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --print-errors "$LIBDMX xmu $LIBXEXT x11" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$DMXXMUEXAMPLES_DEP_PKG_ERRORS" >&5
@@ -22486,11 +22448,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for DMXXIEXAMPLES_DEP" >&5
 $as_echo_n "checking for DMXXIEXAMPLES_DEP... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DMXXIEXAMPLES_DEP_CFLAGS"; then
-        pkg_cv_DMXXIEXAMPLES_DEP_CFLAGS="$DMXXIEXAMPLES_DEP_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DMXXIEXAMPLES_DEP_CFLAGS"; then
+    pkg_cv_DMXXIEXAMPLES_DEP_CFLAGS="$DMXXIEXAMPLES_DEP_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBDMX \$LIBXI \$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBDMX $LIBXI $LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22500,15 +22461,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$DMXXIEXAMPLES_DEP_LIBS"; then
-        pkg_cv_DMXXIEXAMPLES_DEP_LIBS="$DMXXIEXAMPLES_DEP_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$DMXXIEXAMPLES_DEP_LIBS"; then
+    pkg_cv_DMXXIEXAMPLES_DEP_LIBS="$DMXXIEXAMPLES_DEP_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBDMX \$LIBXI \$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBDMX $LIBXI $LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22518,9 +22477,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -22533,9 +22491,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        DMXXIEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$LIBDMX $LIBXI $LIBXEXT x11"`
+	        DMXXIEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$LIBDMX $LIBXI $LIBXEXT x11" 2>&1`
         else
-	        DMXXIEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$LIBDMX $LIBXI $LIBXEXT x11"`
+	        DMXXIEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --print-errors "$LIBDMX $LIBXI $LIBXEXT x11" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$DMXXIEXAMPLES_DEP_PKG_ERRORS" >&5
@@ -22577,11 +22535,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XTSTEXAMPLES_DEP" >&5
 $as_echo_n "checking for XTSTEXAMPLES_DEP... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XTSTEXAMPLES_DEP_CFLAGS"; then
-        pkg_cv_XTSTEXAMPLES_DEP_CFLAGS="$XTSTEXAMPLES_DEP_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XTSTEXAMPLES_DEP_CFLAGS"; then
+    pkg_cv_XTSTEXAMPLES_DEP_CFLAGS="$XTSTEXAMPLES_DEP_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBXTST \$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBXTST $LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22591,15 +22548,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XTSTEXAMPLES_DEP_LIBS"; then
-        pkg_cv_XTSTEXAMPLES_DEP_LIBS="$XTSTEXAMPLES_DEP_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XTSTEXAMPLES_DEP_LIBS"; then
+    pkg_cv_XTSTEXAMPLES_DEP_LIBS="$XTSTEXAMPLES_DEP_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBXTST \$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBXTST $LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22609,9 +22564,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -22624,9 +22578,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XTSTEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$LIBXTST $LIBXEXT x11"`
+	        XTSTEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$LIBXTST $LIBXEXT x11" 2>&1`
         else
-	        XTSTEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$LIBXTST $LIBXEXT x11"`
+	        XTSTEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --print-errors "$LIBXTST $LIBXEXT x11" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XTSTEXAMPLES_DEP_PKG_ERRORS" >&5
@@ -22668,11 +22622,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XRESEXAMPLES_DEP" >&5
 $as_echo_n "checking for XRESEXAMPLES_DEP... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XRESEXAMPLES_DEP_CFLAGS"; then
-        pkg_cv_XRESEXAMPLES_DEP_CFLAGS="$XRESEXAMPLES_DEP_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XRESEXAMPLES_DEP_CFLAGS"; then
+    pkg_cv_XRESEXAMPLES_DEP_CFLAGS="$XRESEXAMPLES_DEP_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"xres \$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "xres $LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22682,15 +22635,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XRESEXAMPLES_DEP_LIBS"; then
-        pkg_cv_XRESEXAMPLES_DEP_LIBS="$XRESEXAMPLES_DEP_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XRESEXAMPLES_DEP_LIBS"; then
+    pkg_cv_XRESEXAMPLES_DEP_LIBS="$XRESEXAMPLES_DEP_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"xres \$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "xres $LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22700,9 +22651,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -22715,9 +22665,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XRESEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "xres $LIBXEXT x11"`
+	        XRESEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "xres $LIBXEXT x11" 2>&1`
         else
-	        XRESEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "xres $LIBXEXT x11"`
+	        XRESEXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --print-errors "xres $LIBXEXT x11" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XRESEXAMPLES_DEP_PKG_ERRORS" >&5
@@ -22759,11 +22709,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for X11EXAMPLES_DEP" >&5
 $as_echo_n "checking for X11EXAMPLES_DEP... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$X11EXAMPLES_DEP_CFLAGS"; then
-        pkg_cv_X11EXAMPLES_DEP_CFLAGS="$X11EXAMPLES_DEP_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$X11EXAMPLES_DEP_CFLAGS"; then
+    pkg_cv_X11EXAMPLES_DEP_CFLAGS="$X11EXAMPLES_DEP_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22773,15 +22722,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$X11EXAMPLES_DEP_LIBS"; then
-        pkg_cv_X11EXAMPLES_DEP_LIBS="$X11EXAMPLES_DEP_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$X11EXAMPLES_DEP_LIBS"; then
+    pkg_cv_X11EXAMPLES_DEP_LIBS="$X11EXAMPLES_DEP_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$LIBXEXT x11\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$LIBXEXT x11") 2>&5
   ac_status=$?
@@ -22791,9 +22738,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -22806,9 +22752,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        X11EXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$LIBXEXT x11"`
+	        X11EXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$LIBXEXT x11" 2>&1`
         else
-	        X11EXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$LIBXEXT x11"`
+	        X11EXAMPLES_DEP_PKG_ERRORS=`$PKG_CONFIG --print-errors "$LIBXEXT x11" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$X11EXAMPLES_DEP_PKG_ERRORS" >&5
@@ -22967,11 +22913,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for TSLIB" >&5
 $as_echo_n "checking for TSLIB... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$TSLIB_CFLAGS"; then
-        pkg_cv_TSLIB_CFLAGS="$TSLIB_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$TSLIB_CFLAGS"; then
+    pkg_cv_TSLIB_CFLAGS="$TSLIB_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"tslib-0.0\""; } >&5
   ($PKG_CONFIG --exists --print-errors "tslib-0.0") 2>&5
   ac_status=$?
@@ -22981,15 +22926,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$TSLIB_LIBS"; then
-        pkg_cv_TSLIB_LIBS="$TSLIB_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$TSLIB_LIBS"; then
+    pkg_cv_TSLIB_LIBS="$TSLIB_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"tslib-0.0\""; } >&5
   ($PKG_CONFIG --exists --print-errors "tslib-0.0") 2>&5
   ac_status=$?
@@ -22999,9 +22942,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -23014,9 +22956,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        TSLIB_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "tslib-0.0"`
+	        TSLIB_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "tslib-0.0" 2>&1`
         else
-	        TSLIB_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "tslib-0.0"`
+	        TSLIB_PKG_ERRORS=`$PKG_CONFIG --print-errors "tslib-0.0" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$TSLIB_PKG_ERRORS" >&5
@@ -23103,11 +23045,10 @@
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for XEPHYR" >&5
 $as_echo_n "checking for XEPHYR... " >&6; }
 
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XEPHYR_CFLAGS"; then
-        pkg_cv_XEPHYR_CFLAGS="$XEPHYR_CFLAGS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XEPHYR_CFLAGS"; then
+    pkg_cv_XEPHYR_CFLAGS="$XEPHYR_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$XEPHYR_REQUIRED_LIBS\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$XEPHYR_REQUIRED_LIBS") 2>&5
   ac_status=$?
@@ -23117,15 +23058,13 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
-if test -n "$PKG_CONFIG"; then
-    if test -n "$XEPHYR_LIBS"; then
-        pkg_cv_XEPHYR_LIBS="$XEPHYR_LIBS"
-    else
-        if test -n "$PKG_CONFIG" && \
+if test -n "$XEPHYR_LIBS"; then
+    pkg_cv_XEPHYR_LIBS="$XEPHYR_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
     { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"\$XEPHYR_REQUIRED_LIBS\""; } >&5
   ($PKG_CONFIG --exists --print-errors "$XEPHYR_REQUIRED_LIBS") 2>&5
   ac_status=$?
@@ -23135,9 +23074,8 @@
 else
   pkg_failed=yes
 fi
-    fi
-else
-	pkg_failed=untried
+ else
+    pkg_failed=untried
 fi
 
 
@@ -23150,9 +23088,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        XEPHYR_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$XEPHYR_REQUIRED_LIBS"`
+	        XEPHYR_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$XEPHYR_REQUIRED_LIBS" 2>&1`
         else
-	        XEPHYR_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$XEPHYR_REQUIRED_LIBS"`
+	        XEPHYR_PKG_ERRORS=`$PKG_CONFIG --print-errors "$XEPHYR_REQUIRED_LIBS" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$XEPHYR_PKG_ERRORS" >&5
@@ -23580,6 +23518,10 @@
   as_fn_error "conditional \"INSTALL_LIBXF86CONFIG\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
+if test -z "${CONFIG_UDEV_TRUE}" && test -z "${CONFIG_UDEV_FALSE}"; then
+  as_fn_error "conditional \"CONFIG_UDEV\" was never defined.
+Usually this means the macro was only invoked conditionally." "$LINENO" 5
+fi
 if test -z "${HAVE_DBUS_TRUE}" && test -z "${HAVE_DBUS_FALSE}"; then
   as_fn_error "conditional \"HAVE_DBUS\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
diff -Naur xorg-server-1.7.99.2/configure.ac xorg-server-1.7.99.2.patch/configure.ac
--- xorg-server-1.7.99.2/configure.ac	2009-12-19 07:56:18.000000000 +0100
+++ xorg-server-1.7.99.2.patch/configure.ac	2009-12-20 14:00:53.104988856 +0100
@@ -618,6 +618,7 @@
 AC_ARG_ENABLE(dbe,            AS_HELP_STRING([--disable-dbe], [Build DBE extension (default: enabled)]), [DBE=$enableval], [DBE=yes])
 AC_ARG_ENABLE(xf86bigfont,    AS_HELP_STRING([--disable-xf86bigfont], [Build XF86 Big Font extension (default: disabled)]), [XF86BIGFONT=$enableval], [XF86BIGFONT=no])
 AC_ARG_ENABLE(dpms,           AS_HELP_STRING([--disable-dpms], [Build DPMS extension (default: enabled)]), [DPMSExtension=$enableval], [DPMSExtension=yes])
+AC_ARG_ENABLE(config-udev,    AS_HELP_STRING([--enable-config-udev], [Build udev support (default: auto)]), [CONFIG_UDEV=$enableval], [CONFIG_UDEV=auto])
 AC_ARG_ENABLE(config-dbus,    AS_HELP_STRING([--enable-config-dbus], [Build D-BUS API support (default: no)]), [CONFIG_DBUS_API=$enableval], [CONFIG_DBUS_API=no])
 AC_ARG_ENABLE(config-hal,     AS_HELP_STRING([--disable-config-hal], [Build HAL support (default: auto)]), [CONFIG_HAL=$enableval], [CONFIG_HAL=auto])
 AC_ARG_ENABLE(xfree86-utils,     AS_HELP_STRING([--enable-xfree86-utils], [Build xfree86 DDX utilities (default: enabled)]), [XF86UTILS=$enableval], [XF86UTILS=yes])
@@ -775,6 +776,26 @@
 LIBXTST="xtst >= 1.0.99.2"
 LIBPCIACCESS="pciaccess >= 0.8.0"
 LIBGLIB="glib-2.0 >= 2.16"
+LIBUDEV="libudev >= 143"
+
+if test "x$CONFIG_UDEV" = xyes &&
+ { test "x$CONFIG_DBUS_API" = xyes || test "x$CONFIG_HAL" = xyes; }; then
+	AC_MSG_ERROR([Hotplugging through both libudev and dbus/hal not allowed])
+fi
+
+PKG_CHECK_MODULES(UDEV, $LIBUDEV, [HAVE_LIBUDEV=yes], [HAVE_LIBUDEV=no])
+if test "x$CONFIG_UDEV" = xauto; then
+	CONFIG_UDEV="$HAVE_LIBUDEV"
+fi
+AM_CONDITIONAL(CONFIG_UDEV, [test "x$CONFIG_UDEV" = xyes])
+if test "x$CONFIG_UDEV" = xyes; then
+	CONFIG_DBUS_API=no
+	CONFIG_HAL=no
+	if ! test "x$HAVE_LIBUDEV" = xyes; then
+		AC_MSG_ERROR([udev configuration API requested, but libudev is not installed])
+	fi
+	AC_DEFINE(CONFIG_UDEV, 1, [Use libudev for input hotplug])
+fi
 
 dnl HAVE_DBUS is true if we actually have the D-Bus library, whereas
 dnl CONFIG_DBUS_API is true if we want to enable the D-Bus config
@@ -808,13 +829,11 @@
 	fi
 
 	AC_DEFINE(CONFIG_HAL, 1, [Use the HAL hotplug API])
-        REQUIRED_LIBS="$REQUIRED_LIBS hal"
 	CONFIG_NEED_DBUS="yes"
 fi
 AM_CONDITIONAL(CONFIG_HAL, [test "x$CONFIG_HAL" = xyes])
 
 if test "x$CONFIG_NEED_DBUS" = xyes; then
-	REQUIRED_LIBS="$REQUIRED_LIBS dbus-1"
         AC_DEFINE(CONFIG_NEED_DBUS, 1, [Use D-Bus for input hotplug])
 fi
 AM_CONDITIONAL(CONFIG_NEED_DBUS, [test "x$CONFIG_NEED_DBUS" = xyes])
diff -Naur xorg-server-1.7.99.2/damageext/Makefile.in xorg-server-1.7.99.2.patch/damageext/Makefile.in
--- xorg-server-1.7.99.2/damageext/Makefile.in	2009-12-19 08:06:06.000000000 +0100
+++ xorg-server-1.7.99.2.patch/damageext/Makefile.in	2009-12-20 14:08:16.543987148 +0100
@@ -265,6 +265,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/dbe/Makefile.in xorg-server-1.7.99.2.patch/dbe/Makefile.in
--- xorg-server-1.7.99.2/dbe/Makefile.in	2009-12-19 08:06:06.000000000 +0100
+++ xorg-server-1.7.99.2.patch/dbe/Makefile.in	2009-12-20 14:08:16.720986824 +0100
@@ -291,6 +291,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/dix/Makefile.in xorg-server-1.7.99.2.patch/dix/Makefile.in
--- xorg-server-1.7.99.2/dix/Makefile.in	2009-12-19 08:06:06.000000000 +0100
+++ xorg-server-1.7.99.2.patch/dix/Makefile.in	2009-12-20 14:08:16.919986680 +0100
@@ -305,6 +305,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/doc/Makefile.in xorg-server-1.7.99.2.patch/doc/Makefile.in
--- xorg-server-1.7.99.2/doc/Makefile.in	2009-12-19 08:06:06.000000000 +0100
+++ xorg-server-1.7.99.2.patch/doc/Makefile.in	2009-12-20 14:08:17.082987829 +0100
@@ -268,6 +268,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/exa/Makefile.in xorg-server-1.7.99.2.patch/exa/Makefile.in
--- xorg-server-1.7.99.2/exa/Makefile.in	2009-12-19 08:06:06.000000000 +0100
+++ xorg-server-1.7.99.2.patch/exa/Makefile.in	2009-12-20 14:08:17.264986566 +0100
@@ -296,6 +296,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/fb/Makefile.in xorg-server-1.7.99.2.patch/fb/Makefile.in
--- xorg-server-1.7.99.2/fb/Makefile.in	2009-12-19 08:06:06.000000000 +0100
+++ xorg-server-1.7.99.2.patch/fb/Makefile.in	2009-12-20 14:08:17.859986666 +0100
@@ -321,6 +321,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/glx/Makefile.in xorg-server-1.7.99.2.patch/glx/Makefile.in
--- xorg-server-1.7.99.2/glx/Makefile.in	2009-12-19 08:06:07.000000000 +0100
+++ xorg-server-1.7.99.2.patch/glx/Makefile.in	2009-12-20 14:08:18.072986656 +0100
@@ -285,6 +285,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/dmx/config/Makefile.in xorg-server-1.7.99.2.patch/hw/dmx/config/Makefile.in
--- xorg-server-1.7.99.2/hw/dmx/config/Makefile.in	2009-12-19 08:06:07.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/dmx/config/Makefile.in	2009-12-20 14:08:18.685986596 +0100
@@ -327,6 +327,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/dmx/doc/Makefile.in xorg-server-1.7.99.2.patch/hw/dmx/doc/Makefile.in
--- xorg-server-1.7.99.2/hw/dmx/doc/Makefile.in	2009-12-19 08:06:07.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/dmx/doc/Makefile.in	2009-12-20 14:08:18.842986610 +0100
@@ -262,6 +262,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/dmx/examples/Makefile.in xorg-server-1.7.99.2.patch/hw/dmx/examples/Makefile.in
--- xorg-server-1.7.99.2/hw/dmx/examples/Makefile.in	2009-12-19 08:06:07.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/dmx/examples/Makefile.in	2009-12-20 14:08:19.192891479 +0100
@@ -369,6 +369,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/dmx/glxProxy/Makefile.in xorg-server-1.7.99.2.patch/hw/dmx/glxProxy/Makefile.in
--- xorg-server-1.7.99.2/hw/dmx/glxProxy/Makefile.in	2009-12-19 08:06:08.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/dmx/glxProxy/Makefile.in	2009-12-20 14:08:19.371986866 +0100
@@ -276,6 +276,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/dmx/input/Makefile.in xorg-server-1.7.99.2.patch/hw/dmx/input/Makefile.in
--- xorg-server-1.7.99.2/hw/dmx/input/Makefile.in	2009-12-19 08:06:08.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/dmx/input/Makefile.in	2009-12-20 14:08:19.665986253 +0100
@@ -290,6 +290,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/dmx/Makefile.in xorg-server-1.7.99.2.patch/hw/dmx/Makefile.in
--- xorg-server-1.7.99.2/hw/dmx/Makefile.in	2009-12-19 08:06:07.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/dmx/Makefile.in	2009-12-20 14:08:18.455986394 +0100
@@ -354,6 +354,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/kdrive/ephyr/Makefile.in xorg-server-1.7.99.2.patch/hw/kdrive/ephyr/Makefile.in
--- xorg-server-1.7.99.2/hw/kdrive/ephyr/Makefile.in	2009-12-19 08:06:08.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/kdrive/ephyr/Makefile.in	2009-12-20 14:08:20.035986605 +0100
@@ -328,6 +328,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/kdrive/fake/Makefile.in xorg-server-1.7.99.2.patch/hw/kdrive/fake/Makefile.in
--- xorg-server-1.7.99.2/hw/kdrive/fake/Makefile.in	2009-12-19 08:06:08.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/kdrive/fake/Makefile.in	2009-12-20 14:08:20.208986711 +0100
@@ -274,6 +274,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/kdrive/fbdev/Makefile.in xorg-server-1.7.99.2.patch/hw/kdrive/fbdev/Makefile.in
--- xorg-server-1.7.99.2/hw/kdrive/fbdev/Makefile.in	2009-12-19 08:06:08.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/kdrive/fbdev/Makefile.in	2009-12-20 14:08:20.378986528 +0100
@@ -275,6 +275,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/kdrive/linux/Makefile.in xorg-server-1.7.99.2.patch/hw/kdrive/linux/Makefile.in
--- xorg-server-1.7.99.2/hw/kdrive/linux/Makefile.in	2009-12-19 08:06:08.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/kdrive/linux/Makefile.in	2009-12-20 14:08:20.545986965 +0100
@@ -270,6 +270,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/kdrive/Makefile.in xorg-server-1.7.99.2.patch/hw/kdrive/Makefile.in
--- xorg-server-1.7.99.2/hw/kdrive/Makefile.in	2009-12-19 08:06:08.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/kdrive/Makefile.in	2009-12-20 14:08:19.824986853 +0100
@@ -278,6 +278,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/kdrive/src/kinput.c xorg-server-1.7.99.2.patch/hw/kdrive/src/kinput.c
--- xorg-server-1.7.99.2/hw/kdrive/src/kinput.c	2009-11-04 17:25:50.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/kdrive/src/kinput.c	2009-12-20 14:00:53.107988726 +0100
@@ -2280,6 +2280,14 @@
             return BadValue;
         }
 #endif
+#ifdef CONFIG_UDEV
+        else if (strcmp(option->key, "_source") == 0 &&
+                 strcmp(option->value, "server/udev") == 0)
+        {
+            ErrorF("Ignoring device from udev.\n");
+            return BadValue;
+        }
+#endif
     }
 
     if (!ki && !pi) {
diff -Naur xorg-server-1.7.99.2/hw/kdrive/src/Makefile.in xorg-server-1.7.99.2.patch/hw/kdrive/src/Makefile.in
--- xorg-server-1.7.99.2/hw/kdrive/src/Makefile.in	2009-12-19 08:06:08.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/kdrive/src/Makefile.in	2009-12-20 14:08:20.729986707 +0100
@@ -275,6 +275,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/Makefile.in xorg-server-1.7.99.2.patch/hw/Makefile.in
--- xorg-server-1.7.99.2/hw/Makefile.in	2009-12-19 08:06:07.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/Makefile.in	2009-12-20 14:08:18.226986870 +0100
@@ -278,6 +278,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/vfb/Makefile.in xorg-server-1.7.99.2.patch/hw/vfb/Makefile.in
--- xorg-server-1.7.99.2/hw/vfb/Makefile.in	2009-12-19 08:06:09.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/vfb/Makefile.in	2009-12-20 14:08:20.946986615 +0100
@@ -312,6 +312,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/common/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/common/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/common/Makefile.in	2009-12-19 08:06:09.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/common/Makefile.in	2009-12-20 14:08:21.349986712 +0100
@@ -317,6 +317,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/common/xf86Config.c xorg-server-1.7.99.2.patch/hw/xfree86/common/xf86Config.c
--- xorg-server-1.7.99.2/hw/xfree86/common/xf86Config.c	2009-12-18 19:30:53.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/common/xf86Config.c	2009-12-20 14:00:53.110988525 +0100
@@ -1444,12 +1444,19 @@
     }
 
     if (xf86Info.allowEmptyInput && !(foundPointer && foundKeyboard)) {
-#ifdef CONFIG_HAL
-	xf86Msg(X_INFO, "The server relies on HAL to provide the list of "
+#if defined(CONFIG_HAL) || defined(CONFIG_UDEV)
+	const char *config_backend;
+#if defined(CONFIG_HAL)
+	config_backend = "HAL";
+#else
+	config_backend = "udev";
+#endif
+	xf86Msg(X_INFO, "The server relies on %s to provide the list of "
 	                "input devices.\n\tIf no devices become available, "
-	                "reconfigure HAL or disable AutoAddDevices.\n");
+	                "reconfigure %s or disable AutoAddDevices.\n",
+			config_backend, config_backend);
 #else
-	xf86Msg(X_INFO, "HAL is disabled and no input devices were configured.\n"
+	xf86Msg(X_INFO, "Hotplugging is disabled and no input devices were configured.\n"
 			"\tTry disabling AllowEmptyInput.\n");
 #endif
     }
diff -Naur xorg-server-1.7.99.2/hw/xfree86/common/xf86Config.c.orig xorg-server-1.7.99.2.patch/hw/xfree86/common/xf86Config.c.orig
--- xorg-server-1.7.99.2/hw/xfree86/common/xf86Config.c.orig	1970-01-01 01:00:00.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/common/xf86Config.c.orig	2009-12-18 19:30:53.000000000 +0100
@@ -0,0 +1,2569 @@
+/*
+ * Loosely based on code bearing the following copyright:
+ *
+ *   Copyright 1990,91 by Thomas Roell, Dinkelscherben, Germany.
+ */
+
+/*
+ * Copyright 1992-2003 by The XFree86 Project, Inc.
+ * Copyright 1997 by Metro Link, Inc.
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a
+ * copy of this software and associated documentation files (the "Software"),
+ * to deal in the Software without restriction, including without limitation
+ * the rights to use, copy, modify, merge, publish, distribute, sublicense,
+ * and/or sell copies of the Software, and to permit persons to whom the
+ * Software is furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+ * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR
+ * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+ * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
+ * OTHER DEALINGS IN THE SOFTWARE.
+ *
+ * Except as contained in this notice, the name of the copyright holder(s)
+ * and author(s) shall not be used in advertising or otherwise to promote
+ * the sale, use or other dealings in this Software without prior written
+ * authorization from the copyright holder(s) and author(s).
+ */
+
+/*
+ *
+ * Authors:
+ *	Dirk Hohndel <hohndel@XFree86.Org>
+ *	David Dawes <dawes@XFree86.Org>
+ *      Marc La France <tsi@XFree86.Org>
+ *      Egbert Eich <eich@XFree86.Org>
+ *      ... and others
+ */
+
+#ifdef HAVE_XORG_CONFIG_H
+#include <xorg-config.h>
+#endif
+
+#ifdef XF86DRI
+#include <sys/types.h>
+#include <grp.h>
+#endif
+
+#include "xf86.h"
+#include "xf86Parser.h"
+#include "xf86tokens.h"
+#include "xf86Config.h"
+#include "xf86Priv.h"
+#include "xf86_OSlib.h"
+#include "configProcs.h"
+#include "globals.h"
+#include "extension.h"
+#include "Pci.h"
+
+#include "xf86Xinput.h"
+extern DeviceAssocRec mouse_assoc;
+
+#include "xkbsrv.h"
+
+#ifdef RENDER
+#include "picture.h"
+#endif
+
+/*
+ * These paths define the way the config file search is done.  The escape
+ * sequences are documented in parser/scan.c.
+ */
+#ifndef ROOT_CONFIGPATH
+#define ROOT_CONFIGPATH	"%A," "%R," \
+			"/etc/X11/%R," "%P/etc/X11/%R," \
+			"%E," "%F," \
+			"/etc/X11/%F," "%P/etc/X11/%F," \
+			"/etc/X11/%X-%M," "/etc/X11/%X," "/etc/%X," \
+			"%P/etc/X11/%X.%H," "%P/etc/X11/%X-%M," \
+			"%P/etc/X11/%X," \
+			"%P/lib/X11/%X.%H," "%P/lib/X11/%X-%M," \
+			"%P/lib/X11/%X"
+#endif
+#ifndef USER_CONFIGPATH
+#define USER_CONFIGPATH	"/etc/X11/%S," "%P/etc/X11/%S," \
+			"/etc/X11/%G," "%P/etc/X11/%G," \
+			"/etc/X11/%X-%M," "/etc/X11/%X," "/etc/%X," \
+			"%P/etc/X11/%X.%H," "%P/etc/X11/%X-%M," \
+			"%P/etc/X11/%X," \
+			"%P/lib/X11/%X.%H," "%P/lib/X11/%X-%M," \
+			"%P/lib/X11/%X"
+#endif
+#ifndef PROJECTROOT
+#define PROJECTROOT	"/usr/X11R6"
+#endif
+
+static ModuleDefault ModuleDefaults[] = {
+    {.name = "extmod",   .toLoad = TRUE,    .load_opt=NULL},
+#ifdef DBE
+    {.name = "dbe",      .toLoad = TRUE,    .load_opt=NULL},
+#endif
+#ifdef GLXEXT
+    {.name = "glx",      .toLoad = TRUE,    .load_opt=NULL},
+#endif
+#ifdef XRECORD
+    {.name = "record",   .toLoad = TRUE,    .load_opt=NULL},
+#endif
+#ifdef XF86DRI
+    {.name = "dri",      .toLoad = TRUE,    .load_opt=NULL},
+#endif
+#ifdef DRI2
+    {.name = "dri2",     .toLoad = TRUE,    .load_opt=NULL},
+#endif
+    {.name = NULL,       .toLoad = FALSE,   .load_opt=NULL}
+};
+
+
+/* Forward declarations */
+static Bool configScreen(confScreenPtr screenp, XF86ConfScreenPtr conf_screen,
+			 int scrnum, MessageType from);
+static Bool configMonitor(MonPtr monitorp, XF86ConfMonitorPtr conf_monitor);
+static Bool configDevice(GDevPtr devicep, XF86ConfDevicePtr conf_device,
+			 Bool active);
+static Bool configInput(IDevPtr inputp, XF86ConfInputPtr conf_input,
+			MessageType from);
+static Bool configDisplay(DispPtr displayp, XF86ConfDisplayPtr conf_display);
+static Bool addDefaultModes(MonPtr monitorp);
+#ifdef XF86DRI
+static void configDRI(XF86ConfDRIPtr drip);
+#endif
+static void configExtensions(XF86ConfExtensionsPtr conf_ext);
+
+/*
+ * xf86GetPathElem --
+ *	Extract a single element from the font path string starting at
+ *	pnt.  The font path element will be returned, and pnt will be
+ *	updated to point to the start of the next element, or set to
+ *	NULL if there are no more.
+ */
+static char *
+xf86GetPathElem(char **pnt)
+{
+  char *p1;
+
+  p1 = *pnt;
+  *pnt = index(*pnt, ',');
+  if (*pnt != NULL) {
+    **pnt = '\0';
+    *pnt += 1;
+  }
+  return(p1);
+}
+
+/*
+ * xf86ValidateFontPath --
+ *	Validates the user-specified font path.  Each element that
+ *	begins with a '/' is checked to make sure the directory exists.
+ *	If the directory exists, the existence of a file named 'fonts.dir'
+ *	is checked.  If either check fails, an error is printed and the
+ *	element is removed from the font path.
+ */
+
+#define DIR_FILE "/fonts.dir"
+static char *
+xf86ValidateFontPath(char *path)
+{
+  char *tmp_path, *out_pnt, *path_elem, *next, *p1, *dir_elem;
+  struct stat stat_buf;
+  int flag;
+  int dirlen;
+
+  tmp_path = xcalloc(1,strlen(path)+1);
+  out_pnt = tmp_path;
+  path_elem = NULL;
+  next = path;
+  while (next != NULL) {
+    path_elem = xf86GetPathElem(&next);
+    if (*path_elem == '/') {
+      dir_elem = xnfcalloc(1, strlen(path_elem) + 1);
+      if ((p1 = strchr(path_elem, ':')) != 0)
+	dirlen = p1 - path_elem;
+      else
+	dirlen = strlen(path_elem);
+      strncpy(dir_elem, path_elem, dirlen);
+      dir_elem[dirlen] = '\0';
+      flag = stat(dir_elem, &stat_buf);
+      if (flag == 0)
+	if (!S_ISDIR(stat_buf.st_mode))
+	  flag = -1;
+      if (flag != 0) {
+        xf86Msg(X_WARNING, "The directory \"%s\" does not exist.\n", dir_elem);
+	xf86ErrorF("\tEntry deleted from font path.\n");
+	xfree(dir_elem);
+	continue;
+      }
+      else {
+	p1 = xnfalloc(strlen(dir_elem)+strlen(DIR_FILE)+1);
+	strcpy(p1, dir_elem);
+	strcat(p1, DIR_FILE);
+	flag = stat(p1, &stat_buf);
+	if (flag == 0)
+	  if (!S_ISREG(stat_buf.st_mode))
+	    flag = -1;
+	xfree(p1);
+	if (flag != 0) {
+	  xf86Msg(X_WARNING,
+		  "`fonts.dir' not found (or not valid) in \"%s\".\n", 
+		  dir_elem);
+	  xf86ErrorF("\tEntry deleted from font path.\n");
+	  xf86ErrorF("\t(Run 'mkfontdir' on \"%s\").\n", dir_elem);
+	  xfree(dir_elem);
+	  continue;
+	}
+      }
+      xfree(dir_elem);
+    }
+
+    /*
+     * Either an OK directory, or a font server name.  So add it to
+     * the path.
+     */
+    if (out_pnt != tmp_path)
+      *out_pnt++ = ',';
+    strcat(out_pnt, path_elem);
+    out_pnt += strlen(path_elem);
+  }
+  return(tmp_path);
+}
+
+
+/*
+ * use the datastructure that the parser provides and pick out the parts
+ * that we need at this point
+ */
+char **
+xf86ModulelistFromConfig(pointer **optlist)
+{
+    int count = 0, i = 0;
+    char **modulearray;
+    char *ignore[] = { "GLcore", "speedo", "bitmap", "drm",
+		       "freetype", "type1",
+		       NULL };
+    pointer *optarray;
+    XF86LoadPtr modp;
+    Bool found;
+    
+    /*
+     * make sure the config file has been parsed and that we have a
+     * ModulePath set; if no ModulePath was given, use the default
+     * ModulePath
+     */
+    if (xf86configptr == NULL) {
+        xf86Msg(X_ERROR, "Cannot access global config data structure\n");
+        return NULL;
+    }
+    
+    if (xf86configptr->conf_modules) {
+        /* Walk the disable list and let people know what we've parsed to
+         * not be loaded 
+         */
+        modp = xf86configptr->conf_modules->mod_disable_lst;
+        while (modp) {
+            xf86Msg(X_WARNING, "\"%s\" will not be loaded unless you've specified it to be loaded elsewhere.\n", modp->load_name);
+	        modp = (XF86LoadPtr) modp->list.next;
+        }
+        /*
+         * Walk the default settings table. For each module listed to be
+         * loaded, make sure it's in the mod_load_lst. If it's not, make
+         * sure it's not in the mod_no_load_lst. If it's not disabled,
+         * append it to mod_load_lst
+         */
+         for (i=0 ; ModuleDefaults[i].name != NULL ; i++) {
+            if (ModuleDefaults[i].toLoad == FALSE) {
+                xf86Msg(X_WARNING, "\"%s\" is not to be loaded by default. Skipping.\n", ModuleDefaults[i].name);
+                continue;
+            }
+            found = FALSE;
+            modp = xf86configptr->conf_modules->mod_load_lst;
+            while (modp) {
+                if (strcmp(modp->load_name, ModuleDefaults[i].name) == 0) {
+                    xf86Msg(X_INFO, "\"%s\" will be loaded. This was enabled by default and also specified in the config file.\n", ModuleDefaults[i].name);
+                    found = TRUE;
+                    break;
+                }
+	        modp = (XF86LoadPtr) modp->list.next;
+            }
+            if (found == FALSE) {
+                modp = xf86configptr->conf_modules->mod_disable_lst;
+                while (modp) {
+                    if (strcmp(modp->load_name, ModuleDefaults[i].name) == 0) {
+                        xf86Msg(X_INFO, "\"%s\" will be loaded even though the default is to disable it.\n", ModuleDefaults[i].name);
+                        found = TRUE;
+                        break;
+                    }
+	                modp = (XF86LoadPtr) modp->list.next;
+                }
+            }
+            if (found == FALSE) {
+		XF86LoadPtr ptr = (XF86LoadPtr)xf86configptr->conf_modules;
+	            ptr = xf86addNewLoadDirective(ptr, ModuleDefaults[i].name, XF86_LOAD_MODULE, ModuleDefaults[i].load_opt);
+                xf86Msg(X_INFO, "\"%s\" will be loaded by default.\n", ModuleDefaults[i].name);
+            }
+         }
+    } else {
+	xf86configptr->conf_modules = xnfcalloc(1, sizeof(XF86ConfModuleRec));
+	for (i=0 ; ModuleDefaults[i].name != NULL ; i++) {
+	    if (ModuleDefaults[i].toLoad == TRUE) {
+		XF86LoadPtr ptr = (XF86LoadPtr)xf86configptr->conf_modules;
+		ptr = xf86addNewLoadDirective(ptr, ModuleDefaults[i].name, XF86_LOAD_MODULE, ModuleDefaults[i].load_opt);
+	    }
+	}
+    }
+
+	    /*
+	     * Walk the list of modules in the "Module" section to determine how
+	     * many we have.
+	    */
+	    modp = xf86configptr->conf_modules->mod_load_lst;
+	    while (modp) {
+                for (i = 0; ignore[i]; i++) {
+                    if (strcmp(modp->load_name, ignore[i]) == 0)
+                        modp->ignore = 1;
+                }
+                if (!modp->ignore)
+	            count++;
+	        modp = (XF86LoadPtr) modp->list.next;
+	    }
+
+    /*
+     * allocate the memory and walk the list again to fill in the pointers
+     */
+    modulearray = xnfalloc((count + 1) * sizeof(char*));
+    optarray = xnfalloc((count + 1) * sizeof(pointer));
+    count = 0;
+    if (xf86configptr->conf_modules) {
+	    modp = xf86configptr->conf_modules->mod_load_lst;
+	    while (modp) {
+            if (!modp->ignore) {
+	            modulearray[count] = modp->load_name;
+	            optarray[count] = modp->load_opt;
+	            count++;
+            }
+	        modp = (XF86LoadPtr) modp->list.next;
+	    }
+    }
+    modulearray[count] = NULL;
+    optarray[count] = NULL;
+    if (optlist)
+	    *optlist = optarray;
+    else
+	    xfree(optarray);
+    return modulearray;
+}
+
+
+char **
+xf86DriverlistFromConfig(void)
+{
+    int count = 0;
+    int j;
+    char **modulearray;
+    screenLayoutPtr slp;
+    
+    /*
+     * make sure the config file has been parsed and that we have a
+     * ModulePath set; if no ModulePath was given, use the default
+     * ModulePath
+     */
+    if (xf86configptr == NULL) {
+        xf86Msg(X_ERROR, "Cannot access global config data structure\n");
+        return NULL;
+    }
+    
+    /*
+     * Walk the list of driver lines in active "Device" sections to
+     * determine now many implicitly loaded modules there are.
+     *
+     */
+    if (xf86ConfigLayout.screens) {
+        slp = xf86ConfigLayout.screens;
+        while ((slp++)->screen) {
+	    count++;
+        }
+    }
+
+    /*
+     * Handle the set of inactive "Device" sections.
+     */
+    j = 0;
+    while (xf86ConfigLayout.inactives[j++].identifier)
+	count++;
+
+    if (count == 0)
+	return NULL;
+
+    /*
+     * allocate the memory and walk the list again to fill in the pointers
+     */
+    modulearray = xnfalloc((count + 1) * sizeof(char*));
+    count = 0;
+    slp = xf86ConfigLayout.screens;
+    while (slp->screen) {
+	modulearray[count] = slp->screen->device->driver;
+	count++;
+	slp++;
+    }
+
+    j = 0;
+
+    while (xf86ConfigLayout.inactives[j].identifier) 
+	modulearray[count++] = xf86ConfigLayout.inactives[j++].driver;
+
+    modulearray[count] = NULL;
+
+    /* Remove duplicates */
+    for (count = 0; modulearray[count] != NULL; count++) {
+	int i;
+
+	for (i = 0; i < count; i++)
+	    if (xf86NameCmp(modulearray[i], modulearray[count]) == 0) {
+		modulearray[count] = "";
+		break;
+	    }
+    }
+    return modulearray;
+}
+
+char **
+xf86InputDriverlistFromConfig(void)
+{
+    int count = 0;
+    char **modulearray;
+    IDevPtr* idp;
+    
+    /*
+     * make sure the config file has been parsed and that we have a
+     * ModulePath set; if no ModulePath was given, use the default
+     * ModulePath
+     */
+    if (xf86configptr == NULL) {
+        xf86Msg(X_ERROR, "Cannot access global config data structure\n");
+        return NULL;
+    }
+    
+    /*
+     * Walk the list of driver lines in active "InputDevice" sections to
+     * determine now many implicitly loaded modules there are.
+     */
+    if (xf86ConfigLayout.inputs) {
+        idp = xf86ConfigLayout.inputs;
+        while (*idp) {
+	    count++;
+	    idp++;
+        }
+    }
+
+    if (count == 0)
+	return NULL;
+
+    /*
+     * allocate the memory and walk the list again to fill in the pointers
+     */
+    modulearray = xnfalloc((count + 1) * sizeof(char*));
+    count = 0;
+    idp = xf86ConfigLayout.inputs;
+    while (idp && *idp) {
+        modulearray[count] = (*idp)->driver;
+	count++;
+	idp++;
+    }
+    modulearray[count] = NULL;
+
+    /* Remove duplicates */
+    for (count = 0; modulearray[count] != NULL; count++) {
+	int i;
+
+	for (i = 0; i < count; i++)
+	    if (xf86NameCmp(modulearray[i], modulearray[count]) == 0) {
+		modulearray[count] = "";
+		break;
+	    }
+    }
+    return modulearray;
+}
+
+static void
+fixup_video_driver_list(char **drivers)
+{
+    static const char *fallback[4] = { "vesa", "fbdev", "wsfb", NULL };
+    char **end, **drv;
+    char *x;
+    char **ati, **atimisc;
+    int i;
+
+    /* walk to the end of the list */
+    for (end = drivers; *end && **end; end++) ;
+    end--;
+
+    /*
+     * for each of the fallback drivers, if we find it in the list,
+     * swap it with the last available non-fallback driver.
+     */
+    for (i = 0; fallback[i]; i++) {
+        for (drv = drivers; drv != end; drv++) {
+            if (strstr(*drv, fallback[i])) {
+                x = *drv; *drv = *end; *end = x;
+                end--;
+                break;
+            }
+        }
+    }
+    /*
+     * since the ati wrapper driver is gross and awful, sort ati before
+     * atimisc, which makes sure all the ati symbols are visible in xorgcfg.
+     */
+    for (drv = drivers; drv != end; drv++) {
+        if (!strcmp(*drv, "atimisc")) {
+            atimisc = drv;
+            for (drv = atimisc; drv != end; drv++) {
+                if (!strcmp(*drv, "ati")) {
+                    ati = drv;
+                    x = *ati; *ati = *atimisc; *atimisc = x;
+                    return;
+                }
+            }
+            /* if we get here, ati was already ahead of atimisc */
+            return;
+        }
+    }
+}
+
+static char **
+GenerateDriverlist(char * dirname)
+{
+    char **ret;
+    const char *subdirs[] = { dirname, NULL };
+    static const char *patlist[] = {"(.*)_drv\\.so", "(.*)_drv\\.o", NULL};
+    ret = LoaderListDirs(subdirs, patlist);
+    
+    /* fix up the probe order for video drivers */
+    if (strstr(dirname, "drivers") && ret != NULL)
+        fixup_video_driver_list(ret);
+
+    return ret;
+}
+
+char **
+xf86DriverlistFromCompile(void)
+{
+    static char **driverlist = NULL;
+
+    if (!driverlist)
+        driverlist = GenerateDriverlist("drivers");
+
+    return driverlist;
+}
+
+/*
+ * xf86ConfigError --
+ *      Print a READABLE ErrorMessage!!!  All information that is 
+ *      available is printed.
+ */
+static void
+xf86ConfigError(char *msg, ...)
+{
+    va_list ap;
+
+    ErrorF("\nConfig Error:\n");
+    va_start(ap, msg);
+    VErrorF(msg, ap);
+    va_end(ap);
+    ErrorF("\n");
+    return;
+}
+
+static void
+configFiles(XF86ConfFilesPtr fileconf)
+{
+    MessageType	 pathFrom;
+    Bool	 must_copy;
+    int		 size, countDirs;
+    char	*temp_path, *log_buf, *start, *end;
+
+    /* FontPath */
+    must_copy = TRUE;
+
+    temp_path = defaultFontPath ? defaultFontPath : "";
+    if (xf86fpFlag)
+	pathFrom = X_CMDLINE;
+    else if (fileconf && fileconf->file_fontpath) {
+	pathFrom = X_CONFIG;
+	if (xf86Info.useDefaultFontPath) {
+	    defaultFontPath = Xprintf("%s%s%s",
+				      fileconf->file_fontpath,
+				      *temp_path ? "," : "", temp_path);
+	    if (defaultFontPath != NULL) {
+		must_copy = FALSE;
+	    }
+	}
+	else
+	    defaultFontPath = fileconf->file_fontpath;
+    }
+    else
+	pathFrom = X_DEFAULT;
+    temp_path = defaultFontPath ? defaultFontPath : "";
+
+    /* xf86ValidateFontPath modifies its argument, but returns a copy of it. */
+    temp_path = must_copy ? xnfstrdup(defaultFontPath) : defaultFontPath;
+    defaultFontPath = xf86ValidateFontPath(temp_path);
+    xfree(temp_path);
+
+    /* make fontpath more readable in the logfiles */
+    countDirs = 1;
+    temp_path = defaultFontPath;
+    while ((temp_path = index(temp_path, ',')) != NULL) {
+	countDirs++;
+	temp_path++;
+    }
+
+    log_buf = xnfalloc(strlen(defaultFontPath) + (2 * countDirs) + 1);
+    temp_path = log_buf;
+    start = defaultFontPath;
+    while((end = index(start, ',')) != NULL) {
+      size = (end - start) + 1;
+      *(temp_path++) = '\t';
+      strncpy(temp_path, start, size);
+      temp_path += size;
+      *(temp_path++) = '\n';
+      start += size;
+    }
+    /* copy last entry */
+    *(temp_path++) = '\t';
+    strcpy(temp_path, start);
+    xf86Msg(pathFrom, "FontPath set to:\n%s\n", log_buf);
+    xfree(log_buf);
+  
+  /* ModulePath */
+
+  if (fileconf) {
+    if (xf86ModPathFrom != X_CMDLINE && fileconf->file_modulepath) {
+      xf86ModulePath = fileconf->file_modulepath;
+      xf86ModPathFrom = X_CONFIG;
+    }
+  }
+
+  xf86Msg(xf86ModPathFrom, "ModulePath set to \"%s\"\n", xf86ModulePath);
+
+  if (!xf86xkbdirFlag && fileconf && fileconf->file_xkbdir) {
+    XkbBaseDirectory = fileconf->file_xkbdir;
+    xf86Msg(X_CONFIG, "XKB base directory set to \"%s\"\n",
+	    XkbBaseDirectory);
+  }
+#if 0
+  /* LogFile */
+  /*
+   * XXX The problem with this is that the log file is already open.
+   * One option might be to copy the exiting contents to the new location.
+   * and re-open it.  The down side is that the default location would
+   * already have been overwritten.  Another option would be to start with
+   * unique temporary location, then copy it once the correct name is known.
+   * A problem with this is what happens if the server exits before that
+   * happens.
+   */
+  if (xf86LogFileFrom == X_DEFAULT && fileconf->file_logfile) {
+    xf86LogFile = fileconf->file_logfile;
+    xf86LogFileFrom = X_CONFIG;
+  }
+#endif
+
+  return;
+}
+
+typedef enum {
+    FLAG_NOTRAPSIGNALS,
+    FLAG_DONTVTSWITCH,
+    FLAG_DONTZAP,
+    FLAG_DONTZOOM,
+    FLAG_DISABLEVIDMODE,
+    FLAG_ALLOWNONLOCAL,
+    FLAG_ALLOWMOUSEOPENFAIL,
+    FLAG_VTSYSREQ,
+    FLAG_SAVER_BLANKTIME,
+    FLAG_DPMS_STANDBYTIME,
+    FLAG_DPMS_SUSPENDTIME,
+    FLAG_DPMS_OFFTIME,
+    FLAG_PIXMAP,
+    FLAG_PC98,
+    FLAG_NOPM,
+    FLAG_XINERAMA,
+    FLAG_LOG,
+    FLAG_RENDER_COLORMAP_MODE,
+    FLAG_RANDR,
+    FLAG_AIGLX,
+    FLAG_IGNORE_ABI,
+    FLAG_ALLOW_EMPTY_INPUT,
+    FLAG_USE_DEFAULT_FONT_PATH,
+    FLAG_AUTO_ADD_DEVICES,
+    FLAG_AUTO_ENABLE_DEVICES,
+    FLAG_GLX_VISUALS,
+    FLAG_DRI2,
+    FLAG_USE_SIGIO
+} FlagValues;
+
+/**
+ * NOTE: the last value for each entry is NOT the default. It is set to TRUE
+ * if the parser found the option in the config file.
+ */
+static OptionInfoRec FlagOptions[] = {
+  { FLAG_NOTRAPSIGNALS,		"NoTrapSignals",		OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_DONTVTSWITCH,		"DontVTSwitch",			OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_DONTZAP,		"DontZap",			OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_DONTZOOM,		"DontZoom",			OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_DISABLEVIDMODE,	"DisableVidModeExtension",	OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_ALLOWNONLOCAL,		"AllowNonLocalXvidtune",	OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_ALLOWMOUSEOPENFAIL,	"AllowMouseOpenFail",		OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_VTSYSREQ,		"VTSysReq",			OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_SAVER_BLANKTIME,	"BlankTime"		,	OPTV_INTEGER,
+	{0}, FALSE },
+  { FLAG_DPMS_STANDBYTIME,	"StandbyTime",			OPTV_INTEGER,
+	{0}, FALSE },
+  { FLAG_DPMS_SUSPENDTIME,	"SuspendTime",			OPTV_INTEGER,
+	{0}, FALSE },
+  { FLAG_DPMS_OFFTIME,		"OffTime",			OPTV_INTEGER,
+	{0}, FALSE },
+  { FLAG_PIXMAP,		"Pixmap",			OPTV_INTEGER,
+	{0}, FALSE },
+  { FLAG_PC98,			"PC98",				OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_NOPM,			"NoPM",				OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_XINERAMA,		"Xinerama",			OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_LOG,			"Log",				OPTV_STRING,
+	{0}, FALSE },
+  { FLAG_RENDER_COLORMAP_MODE,	"RenderColormapMode",		OPTV_STRING,
+        {0}, FALSE },
+  { FLAG_RANDR,			"RandR",			OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_AIGLX,			"AIGLX",			OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_ALLOW_EMPTY_INPUT,     "AllowEmptyInput",              OPTV_BOOLEAN,
+        {0}, FALSE },
+  { FLAG_IGNORE_ABI,		"IgnoreABI",			OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_USE_DEFAULT_FONT_PATH,  "UseDefaultFontPath",		OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_AUTO_ADD_DEVICES,       "AutoAddDevices",		OPTV_BOOLEAN,
+        {0}, FALSE },
+  { FLAG_AUTO_ENABLE_DEVICES,    "AutoEnableDevices",		OPTV_BOOLEAN,
+        {0}, FALSE },
+  { FLAG_GLX_VISUALS,		"GlxVisuals",			OPTV_STRING,
+        {0}, FALSE },
+  { FLAG_DRI2,			"DRI2",				OPTV_BOOLEAN,
+	{0}, FALSE },
+  { FLAG_USE_SIGIO,		"UseSIGIO",			OPTV_BOOLEAN,
+	{0}, FALSE },
+  { -1,				NULL,				OPTV_NONE,
+	{0}, FALSE },
+};
+
+#ifdef SUPPORT_PC98
+static Bool
+detectPC98(void)
+{
+    unsigned char buf[2];
+
+    if (xf86ReadBIOS(0xf8000, 0xe80, buf, 2) != 2)
+	return FALSE;
+    if ((buf[0] == 0x98) && (buf[1] == 0x21))
+	return TRUE;
+    else
+	return FALSE;
+}
+#endif
+
+static Bool
+configServerFlags(XF86ConfFlagsPtr flagsconf, XF86OptionPtr layoutopts)
+{
+    XF86OptionPtr optp, tmp;
+    int i;
+    Pix24Flags pix24 = Pix24DontCare;
+    Bool value;
+    MessageType from;
+    const char *s;
+    XkbRMLVOSet set;
+    /* Default options. */
+    set.rules = "base";
+    set.model = "pc105";
+    set.layout = "us";
+    set.variant = NULL;
+    set.options = NULL;
+
+    /*
+     * Merge the ServerLayout and ServerFlags options.  The former have
+     * precedence over the latter.
+     */
+    optp = NULL;
+    if (flagsconf && flagsconf->flg_option_lst)
+	optp = xf86optionListDup(flagsconf->flg_option_lst);
+    if (layoutopts) {
+	tmp = xf86optionListDup(layoutopts);
+	if (optp)
+	    optp = xf86optionListMerge(optp, tmp);
+	else
+	    optp = tmp;
+    }
+
+    xf86ProcessOptions(-1, optp, FlagOptions);
+
+    xf86GetOptValBool(FlagOptions, FLAG_NOTRAPSIGNALS, &xf86Info.notrapSignals);
+    xf86GetOptValBool(FlagOptions, FLAG_DONTVTSWITCH, &xf86Info.dontVTSwitch);
+    xf86GetOptValBool(FlagOptions, FLAG_DONTZAP, &xf86Info.dontZap);
+    xf86GetOptValBool(FlagOptions, FLAG_DONTZOOM, &xf86Info.dontZoom);
+
+    xf86GetOptValBool(FlagOptions, FLAG_IGNORE_ABI, &xf86Info.ignoreABI);
+    if (xf86Info.ignoreABI) {
+	    xf86Msg(X_CONFIG, "Ignoring ABI Version\n");
+    }
+
+    if (xf86SIGIOSupported()) {
+	xf86Info.useSIGIO = xf86ReturnOptValBool(FlagOptions, FLAG_USE_SIGIO, USE_SIGIO_BY_DEFAULT);
+	if (xf86IsOptionSet(FlagOptions, FLAG_USE_SIGIO)) {
+	    from = X_CONFIG;
+	} else {
+	    from = X_DEFAULT;
+	}
+	if (!xf86Info.useSIGIO) {
+	    xf86Msg(from, "Disabling SIGIO handlers for input devices\n");
+	} else if (from == X_CONFIG) {
+	    xf86Msg(from, "Enabling SIGIO handlers for input devices\n");
+	}
+    } else {
+	xf86Info.useSIGIO = FALSE;
+    }
+
+    if (xf86IsOptionSet(FlagOptions, FLAG_AUTO_ADD_DEVICES)) {
+        xf86GetOptValBool(FlagOptions, FLAG_AUTO_ADD_DEVICES,
+                          &xf86Info.autoAddDevices);
+        from = X_CONFIG;
+    }
+    else {
+        from = X_DEFAULT;
+    }
+    xf86Msg(from, "%sutomatically adding devices\n",
+            xf86Info.autoAddDevices ? "A" : "Not a");
+
+    if (xf86IsOptionSet(FlagOptions, FLAG_AUTO_ENABLE_DEVICES)) {
+        xf86GetOptValBool(FlagOptions, FLAG_AUTO_ENABLE_DEVICES,
+                          &xf86Info.autoEnableDevices);
+        from = X_CONFIG;
+    }
+    else {
+        from = X_DEFAULT;
+    }
+    xf86Msg(from, "%sutomatically enabling devices\n",
+            xf86Info.autoEnableDevices ? "A" : "Not a");
+
+    /*
+     * Set things up based on the config file information.  Some of these
+     * settings may be overridden later when the command line options are
+     * checked.
+     */
+#ifdef XF86VIDMODE
+    if (xf86GetOptValBool(FlagOptions, FLAG_DISABLEVIDMODE, &value))
+	xf86Info.vidModeEnabled = !value;
+    if (xf86GetOptValBool(FlagOptions, FLAG_ALLOWNONLOCAL, &value))
+	xf86Info.vidModeAllowNonLocal = value;
+#endif
+
+    if (xf86GetOptValBool(FlagOptions, FLAG_ALLOWMOUSEOPENFAIL, &value))
+	xf86Info.allowMouseOpenFail = value;
+
+    if (xf86GetOptValBool(FlagOptions, FLAG_VTSYSREQ, &value)) {
+#ifdef USE_VT_SYSREQ
+	xf86Info.vtSysreq = value;
+	xf86Msg(X_CONFIG, "VTSysReq %s\n", value ? "enabled" : "disabled");
+#else
+	if (value)
+	    xf86Msg(X_WARNING, "VTSysReq is not supported on this OS\n");
+#endif
+    }
+
+    xf86Info.pmFlag = TRUE;
+    if (xf86GetOptValBool(FlagOptions, FLAG_NOPM, &value)) 
+	xf86Info.pmFlag = !value;
+    {
+	if ((s = xf86GetOptValString(FlagOptions, FLAG_LOG))) {
+	    if (!xf86NameCmp(s,"flush")) {
+		xf86Msg(X_CONFIG, "Flushing logfile enabled\n");
+		xf86Info.log = LogFlush;
+		LogSetParameter(XLOG_FLUSH, TRUE);
+	    } else if (!xf86NameCmp(s,"sync")) {
+		xf86Msg(X_CONFIG, "Syncing logfile enabled\n");
+		xf86Info.log = LogSync;
+		LogSetParameter(XLOG_FLUSH, TRUE);
+		LogSetParameter(XLOG_SYNC, TRUE);
+	    } else {
+		xf86Msg(X_WARNING,"Unknown Log option\n");
+	    }
+        }
+    }
+    
+#ifdef RENDER
+    {
+	if ((s = xf86GetOptValString(FlagOptions, FLAG_RENDER_COLORMAP_MODE))){
+	    int policy = PictureParseCmapPolicy (s);
+	    if (policy == PictureCmapPolicyInvalid)
+		xf86Msg(X_WARNING, "Unknown colormap policy \"%s\"\n", s);
+	    else
+	    {
+		xf86Msg(X_CONFIG, "Render colormap policy set to %s\n", s);
+		PictureCmapPolicy = policy;
+	    }
+	}
+    }
+#endif
+
+#ifdef RANDR
+    xf86Info.disableRandR = FALSE;
+    xf86Info.randRFrom = X_DEFAULT;
+    if (xf86GetOptValBool(FlagOptions, FLAG_RANDR, &value)) {
+	xf86Info.disableRandR = !value;
+	xf86Info.randRFrom = X_CONFIG;
+    }
+#endif
+
+    xf86Info.aiglx = TRUE;
+    xf86Info.aiglxFrom = X_DEFAULT;
+    if (xf86GetOptValBool(FlagOptions, FLAG_AIGLX, &value)) {
+	xf86Info.aiglx = value;
+	xf86Info.aiglxFrom = X_CONFIG;
+    }
+
+#ifdef GLXEXT
+    xf86Info.glxVisuals = XF86_GlxVisualsTypical;
+    xf86Info.glxVisualsFrom = X_DEFAULT;
+    if ((s = xf86GetOptValString(FlagOptions, FLAG_GLX_VISUALS))) {
+	if (!xf86NameCmp(s, "minimal")) {
+	    xf86Info.glxVisuals = XF86_GlxVisualsMinimal;
+	} else if (!xf86NameCmp(s, "typical")) {
+	    xf86Info.glxVisuals = XF86_GlxVisualsTypical;
+	} else if (!xf86NameCmp(s, "all")) {
+	    xf86Info.glxVisuals = XF86_GlxVisualsAll;
+	} else {
+	    xf86Msg(X_WARNING,"Unknown GlxVisuals option\n");
+	}
+    }
+
+    if (xf86GetOptValBool(FlagOptions, FLAG_AIGLX, &value)) {
+	xf86Info.aiglx = value;
+	xf86Info.aiglxFrom = X_CONFIG;
+    }
+#endif
+
+    /* AllowEmptyInput is automatically true if we're hotplugging */
+    xf86Info.allowEmptyInput = (xf86Info.autoAddDevices && xf86Info.autoEnableDevices);
+    xf86GetOptValBool(FlagOptions, FLAG_ALLOW_EMPTY_INPUT, &xf86Info.allowEmptyInput);
+
+    /* AEI on? Then we're not using kbd, so use the evdev rules set. */
+#if defined(linux)
+    if (xf86Info.allowEmptyInput)
+        set.rules = "evdev";
+#endif
+    XkbSetRulesDflts(&set);
+
+    xf86Info.useDefaultFontPath = TRUE;
+    xf86Info.useDefaultFontPathFrom = X_DEFAULT;
+    if (xf86GetOptValBool(FlagOptions, FLAG_USE_DEFAULT_FONT_PATH, &value)) {
+	xf86Info.useDefaultFontPath = value;
+	xf86Info.useDefaultFontPathFrom = X_CONFIG;
+    }
+
+/* Make sure that timers don't overflow CARD32's after multiplying */
+#define MAX_TIME_IN_MIN (0x7fffffff / MILLI_PER_MIN)
+
+    i = -1;
+    xf86GetOptValInteger(FlagOptions, FLAG_SAVER_BLANKTIME, &i);
+    if ((i >= 0) && (i < MAX_TIME_IN_MIN))
+	ScreenSaverTime = defaultScreenSaverTime = i * MILLI_PER_MIN;
+    else if (i != -1)
+	xf86ConfigError("BlankTime value %d outside legal range of 0 - %d minutes",
+			i, MAX_TIME_IN_MIN);
+
+#ifdef DPMSExtension
+    i = -1;
+    xf86GetOptValInteger(FlagOptions, FLAG_DPMS_STANDBYTIME, &i);
+    if ((i >= 0) && (i < MAX_TIME_IN_MIN))
+	DPMSStandbyTime = i * MILLI_PER_MIN;
+    else if (i != -1)
+	xf86ConfigError("StandbyTime value %d outside legal range of 0 - %d minutes",
+			i, MAX_TIME_IN_MIN);
+    i = -1;
+    xf86GetOptValInteger(FlagOptions, FLAG_DPMS_SUSPENDTIME, &i);
+    if ((i >= 0) && (i < MAX_TIME_IN_MIN))
+	DPMSSuspendTime = i * MILLI_PER_MIN;
+    else if (i != -1)
+	xf86ConfigError("SuspendTime value %d outside legal range of 0 - %d minutes",
+			i, MAX_TIME_IN_MIN);
+    i = -1;
+    xf86GetOptValInteger(FlagOptions, FLAG_DPMS_OFFTIME, &i);
+    if ((i >= 0) && (i < MAX_TIME_IN_MIN))
+	DPMSOffTime = i * MILLI_PER_MIN;
+    else if (i != -1)
+	xf86ConfigError("OffTime value %d outside legal range of 0 - %d minutes",
+			i, MAX_TIME_IN_MIN);
+#endif
+
+    i = -1;
+    xf86GetOptValInteger(FlagOptions, FLAG_PIXMAP, &i);
+    switch (i) {
+    case 24:
+	pix24 = Pix24Use24;
+	break;
+    case 32:
+	pix24 = Pix24Use32;
+	break;
+    case -1:
+	break;
+    default:
+	xf86ConfigError("Pixmap option's value (%d) must be 24 or 32\n", i);
+	return FALSE;
+    }
+    if (xf86Pix24 != Pix24DontCare) {
+	xf86Info.pixmap24 = xf86Pix24;
+	xf86Info.pix24From = X_CMDLINE;
+    } else if (pix24 != Pix24DontCare) {
+	xf86Info.pixmap24 = pix24;
+	xf86Info.pix24From = X_CONFIG;
+    } else {
+	xf86Info.pixmap24 = Pix24DontCare;
+	xf86Info.pix24From = X_DEFAULT;
+    }
+#ifdef SUPPORT_PC98
+    if (xf86GetOptValBool(FlagOptions, FLAG_PC98, &value)) {
+	xf86Info.pc98 = value;
+	if (value) {
+	    xf86Msg(X_CONFIG, "Japanese PC98 architecture\n");
+	}
+    } else
+	if (detectPC98()) {
+	    xf86Info.pc98 = TRUE;
+	    xf86Msg(X_PROBED, "Japanese PC98 architecture\n");
+	}
+#endif
+
+#ifdef PANORAMIX
+    from = X_DEFAULT;
+    if (!noPanoramiXExtension)
+      from = X_CMDLINE;
+    else if (xf86GetOptValBool(FlagOptions, FLAG_XINERAMA, &value)) {
+      noPanoramiXExtension = !value;
+      from = X_CONFIG;
+    }
+    if (!noPanoramiXExtension)
+      xf86Msg(from, "Xinerama: enabled\n");
+#endif
+
+#ifdef DRI2
+    xf86Info.dri2 = FALSE;
+    xf86Info.dri2From = X_DEFAULT;
+    if (xf86GetOptValBool(FlagOptions, FLAG_DRI2, &value)) {
+	xf86Info.dri2 = value;
+	xf86Info.dri2From = X_CONFIG;
+    }
+#endif
+
+    return TRUE;
+}
+
+Bool xf86DRI2Enabled(void)
+{
+    return xf86Info.dri2;
+}
+
+/*
+ * Locate the core input devices.  These can be specified/located in
+ * the following ways, in order of priority:
+ *
+ *  1. The InputDevices named by the -pointer and -keyboard command line
+ *     options.
+ *  2. The "CorePointer" and "CoreKeyboard" InputDevices referred to by
+ *     the active ServerLayout.
+ *  3. The first InputDevices marked as "CorePointer" and "CoreKeyboard".
+ *  4. The first InputDevices that use 'keyboard' or 'kbd' and a valid mouse
+ *     driver (mouse, synaptics, evdev, vmmouse, void)
+ *  5. Default devices with an empty (default) configuration.  These defaults
+ *     will reference the 'mouse' and 'keyboard' drivers.
+ */
+
+static Bool
+checkCoreInputDevices(serverLayoutPtr servlayoutp, Bool implicitLayout)
+{
+    IDevPtr corePointer = NULL, coreKeyboard = NULL;
+    Bool foundPointer = FALSE, foundKeyboard = FALSE;
+    const char *pointerMsg = NULL, *keyboardMsg = NULL;
+    IDevPtr *devs, /* iterator */
+            indp;
+    IDevRec Pointer, Keyboard;
+    XF86ConfInputPtr confInput;
+    XF86ConfInputRec defPtr, defKbd;
+    int count = 0;
+    MessageType from = X_DEFAULT;
+    int found = 0;
+    const char *mousedrivers[] = { "mouse", "synaptics", "evdev", "vmmouse",
+				   "void", NULL };
+
+    /*
+     * First check if a core pointer or core keyboard have been specified
+     * in the active ServerLayout.  If more than one is specified for either,
+     * remove the core attribute from the later ones.
+     */
+    for (devs = servlayoutp->inputs; devs && *devs; devs++) {
+	pointer opt1 = NULL, opt2 = NULL;
+        indp = *devs;
+	if (indp->commonOptions &&
+	    xf86CheckBoolOption(indp->commonOptions, "CorePointer", FALSE)) {
+	    opt1 = indp->commonOptions;
+	}
+	if (indp->extraOptions &&
+	    xf86CheckBoolOption(indp->extraOptions, "CorePointer", FALSE)) {
+	    opt2 = indp->extraOptions;
+	}
+	if (opt1 || opt2) {
+	    if (!corePointer) {
+		corePointer = indp;
+	    } else {
+		if (opt1)
+		    xf86ReplaceBoolOption(opt1, "CorePointer", FALSE);
+		if (opt2)
+		    xf86ReplaceBoolOption(opt2, "CorePointer", FALSE);
+		xf86Msg(X_WARNING, "Duplicate core pointer devices.  "
+			"Removing core pointer attribute from \"%s\"\n",
+			indp->identifier);
+	    }
+	}
+	opt1 = opt2 = NULL;
+	if (indp->commonOptions &&
+	    xf86CheckBoolOption(indp->commonOptions, "CoreKeyboard", FALSE)) {
+	    opt1 = indp->commonOptions;
+	}
+	if (indp->extraOptions &&
+	    xf86CheckBoolOption(indp->extraOptions, "CoreKeyboard", FALSE)) {
+	    opt2 = indp->extraOptions;
+	}
+	if (opt1 || opt2) {
+	    if (!coreKeyboard) {
+		coreKeyboard = indp;
+	    } else {
+		if (opt1)
+		    xf86ReplaceBoolOption(opt1, "CoreKeyboard", FALSE);
+		if (opt2)
+		    xf86ReplaceBoolOption(opt2, "CoreKeyboard", FALSE);
+		xf86Msg(X_WARNING, "Duplicate core keyboard devices.  "
+			"Removing core keyboard attribute from \"%s\"\n",
+			indp->identifier);
+	    }
+	}
+	count++;
+    }
+
+    confInput = NULL;
+
+    /* 1. Check for the -pointer command line option. */
+    if (xf86PointerName) {
+	confInput = xf86findInput(xf86PointerName,
+				  xf86configptr->conf_input_lst);
+	if (!confInput) {
+	    xf86Msg(X_ERROR, "No InputDevice section called \"%s\"\n",
+		    xf86PointerName);
+	    return FALSE;
+	}
+	from = X_CMDLINE;
+	/*
+	 * If one was already specified in the ServerLayout, it needs to be
+	 * removed.
+	 */
+	if (corePointer) {
+	    for (devs = servlayoutp->inputs; devs && *devs; devs++)
+		if (*devs == corePointer)
+                {
+                    xfree(*devs);
+                    *devs = (IDevPtr)0x1; /* ensure we dont skip next loop*/
+		    break;
+                }
+	    for (; devs && *devs; devs++)
+		devs[0] = devs[1];
+	    count--;
+	}
+	corePointer = NULL;
+	foundPointer = TRUE;
+    }
+
+    /* 2. ServerLayout-specified core pointer. */
+    if (corePointer) {
+	foundPointer = TRUE;
+	from = X_CONFIG;
+    }
+
+    /* 3. First core pointer device. */
+    if (!foundPointer && (!xf86Info.allowEmptyInput || implicitLayout)) {
+	XF86ConfInputPtr p;
+
+	for (p = xf86configptr->conf_input_lst; p; p = p->list.next) {
+	    if (p->inp_option_lst &&
+		xf86CheckBoolOption(p->inp_option_lst, "CorePointer", FALSE)) {
+		confInput = p;
+		foundPointer = TRUE;
+		from = X_DEFAULT;
+		pointerMsg = "first core pointer device";
+		break;
+	    }
+	}
+    }
+
+    /* 4. First pointer with an allowed mouse driver. */
+    if (!foundPointer && !xf86Info.allowEmptyInput) {
+	const char **driver = mousedrivers;
+	confInput = xf86findInput(CONF_IMPLICIT_POINTER,
+				  xf86configptr->conf_input_lst);
+	while (*driver && !confInput) {
+	    confInput = xf86findInputByDriver(*driver,
+					      xf86configptr->conf_input_lst);
+	    driver++;
+	}
+	if (confInput) {
+	    foundPointer = TRUE;
+	    from = X_DEFAULT;
+	    pointerMsg = "first mouse device";
+	}
+    }
+
+    /* 5. Built-in default. */
+    if (!foundPointer && !xf86Info.allowEmptyInput) {
+	bzero(&defPtr, sizeof(defPtr));
+	defPtr.inp_identifier = strdup("<default pointer>");
+	defPtr.inp_driver = strdup("mouse");
+	confInput = &defPtr;
+	foundPointer = TRUE;
+	from = X_DEFAULT;
+	pointerMsg = "default mouse configuration";
+    }
+
+    /* Add the core pointer device to the layout, and set it to Core. */
+    if (foundPointer && confInput) {
+	foundPointer = configInput(&Pointer, confInput, from);
+        if (foundPointer) {
+	    count++;
+	    devs = xnfrealloc(servlayoutp->inputs,
+			      (count + 1) * sizeof(IDevPtr));
+            devs[count - 1] = xnfalloc(sizeof(IDevRec));
+	    *devs[count - 1] = Pointer;
+	    devs[count - 1]->extraOptions =
+				xf86addNewOption(NULL, xnfstrdup("CorePointer"), NULL);
+	    devs[count] = NULL;
+	    servlayoutp->inputs = devs;
+	}
+    }
+
+    if (!foundPointer) {
+	if (!xf86Info.allowEmptyInput) {
+	    /* This shouldn't happen. */
+	    xf86Msg(X_ERROR, "Cannot locate a core pointer device.\n");
+	    return FALSE;
+	} else {
+	    xf86Msg(X_INFO, "Cannot locate a core pointer device.\n");
+	}
+    }
+
+    /*
+     * always synthesize a 'mouse' section configured to send core
+     * events, unless a 'void' section is found, in which case the user
+     * probably wants to run footless.
+     *
+     * If you're using an evdev keyboard and expect a default mouse
+     * section ... deal.
+     */
+    for (devs = servlayoutp->inputs; devs && *devs; devs++) {
+	const char **driver = mousedrivers;
+	while(*driver) {
+	    if (!strcmp((*devs)->driver, *driver)) {
+		found = 1;
+		break;
+	    }
+	    driver++;
+	}
+    }
+    if (!found && !xf86Info.allowEmptyInput) {
+	xf86Msg(X_INFO, "No default mouse found, adding one\n");
+	bzero(&defPtr, sizeof(defPtr));
+	defPtr.inp_identifier = strdup("<default pointer>");
+	defPtr.inp_driver = strdup("mouse");
+	confInput = &defPtr;
+	foundPointer = configInput(&Pointer, confInput, from);
+        if (foundPointer) {
+	    count++;
+	    devs = xnfrealloc(servlayoutp->inputs,
+			      (count + 1) * sizeof(IDevPtr));
+            devs[count - 1] = xnfalloc(sizeof(IDevRec));
+	    *devs[count - 1] = Pointer;
+	    devs[count - 1]->extraOptions =
+				xf86addNewOption(NULL, xnfstrdup("AlwaysCore"), NULL);
+	    devs[count] = NULL;
+	    servlayoutp->inputs = devs;
+	}
+    }
+
+    confInput = NULL;
+
+    /* 1. Check for the -keyboard command line option. */
+    if (xf86KeyboardName) {
+	confInput = xf86findInput(xf86KeyboardName,
+				  xf86configptr->conf_input_lst);
+	if (!confInput) {
+	    xf86Msg(X_ERROR, "No InputDevice section called \"%s\"\n",
+		    xf86KeyboardName);
+	    return FALSE;
+	}
+	from = X_CMDLINE;
+	/*
+	 * If one was already specified in the ServerLayout, it needs to be
+	 * removed.
+	 */
+	if (coreKeyboard) {
+	    for (devs = servlayoutp->inputs; devs && *devs; devs++)
+		if (*devs == coreKeyboard)
+                {
+                    xfree(*devs);
+                    *devs = (IDevPtr)0x1; /* ensure we dont skip next loop */
+		    break;
+                }
+	    for (; devs && *devs; devs++)
+		devs[0] = devs[1];
+	    count--;
+	}
+	coreKeyboard = NULL;
+	foundKeyboard = TRUE;
+    }
+
+    /* 2. ServerLayout-specified core keyboard. */
+    if (coreKeyboard) {
+	foundKeyboard = TRUE;
+	from = X_CONFIG;
+    }
+
+    /* 3. First core keyboard device. */
+    if (!foundKeyboard && (!xf86Info.allowEmptyInput || implicitLayout)) {
+	XF86ConfInputPtr p;
+
+	for (p = xf86configptr->conf_input_lst; p; p = p->list.next) {
+	    if (p->inp_option_lst &&
+		xf86CheckBoolOption(p->inp_option_lst, "CoreKeyboard", FALSE)) {
+		confInput = p;
+		foundKeyboard = TRUE;
+		from = X_DEFAULT;
+		keyboardMsg = "first core keyboard device";
+		break;
+	    }
+	}
+    }
+
+    /* 4. First keyboard with 'keyboard' or 'kbd' as the driver. */
+    if (!foundKeyboard && !xf86Info.allowEmptyInput) {
+	confInput = xf86findInput(CONF_IMPLICIT_KEYBOARD,
+				  xf86configptr->conf_input_lst);
+	if (!confInput) {
+	    confInput = xf86findInputByDriver("kbd",
+					      xf86configptr->conf_input_lst);
+	}
+	if (confInput) {
+	    foundKeyboard = TRUE;
+	    from = X_DEFAULT;
+	    keyboardMsg = "first keyboard device";
+	}
+    }
+
+    /* 5. Built-in default. */
+    if (!foundKeyboard && !xf86Info.allowEmptyInput) {
+	bzero(&defKbd, sizeof(defKbd));
+	defKbd.inp_identifier = strdup("<default keyboard>");
+	defKbd.inp_driver = strdup("kbd");
+	confInput = &defKbd;
+	foundKeyboard = TRUE;
+	keyboardMsg = "default keyboard configuration";
+	from = X_DEFAULT;
+    }
+
+    /* Add the core keyboard device to the layout, and set it to Core. */
+    if (foundKeyboard && confInput) {
+	foundKeyboard = configInput(&Keyboard, confInput, from);
+        if (foundKeyboard) {
+	    count++;
+	    devs = xnfrealloc(servlayoutp->inputs,
+			      (count + 1) * sizeof(IDevPtr));
+            devs[count - 1] = xnfalloc(sizeof(IDevRec));
+	    *devs[count - 1] = Keyboard;
+	    devs[count - 1]->extraOptions =
+				xf86addNewOption(NULL, xnfstrdup("CoreKeyboard"), NULL);
+	    devs[count] = NULL;
+	    servlayoutp->inputs = devs;
+	}
+    }
+
+    if (!foundKeyboard) {
+	if (!xf86Info.allowEmptyInput) {
+		/* This shouldn't happen. */
+		xf86Msg(X_ERROR, "Cannot locate a core keyboard device.\n");
+		return FALSE;
+	} else {
+		xf86Msg(X_INFO, "Cannot locate a core keyboard device.\n");
+	}
+    }
+
+    if (pointerMsg) {
+	if (implicitLayout)
+	    xf86Msg(X_DEFAULT, "No Layout section. Using the %s.\n",
+	            pointerMsg);
+	else
+	    xf86Msg(X_DEFAULT, "The core pointer device wasn't specified "
+	            "explicitly in the layout.\n"
+	            "\tUsing the %s.\n", pointerMsg);
+    }
+
+    if (keyboardMsg) {
+	if (implicitLayout)
+	    xf86Msg(X_DEFAULT, "No Layout section. Using the %s.\n",
+	            keyboardMsg);
+	else
+	    xf86Msg(X_DEFAULT, "The core keyboard device wasn't specified "
+	            "explicitly in the layout.\n"
+	            "\tUsing the %s.\n", keyboardMsg);
+    }
+
+    if (xf86Info.allowEmptyInput && !(foundPointer && foundKeyboard)) {
+#ifdef CONFIG_HAL
+	xf86Msg(X_INFO, "The server relies on HAL to provide the list of "
+	                "input devices.\n\tIf no devices become available, "
+	                "reconfigure HAL or disable AutoAddDevices.\n");
+#else
+	xf86Msg(X_INFO, "HAL is disabled and no input devices were configured.\n"
+			"\tTry disabling AllowEmptyInput.\n");
+#endif
+    }
+
+    return TRUE;
+}
+
+typedef enum {
+    LAYOUT_ISOLATEDEVICE,
+    LAYOUT_SINGLECARD
+} LayoutValues;
+
+static OptionInfoRec LayoutOptions[] = {
+  { LAYOUT_ISOLATEDEVICE,      "IsolateDevice",        OPTV_STRING,
+       {0}, FALSE },
+  { LAYOUT_SINGLECARD,         "SingleCard",           OPTV_BOOLEAN,
+       {0}, FALSE },
+  { -1,                                NULL,                   OPTV_NONE,
+       {0}, FALSE },
+};
+
+/*
+ * figure out which layout is active, which screens are used in that layout,
+ * which drivers and monitors are used in these screens
+ */
+static Bool
+configLayout(serverLayoutPtr servlayoutp, XF86ConfLayoutPtr conf_layout,
+	     char *default_layout)
+{
+    XF86ConfAdjacencyPtr adjp;
+    XF86ConfInactivePtr idp;
+    XF86ConfInputrefPtr irp;
+    int count = 0;
+    int scrnum;
+    XF86ConfLayoutPtr l;
+    MessageType from;
+    screenLayoutPtr slp;
+    GDevPtr gdp;
+    IDevPtr* indp;
+    int i = 0, j;
+
+    if (!servlayoutp)
+	return FALSE;
+
+    /*
+     * which layout section is the active one?
+     *
+     * If there is a -layout command line option, use that one, otherwise
+     * pick the first one.
+     */
+    from = X_DEFAULT;
+    if (xf86LayoutName != NULL)
+	from = X_CMDLINE;
+    else if (default_layout) {
+	xf86LayoutName = default_layout;
+	from = X_CONFIG;
+    }
+    if (xf86LayoutName != NULL) {
+	if ((l = xf86findLayout(xf86LayoutName, conf_layout)) == NULL) {
+	    xf86Msg(X_ERROR, "No ServerLayout section called \"%s\"\n",
+		    xf86LayoutName);
+	    return FALSE;
+	}
+	conf_layout = l;
+    }
+    xf86Msg(from, "ServerLayout \"%s\"\n", conf_layout->lay_identifier);
+    adjp = conf_layout->lay_adjacency_lst;
+
+    /*
+     * we know that each screen is referenced exactly once on the left side
+     * of a layout statement in the Layout section. So to allocate the right
+     * size for the array we do a quick walk of the list to figure out how
+     * many sections we have
+     */
+    while (adjp) {
+        count++;
+        adjp = (XF86ConfAdjacencyPtr)adjp->list.next;
+    }
+
+    DebugF("Found %d screens in the layout section %s",
+           count, conf_layout->lay_identifier);
+    if (!count) /* alloc enough storage even if no screen is specified */
+        count = 1;
+
+    slp = xnfcalloc(1, (count + 1) * sizeof(screenLayoutRec));
+    slp[count].screen = NULL;
+    /*
+     * now that we have storage, loop over the list again and fill in our
+     * data structure; at this point we do not fill in the adjacency
+     * information as it is not clear if we need it at all
+     */
+    adjp = conf_layout->lay_adjacency_lst;
+    count = 0;
+    while (adjp) {
+        slp[count].screen = xnfcalloc(1, sizeof(confScreenRec));
+	if (adjp->adj_scrnum < 0)
+	    scrnum = count;
+	else
+	    scrnum = adjp->adj_scrnum;
+	if (!configScreen(slp[count].screen, adjp->adj_screen, scrnum,
+			  X_CONFIG)) {
+	    xfree(slp);
+	    return FALSE;
+	}
+	slp[count].x = adjp->adj_x;
+	slp[count].y = adjp->adj_y;
+	slp[count].refname = adjp->adj_refscreen;
+	switch (adjp->adj_where) {
+	case CONF_ADJ_OBSOLETE:
+	    slp[count].where = PosObsolete;
+	    slp[count].topname = adjp->adj_top_str;
+	    slp[count].bottomname = adjp->adj_bottom_str;
+	    slp[count].leftname = adjp->adj_left_str;
+	    slp[count].rightname = adjp->adj_right_str;
+	    break;
+	case CONF_ADJ_ABSOLUTE:
+	    slp[count].where = PosAbsolute;
+	    break;
+	case CONF_ADJ_RIGHTOF:
+	    slp[count].where = PosRightOf;
+	    break;
+	case CONF_ADJ_LEFTOF:
+	    slp[count].where = PosLeftOf;
+	    break;
+	case CONF_ADJ_ABOVE:
+	    slp[count].where = PosAbove;
+	    break;
+	case CONF_ADJ_BELOW:
+	    slp[count].where = PosBelow;
+	    break;
+	case CONF_ADJ_RELATIVE:
+	    slp[count].where = PosRelative;
+	    break;
+	}
+        count++;
+        adjp = (XF86ConfAdjacencyPtr)adjp->list.next;
+    }
+
+    /* No screen was specified in the layout. take the first one from the
+     * config file, or - if it is NULL - configScreen autogenerates one for
+     * us */
+    if (!count)
+    {
+        slp[0].screen = xnfcalloc(1, sizeof(confScreenRec));
+	if (!configScreen(slp[0].screen, xf86configptr->conf_screen_lst,
+                          0, X_CONFIG)) {
+	    xfree(slp[0].screen);
+	    xfree(slp);
+	    return FALSE;
+	}
+    }
+
+    /* XXX Need to tie down the upper left screen. */
+
+    /* Fill in the refscreen and top/bottom/left/right values */
+    for (i = 0; i < count; i++) {
+	for (j = 0; j < count; j++) {
+	    if (slp[i].refname &&
+		strcmp(slp[i].refname, slp[j].screen->id) == 0) {
+		slp[i].refscreen = slp[j].screen;
+	    }
+	    if (slp[i].topname &&
+		strcmp(slp[i].topname, slp[j].screen->id) == 0) {
+		slp[i].top = slp[j].screen;
+	    }
+	    if (slp[i].bottomname &&
+		strcmp(slp[i].bottomname, slp[j].screen->id) == 0) {
+		slp[i].bottom = slp[j].screen;
+	    }
+	    if (slp[i].leftname &&
+		strcmp(slp[i].leftname, slp[j].screen->id) == 0) {
+		slp[i].left = slp[j].screen;
+	    }
+	    if (slp[i].rightname &&
+		strcmp(slp[i].rightname, slp[j].screen->id) == 0) {
+		slp[i].right = slp[j].screen;
+	    }
+	}
+	if (slp[i].where != PosObsolete
+	    && slp[i].where != PosAbsolute
+	    && !slp[i].refscreen) {
+	    xf86Msg(X_ERROR,"Screen %s doesn't exist: deleting placement\n",
+		     slp[i].refname);
+	    slp[i].where = PosAbsolute;
+	    slp[i].x = 0;
+	    slp[i].y = 0;
+	}
+    }
+
+#ifdef LAYOUT_DEBUG
+    ErrorF("Layout \"%s\"\n", conf_layout->lay_identifier);
+    for (i = 0; i < count; i++) {
+	ErrorF("Screen: \"%s\" (%d):\n", slp[i].screen->id,
+	       slp[i].screen->screennum);
+	switch (slp[i].where) {
+	case PosObsolete:
+	    ErrorF("\tObsolete format: \"%s\" \"%s\" \"%s\" \"%s\"\n",
+		   slp[i].top, slp[i].bottom, slp[i].left, slp[i].right);
+	    break;
+	case PosAbsolute:
+	    if (slp[i].x == -1)
+		if (slp[i].screen->screennum == 0)
+		    ErrorF("\tImplicitly left-most\n");
+		else
+		    ErrorF("\tImplicitly right of screen %d\n",
+			   slp[i].screen->screennum - 1);
+	    else
+		ErrorF("\t%d %d\n", slp[i].x, slp[i].y);
+	    break;
+	case PosRightOf:
+	    ErrorF("\tRight of \"%s\"\n", slp[i].refscreen->id);
+	    break;
+	case PosLeftOf:
+	    ErrorF("\tLeft of \"%s\"\n", slp[i].refscreen->id);
+	    break;
+	case PosAbove:
+	    ErrorF("\tAbove \"%s\"\n", slp[i].refscreen->id);
+	    break;
+	case PosBelow:
+	    ErrorF("\tBelow \"%s\"\n", slp[i].refscreen->id);
+	    break;
+	case PosRelative:
+	    ErrorF("\t%d %d relative to \"%s\"\n", slp[i].x, slp[i].y,
+		   slp[i].refscreen->id);
+	    break;
+	}
+    }
+#endif
+    /*
+     * Count the number of inactive devices.
+     */
+    count = 0;
+    idp = conf_layout->lay_inactive_lst;
+    while (idp) {
+        count++;
+        idp = (XF86ConfInactivePtr)idp->list.next;
+    }
+    DebugF("Found %d inactive devices in the layout section %s\n",
+           count, conf_layout->lay_identifier);
+    gdp = xnfalloc((count + 1) * sizeof(GDevRec));
+    gdp[count].identifier = NULL;
+    idp = conf_layout->lay_inactive_lst;
+    count = 0;
+    while (idp) {
+	if (!configDevice(&gdp[count], idp->inactive_device, FALSE)) {
+	    xfree(gdp);
+	    return FALSE;
+	}
+        count++;
+        idp = (XF86ConfInactivePtr)idp->list.next;
+    }
+    /*
+     * Count the number of input devices.
+     */
+    count = 0;
+    irp = conf_layout->lay_input_lst;
+    while (irp) {
+        count++;
+        irp = (XF86ConfInputrefPtr)irp->list.next;
+    }
+    DebugF("Found %d input devices in the layout section %s\n",
+           count, conf_layout->lay_identifier);
+    indp = xnfcalloc((count + 1), sizeof(IDevPtr));
+    indp[count] = NULL;
+    irp = conf_layout->lay_input_lst;
+    count = 0;
+    while (irp) {
+        indp[count] = xnfalloc(sizeof(IDevRec));
+	if (!configInput(indp[count], irp->iref_inputdev, X_CONFIG)) {
+            while(count--) 
+                xfree(indp[count]);
+            xfree(indp);
+            return FALSE;
+	}
+	indp[count]->extraOptions = irp->iref_option_lst;
+        count++;
+        irp = (XF86ConfInputrefPtr)irp->list.next;
+    }
+    servlayoutp->id = conf_layout->lay_identifier;
+    servlayoutp->screens = slp;
+    servlayoutp->inactives = gdp;
+    servlayoutp->inputs = indp;
+    servlayoutp->options = conf_layout->lay_option_lst;
+    from = X_DEFAULT;
+
+    return TRUE;
+}
+
+/*
+ * No layout section, so find the first Screen section and set that up as
+ * the only active screen.
+ */
+static Bool
+configImpliedLayout(serverLayoutPtr servlayoutp, XF86ConfScreenPtr conf_screen)
+{
+    MessageType from;
+    XF86ConfScreenPtr s;
+    screenLayoutPtr slp;
+    IDevPtr *indp;
+
+    if (!servlayoutp)
+	return FALSE;
+
+    /*
+     * which screen section is the active one?
+     *
+     * If there is a -screen option, use that one, otherwise use the first
+     * one.
+     */
+
+    from = X_CONFIG;
+    if (xf86ScreenName != NULL) {
+	if ((s = xf86findScreen(xf86ScreenName, conf_screen)) == NULL) {
+	    xf86Msg(X_ERROR, "No Screen section called \"%s\"\n",
+		    xf86ScreenName);
+	    return FALSE;
+	}
+	conf_screen = s;
+	from = X_CMDLINE;
+    }
+
+    /* We have exactly one screen */
+
+    slp = xnfcalloc(1, 2 * sizeof(screenLayoutRec));
+    slp[0].screen = xnfcalloc(1, sizeof(confScreenRec));
+    slp[1].screen = NULL;
+    if (!configScreen(slp[0].screen, conf_screen, 0, from)) {
+	xfree(slp);
+	return FALSE;
+    }
+    servlayoutp->id = "(implicit)";
+    servlayoutp->screens = slp;
+    servlayoutp->inactives = xnfcalloc(1, sizeof(GDevRec));
+    servlayoutp->options = NULL;
+    /* Set up an empty input device list, then look for some core devices. */
+    indp = xnfalloc(sizeof(IDevPtr));
+    *indp = NULL;
+    servlayoutp->inputs = indp;
+
+    return TRUE;
+}
+
+static Bool
+configXvAdaptor(confXvAdaptorPtr adaptor, XF86ConfVideoAdaptorPtr conf_adaptor)
+{
+    int count = 0;
+    XF86ConfVideoPortPtr conf_port;
+
+    xf86Msg(X_CONFIG, "|   |-->VideoAdaptor \"%s\"\n",
+	    conf_adaptor->va_identifier);
+    adaptor->identifier = conf_adaptor->va_identifier;
+    adaptor->options = conf_adaptor->va_option_lst;
+    if (conf_adaptor->va_busid || conf_adaptor->va_driver) {
+	xf86Msg(X_CONFIG, "|   | Unsupported device type, skipping entry\n");
+	return FALSE;
+    }
+
+    /*
+     * figure out how many videoport subsections there are and fill them in
+     */
+    conf_port = conf_adaptor->va_port_lst;
+    while(conf_port) {
+        count++;
+        conf_port = (XF86ConfVideoPortPtr)conf_port->list.next;
+    }
+    adaptor->ports = xnfalloc((count) * sizeof(confXvPortRec));
+    adaptor->numports = count;
+    count = 0;
+    conf_port = conf_adaptor->va_port_lst;
+    while(conf_port) {
+	adaptor->ports[count].identifier = conf_port->vp_identifier;
+	adaptor->ports[count].options = conf_port->vp_option_lst;
+        count++;
+        conf_port = (XF86ConfVideoPortPtr)conf_port->list.next;
+    }
+
+    return TRUE;
+}
+
+static Bool
+configScreen(confScreenPtr screenp, XF86ConfScreenPtr conf_screen, int scrnum,
+	     MessageType from)
+{
+    int count = 0;
+    XF86ConfDisplayPtr dispptr;
+    XF86ConfAdaptorLinkPtr conf_adaptor;
+    Bool defaultMonitor = FALSE;
+
+    if (!conf_screen) {
+        conf_screen = xnfcalloc(1, sizeof(XF86ConfScreenRec));
+        conf_screen->scrn_identifier = "Default Screen Section";
+        xf86Msg(X_DEFAULT, "No screen section available. Using defaults.\n");
+    }
+
+    xf86Msg(from, "|-->Screen \"%s\" (%d)\n", conf_screen->scrn_identifier,
+	    scrnum);
+    /*
+     * now we fill in the elements of the screen
+     */
+    screenp->id         = conf_screen->scrn_identifier;
+    screenp->screennum  = scrnum;
+    screenp->defaultdepth = conf_screen->scrn_defaultdepth;
+    screenp->defaultbpp = conf_screen->scrn_defaultbpp;
+    screenp->defaultfbbpp = conf_screen->scrn_defaultfbbpp;
+    screenp->monitor    = xnfcalloc(1, sizeof(MonRec));
+    /* If no monitor is specified, create a default one. */
+    if (!conf_screen->scrn_monitor) {
+	XF86ConfMonitorRec defMon;
+
+	bzero(&defMon, sizeof(defMon));
+	defMon.mon_identifier = "<default monitor>";
+	if (!configMonitor(screenp->monitor, &defMon))
+	    return FALSE;
+	defaultMonitor = TRUE;
+    } else {
+	if (!configMonitor(screenp->monitor,conf_screen->scrn_monitor))
+	    return FALSE;
+    }
+    /* Configure the device. If there isn't one configured, attach to the
+     * first inactive one that we can configure. If there's none that work,
+     * set it to NULL so that the section can be autoconfigured later */
+    screenp->device     = xnfcalloc(1, sizeof(GDevRec));
+    if ((!conf_screen->scrn_device) && (xf86configptr->conf_device_lst)) {
+        conf_screen->scrn_device = xf86configptr->conf_device_lst;
+	xf86Msg(X_DEFAULT, "No device specified for screen \"%s\".\n"
+		"\tUsing the first device section listed.\n", screenp->id);
+    }
+    if (configDevice(screenp->device,conf_screen->scrn_device, TRUE)) {
+        screenp->device->myScreenSection = screenp;
+    } else {
+        screenp->device = NULL;
+    }
+    screenp->options = conf_screen->scrn_option_lst;
+    
+    /*
+     * figure out how many display subsections there are and fill them in
+     */
+    dispptr = conf_screen->scrn_display_lst;
+    while(dispptr) {
+        count++;
+        dispptr = (XF86ConfDisplayPtr)dispptr->list.next;
+    }
+    screenp->displays   = xnfalloc((count) * sizeof(DispRec));
+    screenp->numdisplays = count;
+    
+    /* Fill in the default Virtual size, if any */
+    if (conf_screen->scrn_virtualX && conf_screen->scrn_virtualY) {
+	for (count = 0, dispptr = conf_screen->scrn_display_lst;
+	     dispptr;
+	     dispptr = (XF86ConfDisplayPtr)dispptr->list.next, count++) {
+	    screenp->displays[count].virtualX = conf_screen->scrn_virtualX;
+	    screenp->displays[count].virtualY = conf_screen->scrn_virtualY;
+	}
+    }
+
+    /* Now do the per-Display Virtual sizes */
+    count = 0;
+    dispptr = conf_screen->scrn_display_lst;
+    while(dispptr) {
+        configDisplay(&(screenp->displays[count]),dispptr);
+        count++;
+        dispptr = (XF86ConfDisplayPtr)dispptr->list.next;
+    }
+
+    /*
+     * figure out how many videoadaptor references there are and fill them in
+     */
+    conf_adaptor = conf_screen->scrn_adaptor_lst;
+    while(conf_adaptor) {
+        count++;
+        conf_adaptor = (XF86ConfAdaptorLinkPtr)conf_adaptor->list.next;
+    }
+    screenp->xvadaptors = xnfalloc((count) * sizeof(confXvAdaptorRec));
+    screenp->numxvadaptors = 0;
+    conf_adaptor = conf_screen->scrn_adaptor_lst;
+    while(conf_adaptor) {
+        if (configXvAdaptor(&(screenp->xvadaptors[screenp->numxvadaptors]),
+			    conf_adaptor->al_adaptor))
+    	    screenp->numxvadaptors++;
+        conf_adaptor = (XF86ConfAdaptorLinkPtr)conf_adaptor->list.next;
+    }
+
+    if (defaultMonitor) {
+	xf86Msg(X_DEFAULT, "No monitor specified for screen \"%s\".\n"
+		"\tUsing a default monitor configuration.\n", screenp->id);
+    }
+    return TRUE;
+}
+
+typedef enum {
+    MON_REDUCEDBLANKING,
+    MON_MAX_PIX_CLOCK,
+} MonitorValues;
+
+static OptionInfoRec MonitorOptions[] = {
+  { MON_REDUCEDBLANKING,      "ReducedBlanking",        OPTV_BOOLEAN,
+       {0}, FALSE },
+  { MON_MAX_PIX_CLOCK,	      "MaxPixClock",		OPTV_FREQ,
+       {0}, FALSE },
+  { -1,                                NULL,                   OPTV_NONE,
+       {0}, FALSE },
+};
+
+static Bool
+configMonitor(MonPtr monitorp, XF86ConfMonitorPtr conf_monitor)
+{
+    int count;
+    DisplayModePtr mode,last = NULL;
+    XF86ConfModeLinePtr cmodep;
+    XF86ConfModesPtr modes;
+    XF86ConfModesLinkPtr modeslnk = conf_monitor->mon_modes_sect_lst;
+    Gamma zeros = {0.0, 0.0, 0.0};
+    float badgamma = 0.0;
+    double maxPixClock;
+    
+    xf86Msg(X_CONFIG, "|   |-->Monitor \"%s\"\n",
+	    conf_monitor->mon_identifier);
+    monitorp->id = conf_monitor->mon_identifier;
+    monitorp->vendor = conf_monitor->mon_vendor;
+    monitorp->model = conf_monitor->mon_modelname;
+    monitorp->Modes = NULL;
+    monitorp->Last = NULL;
+    monitorp->gamma = zeros;
+    monitorp->widthmm = conf_monitor->mon_width;
+    monitorp->heightmm = conf_monitor->mon_height;
+    monitorp->reducedblanking = FALSE;
+    monitorp->maxPixClock = 0;
+    monitorp->options = conf_monitor->mon_option_lst;
+
+    /*
+     * fill in the monitor structure
+     */    
+    for( count = 0 ;
+	 count < conf_monitor->mon_n_hsync && count < MAX_HSYNC;
+	 count++) {
+        monitorp->hsync[count].hi = conf_monitor->mon_hsync[count].hi;
+        monitorp->hsync[count].lo = conf_monitor->mon_hsync[count].lo;
+    }
+    monitorp->nHsync = count;
+    for( count = 0 ;
+	 count < conf_monitor->mon_n_vrefresh && count < MAX_VREFRESH;
+	 count++) {
+        monitorp->vrefresh[count].hi = conf_monitor->mon_vrefresh[count].hi;
+        monitorp->vrefresh[count].lo = conf_monitor->mon_vrefresh[count].lo;
+    }
+    monitorp->nVrefresh = count;
+
+    /*
+     * first we collect the mode lines from the UseModes directive
+     */
+    while(modeslnk)
+    {
+        modes = xf86findModes (modeslnk->ml_modes_str, 
+			       xf86configptr->conf_modes_lst);
+	modeslnk->ml_modes = modes;
+	
+	    
+	/* now add the modes found in the modes
+	   section to the list of modes for this
+	   monitor unless it has been added before
+	   because we are reusing the same section 
+	   for another screen */
+	if (xf86itemNotSublist(
+			       (GenericListPtr)conf_monitor->mon_modeline_lst,
+			       (GenericListPtr)modes->mon_modeline_lst)) {
+	    conf_monitor->mon_modeline_lst = (XF86ConfModeLinePtr)
+	        xf86addListItem(
+				(GenericListPtr)conf_monitor->mon_modeline_lst,
+				(GenericListPtr)modes->mon_modeline_lst);
+	}
+	modeslnk = modeslnk->list.next;
+    }
+
+    /*
+     * we need to hook in the mode lines now
+     * here both data structures use lists, only our internal one
+     * is double linked
+     */
+    cmodep = conf_monitor->mon_modeline_lst;
+    while( cmodep ) {
+        mode = xnfcalloc(1, sizeof(DisplayModeRec));
+	mode->type       = 0;
+        mode->Clock      = cmodep->ml_clock;
+        mode->HDisplay   = cmodep->ml_hdisplay;
+        mode->HSyncStart = cmodep->ml_hsyncstart;
+        mode->HSyncEnd   = cmodep->ml_hsyncend;
+        mode->HTotal     = cmodep->ml_htotal;
+        mode->VDisplay   = cmodep->ml_vdisplay;
+        mode->VSyncStart = cmodep->ml_vsyncstart;
+        mode->VSyncEnd   = cmodep->ml_vsyncend;
+        mode->VTotal     = cmodep->ml_vtotal;
+        mode->Flags      = cmodep->ml_flags;
+        mode->HSkew      = cmodep->ml_hskew;
+        mode->VScan      = cmodep->ml_vscan;
+        mode->name       = xnfstrdup(cmodep->ml_identifier);
+        if( last ) {
+            mode->prev = last;
+            last->next = mode;
+        }
+        else {
+            /*
+             * this is the first mode
+             */
+            monitorp->Modes = mode;
+            mode->prev = NULL;
+        }
+        last = mode;
+        cmodep = (XF86ConfModeLinePtr)cmodep->list.next;
+    }
+    if(last){
+      last->next = NULL;
+    }
+    monitorp->Last = last;
+
+    /* add the (VESA) default modes */
+    if (! addDefaultModes(monitorp) )
+	return FALSE;
+
+    if (conf_monitor->mon_gamma_red > GAMMA_ZERO)
+	monitorp->gamma.red = conf_monitor->mon_gamma_red;
+    if (conf_monitor->mon_gamma_green > GAMMA_ZERO)
+	monitorp->gamma.green = conf_monitor->mon_gamma_green;
+    if (conf_monitor->mon_gamma_blue > GAMMA_ZERO)
+	monitorp->gamma.blue = conf_monitor->mon_gamma_blue;
+    
+    /* Check that the gamma values are within range */
+    if (monitorp->gamma.red > GAMMA_ZERO &&
+	(monitorp->gamma.red < GAMMA_MIN ||
+	 monitorp->gamma.red > GAMMA_MAX)) {
+	badgamma = monitorp->gamma.red;
+    } else if (monitorp->gamma.green > GAMMA_ZERO &&
+	(monitorp->gamma.green < GAMMA_MIN ||
+	 monitorp->gamma.green > GAMMA_MAX)) {
+	badgamma = monitorp->gamma.green;
+    } else if (monitorp->gamma.blue > GAMMA_ZERO &&
+	(monitorp->gamma.blue < GAMMA_MIN ||
+	 monitorp->gamma.blue > GAMMA_MAX)) {
+	badgamma = monitorp->gamma.blue;
+    }
+    if (badgamma > GAMMA_ZERO) {
+	xf86ConfigError("Gamma value %.f is out of range (%.2f - %.1f)\n",
+			badgamma, GAMMA_MIN, GAMMA_MAX);
+	    return FALSE;
+    }
+
+    xf86ProcessOptions(-1, monitorp->options, MonitorOptions);
+    xf86GetOptValBool(MonitorOptions, MON_REDUCEDBLANKING,
+                      &monitorp->reducedblanking);
+    if (xf86GetOptValFreq(MonitorOptions, MON_MAX_PIX_CLOCK, OPTUNITS_KHZ,
+			  &maxPixClock) == TRUE) {
+	monitorp->maxPixClock = (int) maxPixClock;
+    }
+	
+    return TRUE;
+}
+
+static int
+lookupVisual(const char *visname)
+{
+    int i;
+
+    if (!visname || !*visname)
+	return -1;
+
+    for (i = 0; i <= DirectColor; i++) {
+	if (!xf86nameCompare(visname, xf86VisualNames[i]))
+	    break;
+    }
+
+    if (i <= DirectColor)
+	return i;
+
+    return -1;
+}
+
+
+static Bool
+configDisplay(DispPtr displayp, XF86ConfDisplayPtr conf_display)
+{
+    int count = 0;
+    XF86ModePtr modep;
+    
+    displayp->frameX0           = conf_display->disp_frameX0;
+    displayp->frameY0           = conf_display->disp_frameY0;
+    displayp->virtualX          = conf_display->disp_virtualX;
+    displayp->virtualY          = conf_display->disp_virtualY;
+    displayp->depth             = conf_display->disp_depth;
+    displayp->fbbpp             = conf_display->disp_bpp;
+    displayp->weight.red        = conf_display->disp_weight.red;
+    displayp->weight.green      = conf_display->disp_weight.green;
+    displayp->weight.blue       = conf_display->disp_weight.blue;
+    displayp->blackColour.red   = conf_display->disp_black.red;
+    displayp->blackColour.green = conf_display->disp_black.green;
+    displayp->blackColour.blue  = conf_display->disp_black.blue;
+    displayp->whiteColour.red   = conf_display->disp_white.red;
+    displayp->whiteColour.green = conf_display->disp_white.green;
+    displayp->whiteColour.blue  = conf_display->disp_white.blue;
+    displayp->options           = conf_display->disp_option_lst;
+    if (conf_display->disp_visual) {
+	displayp->defaultVisual = lookupVisual(conf_display->disp_visual);
+	if (displayp->defaultVisual == -1) {
+	    xf86ConfigError("Invalid visual name: \"%s\"",
+			    conf_display->disp_visual);
+	    return FALSE;
+	}
+    } else {
+	displayp->defaultVisual = -1;
+    }
+	
+    /*
+     * now hook in the modes
+     */
+    modep = conf_display->disp_mode_lst;
+    while(modep) {
+        count++;
+        modep = (XF86ModePtr)modep->list.next;
+    }
+    displayp->modes = xnfalloc((count+1) * sizeof(char*));
+    modep = conf_display->disp_mode_lst;
+    count = 0;
+    while(modep) {
+        displayp->modes[count] = modep->mode_name;
+        count++;
+        modep = (XF86ModePtr)modep->list.next;
+    }
+    displayp->modes[count] = NULL;
+    
+    return TRUE;
+}
+
+static Bool
+configDevice(GDevPtr devicep, XF86ConfDevicePtr conf_device, Bool active)
+{
+    int i;
+
+    if (!conf_device) {
+        return FALSE;
+    }
+
+    if (active)
+	xf86Msg(X_CONFIG, "|   |-->Device \"%s\"\n",
+		conf_device->dev_identifier);
+    else
+	xf86Msg(X_CONFIG, "|-->Inactive Device \"%s\"\n",
+		conf_device->dev_identifier);
+
+    devicep->identifier = conf_device->dev_identifier;
+    devicep->vendor = conf_device->dev_vendor;
+    devicep->board = conf_device->dev_board;
+    devicep->chipset = conf_device->dev_chipset;
+    devicep->ramdac = conf_device->dev_ramdac;
+    devicep->driver = conf_device->dev_driver;
+    devicep->active = active;
+    devicep->videoRam = conf_device->dev_videoram;
+    devicep->BiosBase = conf_device->dev_bios_base;
+    devicep->MemBase = conf_device->dev_mem_base;
+    devicep->IOBase = conf_device->dev_io_base;
+    devicep->clockchip = conf_device->dev_clockchip;
+    devicep->busID = conf_device->dev_busid;
+    devicep->textClockFreq = conf_device->dev_textclockfreq;
+    devicep->chipID = conf_device->dev_chipid;
+    devicep->chipRev = conf_device->dev_chiprev;
+    devicep->options = conf_device->dev_option_lst;
+    devicep->irq = conf_device->dev_irq;
+    devicep->screen = conf_device->dev_screen;
+
+    for (i = 0; i < MAXDACSPEEDS; i++) {
+	if (i < CONF_MAXDACSPEEDS)
+            devicep->dacSpeeds[i] = conf_device->dev_dacSpeeds[i];
+	else
+	    devicep->dacSpeeds[i] = 0;
+    }
+    devicep->numclocks = conf_device->dev_clocks;
+    if (devicep->numclocks > MAXCLOCKS)
+	devicep->numclocks = MAXCLOCKS;
+    for (i = 0; i < devicep->numclocks; i++) {
+	devicep->clock[i] = conf_device->dev_clock[i];
+    }
+    devicep->claimed = FALSE;
+
+    return TRUE;
+}
+
+#ifdef XF86DRI
+static void
+configDRI(XF86ConfDRIPtr drip)
+{
+    int                count = 0;
+    XF86ConfBuffersPtr bufs;
+    int                i;
+    struct group       *grp;
+
+    xf86ConfigDRI.group      = -1;
+    xf86ConfigDRI.mode       = 0;
+    xf86ConfigDRI.bufs_count = 0;
+    xf86ConfigDRI.bufs       = NULL;
+
+    if (drip) {
+	if (drip->dri_group_name) {
+	    if ((grp = getgrnam(drip->dri_group_name)))
+		xf86ConfigDRI.group = grp->gr_gid;
+	} else {
+	    if (drip->dri_group >= 0)
+		xf86ConfigDRI.group = drip->dri_group;
+	}
+	xf86ConfigDRI.mode = drip->dri_mode;
+	for (bufs = drip->dri_buffers_lst; bufs; bufs = bufs->list.next)
+	    ++count;
+	
+	xf86ConfigDRI.bufs_count = count;
+	xf86ConfigDRI.bufs = xnfalloc(count * sizeof(*xf86ConfigDRI.bufs));
+	
+	for (i = 0, bufs = drip->dri_buffers_lst;
+	     i < count;
+	     i++, bufs = bufs->list.next) {
+	    
+	    xf86ConfigDRI.bufs[i].count = bufs->buf_count;
+	    xf86ConfigDRI.bufs[i].size  = bufs->buf_size;
+				/* FIXME: Flags not implemented.  These
+                                   could be used, for example, to specify a
+                                   contiguous block and/or write-combining
+                                   cache policy. */
+	    xf86ConfigDRI.bufs[i].flags = 0;
+	}
+    }
+}
+#endif
+
+static void
+configExtensions(XF86ConfExtensionsPtr conf_ext)
+{
+    XF86OptionPtr o;
+
+    if (conf_ext && conf_ext->ext_option_lst) {
+	for (o = conf_ext->ext_option_lst; o; o = xf86NextOption(o)) {
+	    char *name   = xf86OptionName(o);
+	    char *val    = xf86OptionValue(o);
+	    char *n;
+	    Bool  enable = TRUE;
+
+	    /* Handle "No<ExtensionName>" */
+	    n = xf86NormalizeName(name);
+	    if (strncmp(n, "no", 2) == 0) {
+		name += 2;
+		enable = FALSE;
+	    }
+
+	    if (!val ||
+		xf86NameCmp(val, "enable") == 0 ||
+		xf86NameCmp(val, "enabled") == 0 ||
+		xf86NameCmp(val, "on") == 0 ||
+		xf86NameCmp(val, "1") == 0 ||
+		xf86NameCmp(val, "yes") == 0 ||
+		xf86NameCmp(val, "true") == 0) {
+		/* NOTHING NEEDED -- enabling is handled below */
+	    } else if (xf86NameCmp(val, "disable") == 0 ||
+                       xf86NameCmp(val, "disabled") == 0 ||
+		       xf86NameCmp(val, "off") == 0 ||
+		       xf86NameCmp(val, "0") == 0 ||
+		       xf86NameCmp(val, "no") == 0 ||
+		       xf86NameCmp(val, "false") == 0) {
+		enable = !enable;
+	    } else {
+		xf86Msg(X_WARNING, "Ignoring unrecognized value \"%s\"\n", val);
+		xfree(n);
+		continue;
+	    }
+
+	    if (EnableDisableExtension(name, enable)) {
+		xf86Msg(X_CONFIG, "Extension \"%s\" is %s\n",
+			name, enable ? "enabled" : "disabled");
+	    } else {
+		xf86Msg(X_WARNING, "Ignoring unrecognized extension \"%s\"\n",
+                        name);
+	    }
+	    xfree(n);
+	}
+    }
+}
+
+static Bool
+configInput(IDevPtr inputp, XF86ConfInputPtr conf_input, MessageType from)
+{
+    xf86Msg(from, "|-->Input Device \"%s\"\n", conf_input->inp_identifier);
+    inputp->identifier = conf_input->inp_identifier;
+    inputp->driver = conf_input->inp_driver;
+    inputp->commonOptions = conf_input->inp_option_lst;
+    inputp->extraOptions = NULL;
+
+    return TRUE;
+}
+
+static Bool
+modeIsPresent(DisplayModePtr mode, MonPtr monitorp)
+{
+    DisplayModePtr knownmodes = monitorp->Modes;
+
+    /* all I can think of is a linear search... */
+    while(knownmodes != NULL)
+    {
+	if(!strcmp(mode->name, knownmodes->name) &&
+	   !(knownmodes->type & M_T_DEFAULT))
+	    return TRUE;
+	knownmodes = knownmodes->next;
+    }
+    return FALSE;
+}
+
+static Bool
+addDefaultModes(MonPtr monitorp)
+{
+    DisplayModePtr mode;
+    DisplayModePtr last = monitorp->Last;
+    int i = 0;
+
+    for (i = 0; i < xf86NumDefaultModes; i++)
+    {
+	mode = xf86DuplicateMode(&xf86DefaultModes[i]);
+	if (!modeIsPresent(mode, monitorp))
+	{
+	    monitorp->Modes = xf86ModesAdd(monitorp->Modes, mode);
+	    last = mode;
+	} else {
+	    xfree(mode);
+	}
+    }
+    monitorp->Last = last;
+
+    return TRUE;
+}
+
+static void
+checkInput(serverLayoutPtr layout, Bool implicit_layout) {
+    checkCoreInputDevices(layout, implicit_layout);
+
+    /* AllowEmptyInput and the "kbd" and "mouse" drivers are mutually
+     * exclusive. Trawl the list for mouse/kbd devices and disable them.
+     */
+    if (xf86Info.allowEmptyInput && layout->inputs)
+    {
+        IDevPtr *dev = layout->inputs;
+        BOOL warned = FALSE;
+
+        while(*dev)
+        {
+            if (strcmp((*dev)->driver, "kbd") == 0 ||
+                strcmp((*dev)->driver, "mouse") == 0 ||
+                strcmp((*dev)->driver, "vmmouse") == 0)
+            {
+                IDevPtr *current;
+                if (!warned)
+                {
+                    xf86Msg(X_WARNING, "AllowEmptyInput is on, devices using "
+                            "drivers 'kbd', 'mouse' or 'vmmouse' will be disabled.\n");
+                    warned = TRUE;
+                }
+
+                xf86Msg(X_WARNING, "Disabling %s\n", (*dev)->identifier);
+
+                current = dev;
+                xfree(*dev);
+
+                do {
+                    *current = *(current + 1);
+                    current++;
+                } while(*current);
+            } else
+                dev++;
+        }
+    }
+}
+
+/*
+ * load the config file and fill the global data structure
+ */
+ConfigStatus
+xf86HandleConfigFile(Bool autoconfig)
+{
+    const char *filename;
+    char *searchpath;
+    MessageType from = X_DEFAULT;
+    char *scanptr;
+    Bool singlecard = 0;
+    Bool implicit_layout = FALSE;
+
+    if (!autoconfig) {
+	if (getuid() == 0)
+	    searchpath = ROOT_CONFIGPATH;
+	else
+	    searchpath = USER_CONFIGPATH;
+
+	if (xf86ConfigFile)
+	    from = X_CMDLINE;
+
+	filename = xf86openConfigFile(searchpath, xf86ConfigFile, PROJECTROOT);
+	if (filename) {
+	    xf86MsgVerb(from, 0, "Using config file: \"%s\"\n", filename);
+	    xf86ConfigFile = xnfstrdup(filename);
+	} else {
+	    if (xf86ConfigFile)
+		xf86Msg(X_ERROR, "Unable to locate/open config file: \"%s\"\n",
+			xf86ConfigFile);
+	    return CONFIG_NOFILE;
+	}
+    }
+     
+    if ((xf86configptr = xf86readConfigFile ()) == NULL) {
+	xf86Msg(X_ERROR, "Problem parsing the config file\n");
+	return CONFIG_PARSE_ERROR;
+    }
+    xf86closeConfigFile ();
+
+    /* Initialise a few things. */
+
+    /*
+     * now we convert part of the information contained in the parser
+     * structures into our own structures.
+     * The important part here is to figure out which Screen Sections
+     * in the XF86Config file are active so that we can piece together
+     * the modes that we need later down the road.
+     * And while we are at it, we'll decode the rest of the stuff as well
+     */
+
+    /* First check if a layout section is present, and if it is valid. */
+
+    if (xf86configptr->conf_layout_lst == NULL || xf86ScreenName != NULL) {
+	if (xf86ScreenName == NULL) {
+	    xf86Msg(X_DEFAULT,
+		    "No Layout section.  Using the first Screen section.\n");
+	}
+	if (!configImpliedLayout(&xf86ConfigLayout,
+				 xf86configptr->conf_screen_lst)) {
+            xf86Msg(X_ERROR, "Unable to determine the screen layout\n");
+	    return CONFIG_PARSE_ERROR;
+	}
+	implicit_layout = TRUE;
+    } else {
+	if (xf86configptr->conf_flags != NULL) {
+	  char *dfltlayout = NULL;
+ 	  pointer optlist = xf86configptr->conf_flags->flg_option_lst;
+	
+	  if (optlist && xf86FindOption(optlist, "defaultserverlayout"))
+	    dfltlayout = xf86SetStrOption(optlist, "defaultserverlayout", NULL);
+	  if (!configLayout(&xf86ConfigLayout, xf86configptr->conf_layout_lst,
+			  dfltlayout)) {
+	    xf86Msg(X_ERROR, "Unable to determine the screen layout\n");
+	    return CONFIG_PARSE_ERROR;
+	  }
+	} else {
+	  if (!configLayout(&xf86ConfigLayout, xf86configptr->conf_layout_lst,
+			  NULL)) {
+	    xf86Msg(X_ERROR, "Unable to determine the screen layout\n");
+	    return CONFIG_PARSE_ERROR;
+	  }
+	}
+    }
+
+    xf86ProcessOptions(-1, xf86ConfigLayout.options, LayoutOptions);
+
+    if ((scanptr = xf86GetOptValString(LayoutOptions, LAYOUT_ISOLATEDEVICE))) {
+       ; /* IsolateDevice specified; overrides SingleCard */
+    } else {
+       xf86GetOptValBool(LayoutOptions, LAYOUT_SINGLECARD, &singlecard);
+       if (singlecard)
+           scanptr = xf86ConfigLayout.screens->screen->device->busID;
+    }
+    if (scanptr) {
+       int bus, device, func;
+       if (strncmp(scanptr, "PCI:", 4) != 0) {
+           xf86Msg(X_WARNING, "Bus types other than PCI not yet isolable.\n"
+                              "\tIgnoring IsolateDevice option.\n");
+       } else if (sscanf(scanptr, "PCI:%d:%d:%d", &bus, &device, &func) == 3) {
+           xf86IsolateDevice.domain = PCI_DOM_FROM_BUS(bus);
+           xf86IsolateDevice.bus = PCI_BUS_NO_DOMAIN(bus);
+           xf86IsolateDevice.dev = device;
+           xf86IsolateDevice.func = func;
+           xf86Msg(X_INFO,
+                   "Isolating PCI bus \"%d:%d:%d\"\n", bus, device, func);
+       }
+    }
+
+    /* Now process everything else */
+    if (!configServerFlags(xf86configptr->conf_flags,xf86ConfigLayout.options)){
+             ErrorF ("Problem when converting the config data structures\n");
+             return CONFIG_PARSE_ERROR;
+    }
+
+    configFiles(xf86configptr->conf_files);
+    configExtensions(xf86configptr->conf_extensions);
+#ifdef XF86DRI
+    configDRI(xf86configptr->conf_dri);
+#endif
+
+    checkInput(&xf86ConfigLayout, implicit_layout);
+
+    /*
+     * Handle some command line options that can override some of the
+     * ServerFlags settings.
+     */
+#ifdef XF86VIDMODE
+    if (xf86VidModeDisabled)
+	xf86Info.vidModeEnabled = FALSE;
+    if (xf86VidModeAllowNonLocal)
+	xf86Info.vidModeAllowNonLocal = TRUE;
+#endif
+
+    if (xf86AllowMouseOpenFail)
+	xf86Info.allowMouseOpenFail = TRUE;
+
+    return CONFIG_OK;
+}
+
+Bool
+xf86PathIsSafe(const char *path)
+{
+    return (xf86pathIsSafe(path) != 0);
+}
diff -Naur xorg-server-1.7.99.2/hw/xfree86/common/xf86Globals.c xorg-server-1.7.99.2.patch/hw/xfree86/common/xf86Globals.c
--- xorg-server-1.7.99.2/hw/xfree86/common/xf86Globals.c	2009-12-18 19:30:53.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/common/xf86Globals.c	2009-12-20 14:00:53.110988525 +0100
@@ -132,7 +132,7 @@
     .kbdCustomKeycodes          = FALSE,
     .disableRandR               = FALSE,
     .randRFrom                  = X_DEFAULT,
-#ifdef CONFIG_HAL
+#if defined(CONFIG_HAL) || defined(CONFIG_UDEV)
     .allowEmptyInput            = TRUE,
     .autoAddDevices             = TRUE,
     .autoEnableDevices          = TRUE
diff -Naur xorg-server-1.7.99.2/hw/xfree86/common/xf86Xinput.c xorg-server-1.7.99.2.patch/hw/xfree86/common/xf86Xinput.c
--- xorg-server-1.7.99.2/hw/xfree86/common/xf86Xinput.c	2009-11-04 17:25:50.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/common/xf86Xinput.c	2009-12-20 14:00:53.111986899 +0100
@@ -605,9 +605,9 @@
             }
         }
 
-        /* Right now, the only automatic config we know of is HAL. */
         if (strcmp(option->key, "_source") == 0 &&
-            strcmp(option->value, "server/hal") == 0) {
+            (strcmp(option->value, "server/hal") == 0 ||
+             strcmp(option->value, "server/udev") == 0)) {
             is_auto = 1;
             if (!xf86Info.autoAddDevices) {
                 rval = BadMatch;
diff -Naur xorg-server-1.7.99.2/hw/xfree86/ddc/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/ddc/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/ddc/Makefile.in	2009-12-19 08:06:09.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/ddc/Makefile.in	2009-12-20 14:08:21.518986480 +0100
@@ -291,6 +291,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/dixmods/extmod/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/dixmods/extmod/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/dixmods/extmod/Makefile.in	2009-12-19 08:06:09.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/dixmods/extmod/Makefile.in	2009-12-20 14:08:21.938986439 +0100
@@ -299,6 +299,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/dixmods/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/dixmods/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/dixmods/Makefile.in	2009-12-19 08:06:09.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/dixmods/Makefile.in	2009-12-20 14:08:21.762986536 +0100
@@ -379,6 +379,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/doc/devel/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/doc/devel/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/doc/devel/Makefile.in	2009-12-19 08:06:10.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/doc/devel/Makefile.in	2009-12-20 14:08:22.230986214 +0100
@@ -242,6 +242,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/doc/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/doc/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/doc/Makefile.in	2009-12-19 08:06:09.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/doc/Makefile.in	2009-12-20 14:08:22.094986822 +0100
@@ -279,6 +279,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/doc/man/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/doc/man/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/doc/man/Makefile.in	2009-12-19 08:06:10.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/doc/man/Makefile.in	2009-12-20 14:08:22.383986727 +0100
@@ -268,6 +268,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/doc/sgml/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/doc/sgml/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/doc/sgml/Makefile.in	2009-12-19 08:06:10.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/doc/sgml/Makefile.in	2009-12-20 14:08:22.540986599 +0100
@@ -262,6 +262,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/dri/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/dri/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/dri/Makefile.in	2009-12-19 08:06:10.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/dri/Makefile.in	2009-12-20 14:08:22.736986794 +0100
@@ -294,6 +294,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/dri2/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/dri2/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/dri2/Makefile.in	2009-12-19 08:06:10.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/dri2/Makefile.in	2009-12-20 14:08:22.931986310 +0100
@@ -293,6 +293,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/exa/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/exa/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/exa/Makefile.in	2009-12-19 08:06:10.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/exa/Makefile.in	2009-12-20 14:08:23.131986774 +0100
@@ -297,6 +297,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/fbdevhw/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/fbdevhw/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/fbdevhw/Makefile.in	2009-12-19 08:06:10.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/fbdevhw/Makefile.in	2009-12-20 14:08:23.314986396 +0100
@@ -302,6 +302,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/i2c/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/i2c/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/i2c/Makefile.in	2009-12-19 08:06:11.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/i2c/Makefile.in	2009-12-20 14:08:23.537986878 +0100
@@ -343,6 +343,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/int10/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/int10/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/int10/Makefile.in	2009-12-19 08:06:11.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/int10/Makefile.in	2009-12-20 14:08:23.736986663 +0100
@@ -307,6 +307,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/loader/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/loader/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/loader/Makefile.in	2009-12-19 08:06:11.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/loader/Makefile.in	2009-12-20 14:08:23.909986488 +0100
@@ -267,6 +267,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/Makefile.in	2009-12-19 08:06:09.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/Makefile.in	2009-12-20 14:08:21.156986665 +0100
@@ -325,6 +325,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/modes/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/modes/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/modes/Makefile.in	2009-12-19 08:06:11.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/modes/Makefile.in	2009-12-20 14:08:24.116986878 +0100
@@ -297,6 +297,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/os-support/bsd/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/os-support/bsd/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/os-support/bsd/Makefile.in	2009-12-19 08:06:11.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/os-support/bsd/Makefile.in	2009-12-20 14:08:24.576986717 +0100
@@ -291,6 +291,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/os-support/bus/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/os-support/bus/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/os-support/bus/Makefile.in	2009-12-19 08:06:11.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/os-support/bus/Makefile.in	2009-12-20 14:08:24.758986498 +0100
@@ -299,6 +299,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/os-support/hurd/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/os-support/hurd/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/os-support/hurd/Makefile.in	2009-12-19 08:06:12.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/os-support/hurd/Makefile.in	2009-12-20 14:08:24.971986555 +0100
@@ -267,6 +267,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/os-support/linux/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/os-support/linux/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/os-support/linux/Makefile.in	2009-12-19 08:06:12.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/os-support/linux/Makefile.in	2009-12-20 14:08:25.223986237 +0100
@@ -292,6 +292,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/os-support/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/os-support/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/os-support/Makefile.in	2009-12-19 08:06:11.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/os-support/Makefile.in	2009-12-20 14:08:24.308862068 +0100
@@ -328,6 +328,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/os-support/misc/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/os-support/misc/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/os-support/misc/Makefile.in	2009-12-19 08:06:12.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/os-support/misc/Makefile.in	2009-12-20 14:08:25.392986143 +0100
@@ -265,6 +265,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/os-support/sco/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/os-support/sco/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/os-support/sco/Makefile.in	2009-12-19 08:06:12.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/os-support/sco/Makefile.in	2009-12-20 14:08:25.541986807 +0100
@@ -239,6 +239,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/os-support/solaris/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/os-support/solaris/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/os-support/solaris/Makefile.in	2009-12-19 08:06:12.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/os-support/solaris/Makefile.in	2009-12-20 14:08:25.779986983 +0100
@@ -314,6 +314,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/os-support/sysv/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/os-support/sysv/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/os-support/sysv/Makefile.in	2009-12-19 08:06:12.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/os-support/sysv/Makefile.in	2009-12-20 14:08:25.926986709 +0100
@@ -239,6 +239,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/parser/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/parser/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/parser/Makefile.in	2009-12-19 08:06:13.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/parser/Makefile.in	2009-12-20 14:08:26.248986498 +0100
@@ -322,6 +322,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/ramdac/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/ramdac/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/ramdac/Makefile.in	2009-12-19 08:06:13.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/ramdac/Makefile.in	2009-12-20 14:08:26.434987035 +0100
@@ -291,6 +291,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/shadowfb/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/shadowfb/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/shadowfb/Makefile.in	2009-12-19 08:06:13.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/shadowfb/Makefile.in	2009-12-20 14:08:26.613986878 +0100
@@ -294,6 +294,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/utils/cvt/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/utils/cvt/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/utils/cvt/Makefile.in	2009-12-19 08:06:13.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/utils/cvt/Makefile.in	2009-12-20 14:08:26.964986285 +0100
@@ -321,6 +321,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/utils/gtf/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/utils/gtf/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/utils/gtf/Makefile.in	2009-12-19 08:06:13.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/utils/gtf/Makefile.in	2009-12-20 14:08:27.172986584 +0100
@@ -320,6 +320,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/utils/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/utils/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/utils/Makefile.in	2009-12-19 08:06:13.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/utils/Makefile.in	2009-12-20 14:08:26.769986490 +0100
@@ -279,6 +279,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/vbe/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/vbe/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/vbe/Makefile.in	2009-12-19 08:06:14.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/vbe/Makefile.in	2009-12-20 14:08:27.353986594 +0100
@@ -293,6 +293,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/vgahw/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/vgahw/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/vgahw/Makefile.in	2009-12-19 08:06:14.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/vgahw/Makefile.in	2009-12-20 14:08:27.526986838 +0100
@@ -293,6 +293,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/x86emu/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/x86emu/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/x86emu/Makefile.in	2009-12-19 08:06:14.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/x86emu/Makefile.in	2009-12-20 14:08:27.702986602 +0100
@@ -267,6 +267,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/xaa/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/xaa/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/xaa/Makefile.in	2009-12-19 08:06:14.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/xaa/Makefile.in	2009-12-20 14:08:27.903987391 +0100
@@ -313,6 +313,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xfree86/xf8_16bpp/Makefile.in xorg-server-1.7.99.2.patch/hw/xfree86/xf8_16bpp/Makefile.in
--- xorg-server-1.7.99.2/hw/xfree86/xf8_16bpp/Makefile.in	2009-12-19 08:06:14.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xfree86/xf8_16bpp/Makefile.in	2009-12-20 14:08:28.094986780 +0100
@@ -294,6 +294,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xnest/Makefile.in xorg-server-1.7.99.2.patch/hw/xnest/Makefile.in
--- xorg-server-1.7.99.2/hw/xnest/Makefile.in	2009-12-19 08:06:14.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xnest/Makefile.in	2009-12-20 14:08:28.329861861 +0100
@@ -315,6 +315,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xquartz/bundle/Makefile.in xorg-server-1.7.99.2.patch/hw/xquartz/bundle/Makefile.in
--- xorg-server-1.7.99.2/hw/xquartz/bundle/Makefile.in	2009-12-19 08:06:15.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xquartz/bundle/Makefile.in	2009-12-20 14:08:28.868861624 +0100
@@ -272,6 +272,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xquartz/doc/Makefile.in xorg-server-1.7.99.2.patch/hw/xquartz/doc/Makefile.in
--- xorg-server-1.7.99.2/hw/xquartz/doc/Makefile.in	2009-12-19 08:06:15.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xquartz/doc/Makefile.in	2009-12-20 14:08:29.040861818 +0100
@@ -268,6 +268,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xquartz/GL/Makefile.in xorg-server-1.7.99.2.patch/hw/xquartz/GL/Makefile.in
--- xorg-server-1.7.99.2/hw/xquartz/GL/Makefile.in	2009-12-19 08:06:14.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xquartz/GL/Makefile.in	2009-12-20 14:08:28.499861746 +0100
@@ -266,6 +266,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xquartz/mach-startup/Makefile.in xorg-server-1.7.99.2.patch/hw/xquartz/mach-startup/Makefile.in
--- xorg-server-1.7.99.2/hw/xquartz/mach-startup/Makefile.in	2009-12-19 08:06:15.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xquartz/mach-startup/Makefile.in	2009-12-20 14:08:29.232861534 +0100
@@ -303,6 +303,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xquartz/Makefile.in xorg-server-1.7.99.2.patch/hw/xquartz/Makefile.in
--- xorg-server-1.7.99.2/hw/xquartz/Makefile.in	2009-12-19 08:06:15.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xquartz/Makefile.in	2009-12-20 14:08:28.705861246 +0100
@@ -319,6 +319,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xquartz/pbproxy/Makefile.in xorg-server-1.7.99.2.patch/hw/xquartz/pbproxy/Makefile.in
--- xorg-server-1.7.99.2/hw/xquartz/pbproxy/Makefile.in	2009-12-19 08:06:15.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xquartz/pbproxy/Makefile.in	2009-12-20 14:08:29.431897634 +0100
@@ -294,6 +294,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xquartz/xpr/Makefile.in xorg-server-1.7.99.2.patch/hw/xquartz/xpr/Makefile.in
--- xorg-server-1.7.99.2/hw/xquartz/xpr/Makefile.in	2009-12-19 08:06:15.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xquartz/xpr/Makefile.in	2009-12-20 14:08:29.609861528 +0100
@@ -267,6 +267,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/hw/xwin/Makefile.in xorg-server-1.7.99.2.patch/hw/xwin/Makefile.in
--- xorg-server-1.7.99.2/hw/xwin/Makefile.in	2009-12-19 08:06:15.000000000 +0100
+++ xorg-server-1.7.99.2.patch/hw/xwin/Makefile.in	2009-12-20 14:08:29.883987032 +0100
@@ -390,6 +390,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/include/dix-config.h.in xorg-server-1.7.99.2.patch/include/dix-config.h.in
--- xorg-server-1.7.99.2/include/dix-config.h.in	2009-11-06 07:45:04.000000000 +0100
+++ xorg-server-1.7.99.2.patch/include/dix-config.h.in	2009-12-20 14:00:53.112986599 +0100
@@ -396,6 +396,9 @@
 /* Support D-Bus */
 #undef HAVE_DBUS
 
+/* Use libudev for input hotplug */
+#undef CONFIG_UDEV
+
 /* Use D-Bus for input hotplug */
 #undef CONFIG_NEED_DBUS
 
diff -Naur xorg-server-1.7.99.2/include/do-not-use-config.h.in xorg-server-1.7.99.2.patch/include/do-not-use-config.h.in
--- xorg-server-1.7.99.2/include/do-not-use-config.h.in	2009-12-19 08:06:04.000000000 +0100
+++ xorg-server-1.7.99.2.patch/include/do-not-use-config.h.in	2009-12-20 14:08:14.000000000 +0100
@@ -36,6 +36,9 @@
 /* Use D-Bus for input hotplug */
 #undef CONFIG_NEED_DBUS
 
+/* Use libudev for input hotplug */
+#undef CONFIG_UDEV
+
 /* Define to one of `_getb67', `GETB67', `getb67' for Cray-2 and Cray-YMP
    systems. This function is required for `alloca.c' support on those systems.
    */
@@ -226,9 +229,6 @@
 /* Define to 1 if you have the `selinux' library (-lselinux). */
 #undef HAVE_LIBSELINUX
 
-/* Define to 1 if you have the `ws2_32' library (-lws2_32). */
-#undef HAVE_LIBWS2_32
-
 /* Define to 1 if you have the `link' function. */
 #undef HAVE_LINK
 
diff -Naur xorg-server-1.7.99.2/include/do-not-use-config.h.in~ xorg-server-1.7.99.2.patch/include/do-not-use-config.h.in~
--- xorg-server-1.7.99.2/include/do-not-use-config.h.in~	1970-01-01 01:00:00.000000000 +0100
+++ xorg-server-1.7.99.2.patch/include/do-not-use-config.h.in~	2009-12-20 14:02:37.000000000 +0100
@@ -0,0 +1,767 @@
+/* include/do-not-use-config.h.in.  Generated from configure.ac by autoheader.  */
+
+/* Define if building universal (internal helper macro) */
+#undef AC_APPLE_UNIVERSAL_BUILD
+
+/* Build AIGLX loader */
+#undef AIGLX
+
+/* Default base font path */
+#undef BASE_FONT_PATH
+
+/* Support BigRequests extension */
+#undef BIGREQS
+
+/* Define to 1 if `struct sockaddr_in' has a `sin_len' member */
+#undef BSD44SOCKETS
+
+/* Builder address */
+#undef BUILDERADDR
+
+/* Builder string */
+#undef BUILDERSTRING
+
+/* Default font path */
+#undef COMPILEDDEFAULTFONTPATH
+
+/* Support Composite Extension */
+#undef COMPOSITE
+
+/* Use the D-Bus input configuration API */
+#undef CONFIG_DBUS_API
+
+/* Use the HAL hotplug API */
+#undef CONFIG_HAL
+
+/* Use D-Bus for input hotplug */
+#undef CONFIG_NEED_DBUS
+
+/* Use libudev for input hotplug */
+#undef CONFIG_UDEV
+
+/* Define to one of `_getb67', `GETB67', `getb67' for Cray-2 and Cray-YMP
+   systems. This function is required for `alloca.c' support on those systems.
+   */
+#undef CRAY_STACKSEG_END
+
+/* System is BSD-like */
+#undef CSRG_BASED
+
+/* Simple debug messages */
+#undef CYGDEBUG
+
+/* Debug window manager */
+#undef CYGMULTIWINDOW_DEBUG
+
+/* Debug messages for window handling */
+#undef CYGWINDOWING_DEBUG
+
+/* Define to 1 if using `alloca.c'. */
+#undef C_ALLOCA
+
+/* Support Damage extension */
+#undef DAMAGE
+
+/* Support DBE extension */
+#undef DBE
+
+/* Use ddxBeforeReset */
+#undef DDXBEFORERESET
+
+/* Use OsVendorVErrorF */
+#undef DDXOSVERRORF
+
+/* Enable debugging code */
+#undef DEBUG
+
+/* Default library install path */
+#undef DEFAULT_LIBRARY_PATH
+
+/* Default log location */
+#undef DEFAULT_LOGPREFIX
+
+/* Default module search path */
+#undef DEFAULT_MODULE_PATH
+
+/* Support DGA extension */
+#undef DGA
+
+/* Support DPMS extension */
+#undef DPMSExtension
+
+/* Build DRI2 extension */
+#undef DRI2
+
+/* Build DRI2 AIGLX loader */
+#undef DRI2_AIGLX
+
+/* Default DRI driver path */
+#undef DRI_DRIVER_PATH
+
+/* Build GLX extension */
+#undef GLXEXT
+
+/* Support XDM-AUTH*-1 */
+#undef HASXDMAUTH
+
+/* System has /dev/xf86 aperture driver */
+#undef HAS_APERTURE_DRV
+
+/* Cygwin has /dev/windows for signaling new win32 messages */
+#undef HAS_DEVWINDOWS
+
+/* Have the 'getdtablesize' function. */
+#undef HAS_GETDTABLESIZE
+
+/* Have the 'getifaddrs' function. */
+#undef HAS_GETIFADDRS
+
+/* Have the 'getpeereid' function. */
+#undef HAS_GETPEEREID
+
+/* Have the 'getpeerucred' function. */
+#undef HAS_GETPEERUCRED
+
+/* Have the 'mmap' function. */
+#undef HAS_MMAP
+
+/* Define to 1 if NetBSD built-in MTRR support is available */
+#undef HAS_MTRR_BUILTIN
+
+/* MTRR support available */
+#undef HAS_MTRR_SUPPORT
+
+/* Support SHM */
+#undef HAS_SHM
+
+/* Have the 'strlcpy' function */
+#undef HAS_STRLCPY
+
+/* Use Windows sockets */
+#undef HAS_WINSOCK
+
+/* Define to 1 if you have `alloca', as a function or macro. */
+#undef HAVE_ALLOCA
+
+/* Define to 1 if you have <alloca.h> and it should be used (not on Ultrix).
+   */
+#undef HAVE_ALLOCA_H
+
+/* Define to 1 if you have the <asm/mtrr.h> header file. */
+#undef HAVE_ASM_MTRR_H
+
+/* Define to 1 if you have the `authdes_create' function. */
+#undef HAVE_AUTHDES_CREATE
+
+/* Define to 1 if you have the `authdes_seccreate' function. */
+#undef HAVE_AUTHDES_SECCREATE
+
+/* "Have avc_netlink_acquire_fd" */
+#undef HAVE_AVC_NETLINK_ACQUIRE_FD
+
+/* Has backtrace support */
+#undef HAVE_BACKTRACE
+
+/* Define to 1 if you have the <byteswap.h> header file. */
+#undef HAVE_BYTESWAP_H
+
+/* Have the 'cbrt' function */
+#undef HAVE_CBRT
+
+/* Define to 1 if you have the `clock_gettime' function. */
+#undef HAVE_CLOCK_GETTIME
+
+/* Define to 1 if you have the <dbm.h> header file. */
+#undef HAVE_DBM_H
+
+/* Have D-Bus support */
+#undef HAVE_DBUS
+
+/* Define to 1 if you have the <dirent.h> header file, and it defines `DIR'.
+   */
+#undef HAVE_DIRENT_H
+
+/* Define to 1 if you have the <dlfcn.h> header file. */
+#undef HAVE_DLFCN_H
+
+/* Define to 1 if you don't have `vprintf' but do have `_doprnt.' */
+#undef HAVE_DOPRNT
+
+/* Have execinfo.h */
+#undef HAVE_EXECINFO_H
+
+/* Define to 1 if you have the <fcntl.h> header file. */
+#undef HAVE_FCNTL_H
+
+/* Define to 1 if you have the `ffs' function. */
+#undef HAVE_FFS
+
+/* Define to 1 if you have the `geteuid' function. */
+#undef HAVE_GETEUID
+
+/* Define to 1 if you have the `getisax' function. */
+#undef HAVE_GETISAX
+
+/* Define to 1 if you have the `getopt' function. */
+#undef HAVE_GETOPT
+
+/* Define to 1 if you have the `getopt_long' function. */
+#undef HAVE_GETOPT_LONG
+
+/* Define to 1 if you have the `getuid' function. */
+#undef HAVE_GETUID
+
+/* Define to 1 if you have the `getzoneid' function. */
+#undef HAVE_GETZONEID
+
+/* Define to 1 if you have the <inttypes.h> header file. */
+#undef HAVE_INTTYPES_H
+
+/* Define to 1 if you have the `audit' library (-laudit). */
+#undef HAVE_LIBAUDIT
+
+/* Define to 1 if you have the <libaudit.h> header file. */
+#undef HAVE_LIBAUDIT_H
+
+/* Define to 1 if you have the `m' library (-lm). */
+#undef HAVE_LIBM
+
+/* Define to 1 if you have the `selinux' library (-lselinux). */
+#undef HAVE_LIBSELINUX
+
+/* Define to 1 if you have the `link' function. */
+#undef HAVE_LINK
+
+/* Define to 1 if you have the <linux/agpgart.h> header file. */
+#undef HAVE_LINUX_AGPGART_H
+
+/* Define to 1 if you have the <linux/apm_bios.h> header file. */
+#undef HAVE_LINUX_APM_BIOS_H
+
+/* Define to 1 if you have the <linux/fb.h> header file. */
+#undef HAVE_LINUX_FB_H
+
+/* Define to 1 if you have the <machine/mtrr.h> header file. */
+#undef HAVE_MACHINE_MTRR_H
+
+/* Define to 1 if you have the `memmove' function. */
+#undef HAVE_MEMMOVE
+
+/* Define to 1 if you have the <memory.h> header file. */
+#undef HAVE_MEMORY_H
+
+/* Define to 1 if you have the `memset' function. */
+#undef HAVE_MEMSET
+
+/* Define to 1 if you have the `mkstemp' function. */
+#undef HAVE_MKSTEMP
+
+/* Define to 1 if you have the <ndbm.h> header file. */
+#undef HAVE_NDBM_H
+
+/* Define to 1 if you have the <ndir.h> header file, and it defines `DIR'. */
+#undef HAVE_NDIR_H
+
+/* Define to 1 if you have the `pci_device_enable' function. */
+#undef HAVE_PCI_DEVICE_ENABLE
+
+/* Define to 1 if you have the `pci_device_is_boot_vga' function. */
+#undef HAVE_PCI_DEVICE_IS_BOOT_VGA
+
+/* Define to 1 if you have the `pci_device_vgaarb_init' function. */
+#undef HAVE_PCI_DEVICE_VGAARB_INIT
+
+/* Define to 1 if you have the `pci_system_init_dev_mem' function. */
+#undef HAVE_PCI_SYSTEM_INIT_DEV_MEM
+
+/* Define to 1 if you have the <rpcsvc/dbm.h> header file. */
+#undef HAVE_RPCSVC_DBM_H
+
+/* Define to 1 if you have the <selinux/avc.h> header file. */
+#undef HAVE_SELINUX_AVC_H
+
+/* Define to 1 if you have the <selinux/selinux.h> header file. */
+#undef HAVE_SELINUX_SELINUX_H
+
+/* Use CommonCrypto SHA1 functions */
+#undef HAVE_SHA1_IN_COMMONCRYPTO
+
+/* Use libc SHA1 functions */
+#undef HAVE_SHA1_IN_LIBC
+
+/* Use libgcrypt SHA1 functions */
+#undef HAVE_SHA1_IN_LIBGCRYPT
+
+/* Use libmd SHA1 functions */
+#undef HAVE_SHA1_IN_LIBMD
+
+/* Use libsha1 for SHA1 */
+#undef HAVE_SHA1_IN_LIBSHA1
+
+/* Define to 1 if you have the `shmctl64' function. */
+#undef HAVE_SHMCTL64
+
+/* Define to 1 if the system has the type `socklen_t'. */
+#undef HAVE_SOCKLEN_T
+
+/* Define to 1 if you have the <stdint.h> header file. */
+#undef HAVE_STDINT_H
+
+/* Define to 1 if you have the <stdlib.h> header file. */
+#undef HAVE_STDLIB_H
+
+/* Define to 1 if you have the `strcasestr' function. */
+#undef HAVE_STRCASESTR
+
+/* Define to 1 if you have the `strchr' function. */
+#undef HAVE_STRCHR
+
+/* Define to 1 if you have the <strings.h> header file. */
+#undef HAVE_STRINGS_H
+
+/* Define to 1 if you have the <string.h> header file. */
+#undef HAVE_STRING_H
+
+/* Define to 1 if you have the <stropts.h> header file. */
+#undef HAVE_STROPTS_H
+
+/* Define to 1 if you have the `strrchr' function. */
+#undef HAVE_STRRCHR
+
+/* Define to 1 if you have the `strtol' function. */
+#undef HAVE_STRTOL
+
+/* Define to 1 if SYSV IPC is available */
+#undef HAVE_SYSV_IPC
+
+/* Define to 1 if you have the <sys/agpgart.h> header file. */
+#undef HAVE_SYS_AGPGART_H
+
+/* Define to 1 if you have the <sys/agpio.h> header file. */
+#undef HAVE_SYS_AGPIO_H
+
+/* Define to 1 if you have the <sys/dir.h> header file, and it defines `DIR'.
+   */
+#undef HAVE_SYS_DIR_H
+
+/* Define to 1 if you have the <sys/io.h> header file. */
+#undef HAVE_SYS_IO_H
+
+/* Define to 1 if you have the <sys/kd.h> header file. */
+#undef HAVE_SYS_KD_H
+
+/* Define to 1 if you have the <sys/linker.h> header file. */
+#undef HAVE_SYS_LINKER_H
+
+/* Define to 1 if you have the <sys/memrange.h> header file. */
+#undef HAVE_SYS_MEMRANGE_H
+
+/* Define to 1 if you have the <sys/ndir.h> header file, and it defines `DIR'.
+   */
+#undef HAVE_SYS_NDIR_H
+
+/* Define to 1 if you have the <sys/stat.h> header file. */
+#undef HAVE_SYS_STAT_H
+
+/* Define to 1 if you have the <sys/types.h> header file. */
+#undef HAVE_SYS_TYPES_H
+
+/* Define to 1 if you have the <sys/vm86.h> header file. */
+#undef HAVE_SYS_VM86_H
+
+/* Define to 1 if you have the <sys/vt.h> header file. */
+#undef HAVE_SYS_VT_H
+
+/* Define to 1 if you have the <unistd.h> header file. */
+#undef HAVE_UNISTD_H
+
+/* Define to 1 if you have the `vprintf' function. */
+#undef HAVE_VPRINTF
+
+/* Define to 1 if you have the `vsnprintf' function. */
+#undef HAVE_VSNPRINTF
+
+/* Define to 1 if you have the `walkcontext' function. */
+#undef HAVE_WALKCONTEXT
+
+/* Support IPv6 for TCP connections */
+#undef IPv6
+
+/* Build kdrive ddx */
+#undef KDRIVEDDXACTIONS
+
+/* Build fbdev-based kdrive server */
+#undef KDRIVEFBDEV
+
+/* Build Kdrive X server */
+#undef KDRIVESERVER
+
+/* Prefix to use for launchd identifiers */
+#undef LAUNCHD_ID_PREFIX
+
+/* Support os-specific local connections */
+#undef LOCALCONN
+
+/* Define to the sub-directory in which libtool stores uninstalled libraries.
+   */
+#undef LT_OBJDIR
+
+/* Support MIT-SHM extension */
+#undef MITSHM
+
+/* Have monotonic clock from clock_gettime() */
+#undef MONOTONIC_CLOCK
+
+/* Build Multibuffer extension */
+#undef MULTIBUFFER
+
+/* Do not have 'strcasecmp'. */
+#undef NEED_STRCASECMP
+
+/* Do not have 'strcasestr'. */
+#undef NEED_STRCASESTR
+
+/* Do not have 'strncasecmp'. */
+#undef NEED_STRNCASECMP
+
+/* Need XFree86 helper functions */
+#undef NEED_XF86_PROTOTYPES
+
+/* Need XFree86 typedefs */
+#undef NEED_XF86_TYPES
+
+/* Define to 1 if modules should avoid the libcwrapper */
+#undef NO_LIBCWRAPPER
+
+/* Use an empty root cursor */
+#undef NULL_ROOT_CURSOR
+
+/* Operating System Name */
+#undef OSNAME
+
+/* Operating System Vendor */
+#undef OSVENDOR
+
+/* Name of package */
+#undef PACKAGE
+
+/* Define to the address where bug reports for this package should be sent. */
+#undef PACKAGE_BUGREPORT
+
+/* Define to the full name of this package. */
+#undef PACKAGE_NAME
+
+/* Define to the full name and version of this package. */
+#undef PACKAGE_STRING
+
+/* Define to the one symbol short name of this package. */
+#undef PACKAGE_TARNAME
+
+/* Define to the version of this package. */
+#undef PACKAGE_VERSION
+
+/* Major version of this package */
+#undef PACKAGE_VERSION_MAJOR
+
+/* Minor version of this package */
+#undef PACKAGE_VERSION_MINOR
+
+/* Patch version of this package */
+#undef PACKAGE_VERSION_PATCHLEVEL
+
+/* Internal define for Xinerama */
+#undef PANORAMIX
+
+/* System has PC console */
+#undef PCCONS_SUPPORT
+
+/* Default PCI text file ID path */
+#undef PCI_TXT_IDS_PATH
+
+/* System has PC console */
+#undef PCVT_SUPPORT
+
+/* Overall prefix */
+#undef PROJECTROOT
+
+/* Support RANDR extension */
+#undef RANDR
+
+/* Make PROJECT_ROOT relative to the xserver location */
+#undef RELOCATE_PROJECTROOT
+
+/* Support RENDER extension */
+#undef RENDER
+
+/* Support X resource extension */
+#undef RES
+
+/* Define as the return type of signal handlers (`int' or `void'). */
+#undef RETSIGTYPE
+
+/* Build Rootless code */
+#undef ROOTLESS
+
+/* Support MIT-SCREEN-SAVER extension */
+#undef SCREENSAVER
+
+/* Support Secure RPC ("SUN-DES-1") authentication for X11 clients */
+#undef SECURE_RPC
+
+/* Server miscellaneous config path */
+#undef SERVER_MISC_CONFIG_PATH
+
+/* Support SHAPE extension */
+#undef SHAPE
+
+/* The size of `unsigned long', as computed by sizeof. */
+#undef SIZEOF_UNSIGNED_LONG
+
+/* If using the C implementation of alloca, define if you know the
+   direction of stack growth for your system; otherwise it will be
+   automatically deduced at runtime.
+	STACK_DIRECTION > 0 => grows toward higher addresses
+	STACK_DIRECTION < 0 => grows toward lower addresses
+	STACK_DIRECTION = 0 => direction of growth unknown */
+#undef STACK_DIRECTION
+
+/* Build a standalone xpbproxy */
+#undef STANDALONE_XPBPROXY
+
+/* Define to 1 if you have the ANSI C header files. */
+#undef STDC_HEADERS
+
+/* Support PC98 */
+#undef SUPPORT_PC98
+
+/* Define to 1 on systems derived from System V Release 4 */
+#undef SVR4
+
+/* System has syscons console */
+#undef SYSCONS_SUPPORT
+
+/* Support TCP socket connections */
+#undef TCPCONN
+
+/* Have tslib support */
+#undef TSLIB
+
+/* Enable unit tests */
+#undef UNITTESTS
+
+/* Support UNIX socket connections */
+#undef UNIXCONN
+
+/* NetBSD PIO alpha IO */
+#undef USE_ALPHA_PIO
+
+/* BSD AMD64 iopl */
+#undef USE_AMD64_IOPL
+
+/* BSD /dev/io */
+#undef USE_DEV_IO
+
+/* BSD i386 iopl */
+#undef USE_I386_IOPL
+
+/* Use SIGIO handlers for input device events by default */
+#undef USE_SIGIO_BY_DEFAULT
+
+/* Define to use byteswap macros from <sys/endian.h> */
+#undef USE_SYS_ENDIAN_H
+
+/* Vendor man version */
+#undef VENDOR_MAN_VERSION
+
+/* Vendor name */
+#undef VENDOR_NAME
+
+/* Vendor name */
+#undef VENDOR_NAME_SHORT
+
+/* Vendor release */
+#undef VENDOR_RELEASE
+
+/* Version number of package */
+#undef VERSION
+
+/* Building vgahw module */
+#undef WITH_VGAHW
+
+/* Define WORDS_BIGENDIAN to 1 if your processor stores words with the most
+   significant byte first (like Motorola and SPARC, unlike Intel). */
+#if defined AC_APPLE_UNIVERSAL_BUILD
+# if defined __BIG_ENDIAN__
+#  define WORDS_BIGENDIAN 1
+# endif
+#else
+# ifndef WORDS_BIGENDIAN
+#  undef WORDS_BIGENDIAN
+# endif
+#endif
+
+/* System has wscons console */
+#undef WSCONS_SUPPORT
+
+/* Build X-ACE extension */
+#undef XACE
+
+/* Build XCalibrate extension */
+#undef XCALIBRATE
+
+/* Support XCMisc extension */
+#undef XCMISC
+
+/* Build Security extension */
+#undef XCSECURITY
+
+/* Support XDM Control Protocol */
+#undef XDMCP
+
+/* Support XF86 Big font extension */
+#undef XF86BIGFONT
+
+/* Name of configuration file */
+#undef XF86CONFIGFILE
+
+/* Build DRI extension */
+#undef XF86DRI
+
+/* Support XFree86 Video Mode extension */
+#undef XF86VIDMODE
+
+/* Support XFixes extension */
+#undef XFIXES
+
+/* Building loadable XFree86 server */
+#undef XFree86LOADER
+
+/* Building XFree86 server */
+#undef XFree86Server
+
+/* Build XDGA support */
+#undef XFreeXDGA
+
+/* Support Xinerama extension */
+#undef XINERAMA
+
+/* Path to XKB data */
+#undef XKB_BASE_DIRECTORY
+
+/* Path to XKB bin dir */
+#undef XKB_BIN_DIRECTORY
+
+/* Default XKB layout */
+#undef XKB_DFLT_LAYOUT
+
+/* Default XKB model */
+#undef XKB_DFLT_MODEL
+
+/* Default XKB options */
+#undef XKB_DFLT_OPTIONS
+
+/* Default XKB ruleset */
+#undef XKB_DFLT_RULES
+
+/* Default XKB variant */
+#undef XKB_DFLT_VARIANT
+
+/* Path to XKB output dir */
+#undef XKM_OUTPUT_DIR
+
+/* Building Xorg server */
+#undef XORGSERVER
+
+/* Vendor release */
+#undef XORG_DATE
+
+/* Vendor man version */
+#undef XORG_MAN_VERSION
+
+/* Building Xorg server */
+#undef XORG_SERVER
+
+/* Current Xorg version */
+#undef XORG_VERSION_CURRENT
+
+/* Have Quartz */
+#undef XQUARTZ
+
+/* Support application updating through sparkle. */
+#undef XQUARTZ_SPARKLE
+
+/* Support Record extension */
+#undef XRECORD
+
+/* Build registry module */
+#undef XREGISTRY
+
+/* Build SELinux extension */
+#undef XSELINUX
+
+/* Define to 1 if the DTrace Xserver provider probes should be built in. */
+#undef XSERVER_DTRACE
+
+/* Use libpciaccess for all pci manipulation */
+#undef XSERVER_LIBPCIACCESS
+
+/* Support XSync extension */
+#undef XSYNC
+
+/* Support XTest extension */
+#undef XTEST
+
+/* Support Xv extension */
+#undef XV
+
+/* Vendor name */
+#undef XVENDORNAME
+
+/* Short vendor name */
+#undef XVENDORNAMESHORT
+
+/* Build Xv extension */
+#undef XvExtension
+
+/* Build XvMC extension */
+#undef XvMCExtension
+
+/* Define to 1 if `lex' declares `yytext' as a `char *' by default, not a
+   `char[]'. */
+#undef YYTEXT_POINTER
+
+/* Number of bits in a file offset, on hosts where this is settable. */
+#undef _FILE_OFFSET_BITS
+
+/* Enable GNU and other extensions to the C environment for glibc */
+#undef _GNU_SOURCE
+
+/* Define for large files, on AIX-style hosts. */
+#undef _LARGE_FILES
+
+/* Define to 1 if unsigned long is 64 bits. */
+#undef _XSERVER64
+
+/* Vendor web address for support */
+#undef __VENDORDWEBSUPPORT__
+
+/* Name of configuration file */
+#undef __XCONFIGFILE__
+
+/* Name of X server */
+#undef __XSERVERNAME__
+
+/* Define to 16-bit byteswap macro */
+#undef bswap_16
+
+/* Define to 32-bit byteswap macro */
+#undef bswap_32
+
+/* Define to 64-bit byteswap macro */
+#undef bswap_64
+
+/* Define to empty if `const' does not conform to ANSI C. */
+#undef const
+
+/* Define to `int' if <sys/types.h> does not define. */
+#undef pid_t
diff -Naur xorg-server-1.7.99.2/include/Makefile.in xorg-server-1.7.99.2.patch/include/Makefile.in
--- xorg-server-1.7.99.2/include/Makefile.in	2009-12-19 08:06:16.000000000 +0100
+++ xorg-server-1.7.99.2.patch/include/Makefile.in	2009-12-20 14:08:30.073986928 +0100
@@ -276,6 +276,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/Makefile.in xorg-server-1.7.99.2.patch/Makefile.in
--- xorg-server-1.7.99.2/Makefile.in	2009-12-19 08:06:18.000000000 +0100
+++ xorg-server-1.7.99.2.patch/Makefile.in	2009-12-20 14:08:33.009986613 +0100
@@ -319,6 +319,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/mi/Makefile.in xorg-server-1.7.99.2.patch/mi/Makefile.in
--- xorg-server-1.7.99.2/mi/Makefile.in	2009-12-19 08:06:16.000000000 +0100
+++ xorg-server-1.7.99.2.patch/mi/Makefile.in	2009-12-20 14:08:30.258986785 +0100
@@ -301,6 +301,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/miext/cw/Makefile.in xorg-server-1.7.99.2.patch/miext/cw/Makefile.in
--- xorg-server-1.7.99.2/miext/cw/Makefile.in	2009-12-19 08:06:16.000000000 +0100
+++ xorg-server-1.7.99.2.patch/miext/cw/Makefile.in	2009-12-20 14:08:30.571986896 +0100
@@ -265,6 +265,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/miext/damage/Makefile.in xorg-server-1.7.99.2.patch/miext/damage/Makefile.in
--- xorg-server-1.7.99.2/miext/damage/Makefile.in	2009-12-19 08:06:16.000000000 +0100
+++ xorg-server-1.7.99.2.patch/miext/damage/Makefile.in	2009-12-20 14:08:30.745986420 +0100
@@ -291,6 +291,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/miext/Makefile.in xorg-server-1.7.99.2.patch/miext/Makefile.in
--- xorg-server-1.7.99.2/miext/Makefile.in	2009-12-19 08:06:16.000000000 +0100
+++ xorg-server-1.7.99.2.patch/miext/Makefile.in	2009-12-20 14:08:30.406986700 +0100
@@ -281,6 +281,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/miext/rootless/Makefile.in xorg-server-1.7.99.2.patch/miext/rootless/Makefile.in
--- xorg-server-1.7.99.2/miext/rootless/Makefile.in	2009-12-19 08:06:16.000000000 +0100
+++ xorg-server-1.7.99.2.patch/miext/rootless/Makefile.in	2009-12-20 14:08:30.911986875 +0100
@@ -266,6 +266,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/miext/shadow/Makefile.in xorg-server-1.7.99.2.patch/miext/shadow/Makefile.in
--- xorg-server-1.7.99.2/miext/shadow/Makefile.in	2009-12-19 08:06:16.000000000 +0100
+++ xorg-server-1.7.99.2.patch/miext/shadow/Makefile.in	2009-12-20 14:08:31.101986422 +0100
@@ -296,6 +296,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/os/Makefile.in xorg-server-1.7.99.2.patch/os/Makefile.in
--- xorg-server-1.7.99.2/os/Makefile.in	2009-12-19 08:06:16.000000000 +0100
+++ xorg-server-1.7.99.2.patch/os/Makefile.in	2009-12-20 14:08:31.295986725 +0100
@@ -290,6 +290,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/randr/Makefile.in xorg-server-1.7.99.2.patch/randr/Makefile.in
--- xorg-server-1.7.99.2/randr/Makefile.in	2009-12-19 08:06:17.000000000 +0100
+++ xorg-server-1.7.99.2.patch/randr/Makefile.in	2009-12-20 14:08:31.482988777 +0100
@@ -300,6 +300,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/record/Makefile.in xorg-server-1.7.99.2.patch/record/Makefile.in
--- xorg-server-1.7.99.2/record/Makefile.in	2009-12-19 08:06:17.000000000 +0100
+++ xorg-server-1.7.99.2.patch/record/Makefile.in	2009-12-20 14:08:31.664987020 +0100
@@ -265,6 +265,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/render/Makefile.in xorg-server-1.7.99.2.patch/render/Makefile.in
--- xorg-server-1.7.99.2/render/Makefile.in	2009-12-19 08:06:17.000000000 +0100
+++ xorg-server-1.7.99.2.patch/render/Makefile.in	2009-12-20 14:08:31.853986588 +0100
@@ -294,6 +294,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/test/Makefile.in xorg-server-1.7.99.2.patch/test/Makefile.in
--- xorg-server-1.7.99.2/test/Makefile.in	2009-12-19 08:06:17.000000000 +0100
+++ xorg-server-1.7.99.2.patch/test/Makefile.in	2009-12-20 14:08:32.063986565 +0100
@@ -336,6 +336,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/test/xi2/Makefile.in xorg-server-1.7.99.2.patch/test/xi2/Makefile.in
--- xorg-server-1.7.99.2/test/xi2/Makefile.in	2009-12-19 08:06:17.000000000 +0100
+++ xorg-server-1.7.99.2.patch/test/xi2/Makefile.in	2009-12-20 14:08:32.431861585 +0100
@@ -403,6 +403,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/Xext/Makefile.in xorg-server-1.7.99.2.patch/Xext/Makefile.in
--- xorg-server-1.7.99.2/Xext/Makefile.in	2009-12-19 08:06:05.000000000 +0100
+++ xorg-server-1.7.99.2.patch/Xext/Makefile.in	2009-12-20 14:08:15.792986382 +0100
@@ -366,6 +366,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/xfixes/Makefile.in xorg-server-1.7.99.2.patch/xfixes/Makefile.in
--- xorg-server-1.7.99.2/xfixes/Makefile.in	2009-12-19 08:06:17.000000000 +0100
+++ xorg-server-1.7.99.2.patch/xfixes/Makefile.in	2009-12-20 14:08:32.621986636 +0100
@@ -292,6 +292,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/Xi/Makefile.in xorg-server-1.7.99.2.patch/Xi/Makefile.in
--- xorg-server-1.7.99.2/Xi/Makefile.in	2009-12-19 08:06:05.000000000 +0100
+++ xorg-server-1.7.99.2.patch/Xi/Makefile.in	2009-12-20 14:08:15.983986821 +0100
@@ -276,6 +276,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
diff -Naur xorg-server-1.7.99.2/xkb/Makefile.in xorg-server-1.7.99.2.patch/xkb/Makefile.in
--- xorg-server-1.7.99.2/xkb/Makefile.in	2009-12-19 08:06:18.000000000 +0100
+++ xorg-server-1.7.99.2.patch/xkb/Makefile.in	2009-12-20 14:08:32.823986776 +0100
@@ -301,6 +301,8 @@
 STRIP = @STRIP@
 TSLIB_CFLAGS = @TSLIB_CFLAGS@
 TSLIB_LIBS = @TSLIB_LIBS@
+UDEV_CFLAGS = @UDEV_CFLAGS@
+UDEV_LIBS = @UDEV_LIBS@
 UTILS_SYS_LIBS = @UTILS_SYS_LIBS@
 VENDOR_NAME_SHORT = @VENDOR_NAME_SHORT@
 VERSION = @VERSION@
