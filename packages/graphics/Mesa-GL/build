#!/bin/sh

################################################################################
#      This file is part of OpenELEC - http://www.openelec.tv
#      Copyright (C) 2009-2011 Stephan Raue (stephan@openelec.tv)
#
#  This Program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2, or (at your option)
#  any later version.
#
#  This Program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with OpenELEC.tv; see the file COPYING.  If not, write to
#  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
#  http://www.gnu.org/copyleft/gpl.html
################################################################################

. config/options $1

$SCRIPTS/unpack Mesa

# dont use gold linker because of compiling issues
  strip_gold
  strip_linker_plugin

cd $BUILD/Mesa*

do_autoreconf
./configure --host=$TARGET_NAME \
            --build=$HOST_NAME \
            --prefix=/usr \
            --sysconfdir=/etc \
            --localstatedir=/var \
            --disable-static \
            --enable-shared \
            --disable-debug \
            --disable-selinux \
            --enable-xcb \
            --disable-glx-tls \
            --enable-driglx-direct \
            --disable-egl \
            --disable-glu \
            --disable-gl-osmesa \
            --disable-glut \
            --disable-glw \
            --disable-motif \
            --with-driver=dri \
            --with-dri-drivers="" \
            --disable-gallium

  make -C src/glx
  make -C src/mesa gl.pc
  make -C src/mesa/drivers/dri dri.pc

  mkdir -p $SYSROOT_PREFIX/usr/include/GL
    cp include/GL/*.h $SYSROOT_PREFIX/usr/include/GL
  mkdir -p $SYSROOT_PREFIX/usr/lib
    cp -P lib/libGL.so* $SYSROOT_PREFIX/usr/lib/pkgconfig
  mkdir -p $SYSROOT_PREFIX/usr/lib/pkgconfig
    cp src/mesa/gl.pc $SYSROOT_PREFIX/usr/lib/pkgconfig

  mkdir -p $SYSROOT_PREFIX/usr/include/GL/internal
    cp include/GL/internal/dri_interface.h $SYSROOT_PREFIX/usr/include/GL/internal
  mkdir -p $SYSROOT_PREFIX/usr/lib/pkgconfig
    cp src/mesa/drivers/dri/dri.pc $SYSROOT_PREFIX/usr/lib/pkgconfig
