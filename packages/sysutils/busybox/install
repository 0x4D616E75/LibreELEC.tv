#!/bin/sh

. config/options

$SCRIPTS/build busybox-hosttools
$SCRIPTS/install Linux-PAM

PKG_DIR=`find $PACKAGES -type d -name $1`

ROOT_PWD="`$ROOT/$TOOLCHAIN/bin/cryptpw $ROOT_PASSWORD`"
USER_PWD="`$ROOT/$TOOLCHAIN/bin/cryptpw $USER_PASSWORD`"

  add_user root "$ROOT_PWD" 0 0 "Root User" "/storage" "/bin/sh"
  add_group root 0

  add_user $USER_NAME "$USER_PWD" 1000 1000 "User" "/storage" "/bin/sh"
  add_group $USER_GROUP 1000

  cp -PR $BUILD/busybox*/_install-system/* $INSTALL
    echo "chmod 4755 $INSTALL/bin/busybox" >> $FAKEROOT_SCRIPT

  mkdir -p $INSTALL/bin
    ln -sf /bin/sh $INSTALL/bin/bash
    cp $PKG_DIR/scripts/lsb-release $INSTALL/bin/

  mkdir -p $INSTALL/sbin
    cp $PKG_DIR/scripts/init $INSTALL/sbin/

  mkdir -p $INSTALL/etc
    cp $PKG_DIR/config/profile $INSTALL/etc
    touch $INSTALL/etc/fstab
    ln -sf /var/run/resolv.conf $INSTALL/etc/resolv.conf
    ln -sf /proc/mounts $INSTALL/etc/mtab

# create /etc/hostname
  echo $HOSTNAME > $INSTALL/etc/hostname

# create /etc/hosts file, useful for gethostbyname(localhost)
  echo -e "127.0.0.1\tlocalhost $HOSTNAME" > $INSTALL/etc/hosts

# create /etc/issue
  echo $GREATING0 >  $INSTALL/etc/issue
  echo $GREATING1 >> $INSTALL/etc/issue
  echo $GREATING2 >> $INSTALL/etc/issue
  echo $GREATING3 >> $INSTALL/etc/issue
  echo $GREATING4 >> $INSTALL/etc/issue

  mkdir -p $INSTALL/usr/share/udhcpc
    cp $PKG_DIR/scripts/udhcp.script $INSTALL/usr/share/udhcpc/default.script

# acpid specific
  mkdir -p $INSTALL/etc/acpi/PWRF
    cp $PKG_DIR/scripts/acpi_powerbtn $INSTALL/etc/acpi/PWRF/00000080

  mkdir -p $INSTALL/etc/network
    cp $PKG_DIR/config/interfaces $INSTALL/etc/network
