From e4ac5deba9287ea6b66b7b9c1f4c4d2ee1cc69b4 Mon Sep 17 00:00:00 2001
From: Simon Munton <simon-hal@munton.demon.co.uk>
Date: Sun, 24 May 2009 16:01:51 +0000
Subject: fixed segfault in hal-storage-mount

Fixed segfault in hal-storage-mount and don't lose fstype in
probe-volume.
---
diff --git a/hald/linux/probing/probe-volume.c b/hald/linux/probing/probe-volume.c
index 882de88..13c775a 100644
--- a/hald/linux/probing/probe-volume.c
+++ b/hald/linux/probing/probe-volume.c
@@ -97,7 +97,7 @@ set_blkid_values (LibHalChangeSet *cs, blkid_probe pr)
 
 	if (blkid_probe_lookup_value(pr, "TYPE", &type, NULL))
 		type = "";
-	if (libhal_changeset_set_property_string (cs, "volume.fstype", type))
+	if (!libhal_changeset_set_property_string (cs, "volume.fstype", type))
 		libhal_changeset_set_property_string (cs, "volume.fstype", "");
 	HAL_DEBUG(("volume.fstype = '%s'", type));
 
diff --git a/tools/hal-storage-mount.c b/tools/hal-storage-mount.c
index e48b4b9..78e0160 100644
--- a/tools/hal-storage-mount.c
+++ b/tools/hal-storage-mount.c
@@ -786,7 +786,8 @@ handle_mount (LibHalContext *hal_ctx,
 		/* don't consider uid= on vfat, iso9660, hfs and udf change-uid for the purpose of policy
 		 * (since these doesn't contain uid/gid bits) 
 		 */
-		if (strcmp (libhal_volume_get_fstype (volume), "vfat") != 0 &&
+		if (libhal_volume_get_fstype (volume) != NULL &&
+		    strcmp (libhal_volume_get_fstype (volume), "vfat") != 0 &&
 		    strcmp (libhal_volume_get_fstype (volume), "ntfs") != 0 &&
 		    strcmp (libhal_volume_get_fstype (volume), "ntfs-3g") != 0 &&
 		    strcmp (libhal_volume_get_fstype (volume), "iso9660") != 0 &&
--
cgit v0.8.2
