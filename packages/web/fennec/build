#!/bin/sh

. config/options

$SCRIPTS/build toolchain
$SCRIPTS/build alsa-lib
$SCRIPTS/build gtk+
$SCRIPTS/build libIDL
$SCRIPTS/build libIDL-host

# set some variables
  MOZ_OPT_FLAGS=`echo $TARGET_CFLAGS | sed -e 's/-Wall//'`
  MOZ_OPT_FLAGS=`echo $MOZ_OPT_FLAGS | sed -e 's/-D_FILE_OFFSET_BITS=64//'`

# set crosscompiling related variables
  export CROSS_COMPILE=yes
  export HOST_CC="$HOST_CC"
  export HOST_CXX="$HOST_CXX"
  export HOST_CFLAGS="$HOST_CFLAGS"
  export HOST_CXXFLAGS="$HOST_CXXFLAGS"
  export HOST_LDFLAGS="$HOST_LDFLAGS"
  export HOST_RANLIB="$HOST_RANLIB"
  export HOST_AR="$HOST_AR"
  export HOST_LIBIDL_CONFIG="$ROOT/$TOOLCHAIN/bin/libIDL-config-2"

# set some other variables
  export CFLAGS=$MOZ_OPT_FLAGS
  export CXXFLAGS=$MOZ_OPT_FLAGS
  export LDFLAGS="-Wl,-rpath,/usr/lib/fennec/xulrunner"

cd $PKG_BUILD

# configure xulrunner and fennec
cat > .mozconfig <<EOF
  mk_add_options MOZ_BUILD_PROJECTS="xulrunner mobile" # browser"
  mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/.build

# some variables needed for crosscompiling
  ac_add_options --host=$TARGET_NAME
  ac_add_options --build=$HOST_NAME

# General config
  ac_add_options --prefix=/usr
  ac_add_options --enable-debug
  # ac_add_options --disable-mobile-optimize
  ac_add_options --enable-optimize
  # ac_add_options --disable-optimize
  # ac_cv_visibility_pragma=no
  # ac_add_options --enable-timeline
  # ac_add_options --enable-default-toolkit=gtk2
  ##ac_add_options --enable-installer
  # ac_add_options --enable-logging
  ##ac_add_options --enable-updater
  ##ac_add_options --enable-plugins
  ##ac_add_options --disable-view-source
  # ac_add_options --disable-printing
  # ac_add_options --disable-xprint
  ac_add_options --disable-libnotify
  ##   ac_add_options --with-libIDL
  # ac_add_options --disable-parental-controls
  ac_add_options --with-system-bz2
  ac_add_options --with-system-jpeg
  ac_add_options --with-system-png
  ac_add_options --with-system-zlib
  # ac_add_options --enable-canvas
  # ac_add_options --enable-safe-browsing
  # ac_add_options --enable-svg
  ac_add_options --enable-system-cairo
  # ac_add_options --enable-system-sqlite

  ac_add_options --disable-tests
  ac_add_options --disable-dbus
  ac_add_options --disable-crashreporter
  ##ac_add_options --enable-libxul
  ac_add_options --disable-gnomevfs
  ac_add_options --disable-gnomeui
  #ac_add_options --enable-extensions=python/xpcom,default

# Xulrunner related options
  ac_add_app_options xulrunner --enable-application=xulrunner
  ac_add_app_options xulrunner --disable-javaxpcom

# Fennec related options
  ac_add_app_options mobile --enable-application=mobile
#  ac_add_app_options mobile --with-system-libxul
  ac_add_app_options mobile --with-libxul-sdk=../xulrunner/dist

# configure will be automatically generated using the 'autoconf-2.13'
# command. If autoconf-2.13 isn't the right name for your system, as
# is the case on OS X using MacPorts, use the real command name as
# demonstrated below.
  mk_add_options AUTOCONF=autoconf-2.13
EOF

make -f client.mk build MOZ_MAKE_FLAGS="-j1" STRIP=/bin/true

rm -rf .build/mobile/xulrunner/dist/bin/xpidl
rm -rf .build/mobile/xulrunner/dist/bin/xpt_dump
rm -rf .build/mobile/xulrunner/dist/bin/xpt_link
rm -rf .build/mobile/xulrunner/dist/bin/xulrunner
rm -rf .build/mobile/xulrunner/dist/bin/xpcshell
rm -rf .build/mobile/xulrunner/dist/bin/nspr-config

#rm -rf .build/mobile/dist/bin/fennec
