#!/bin/sh

. /etc/profile

XBMC_ARGS="--standalone -fs --lircdev /dev/lircd"

if test "$XBMC_CACHING" = "yes" ; then
  wait_for_xbmc_cache
  XBMC_BIN="/var/cache/bin/xbmc.bin"
else
  XBMC_BIN="/usr/share/xbmc/xbmc.bin"
fi

[ -f /usr/bin/autoupdate ] && /usr/bin/autoupdate &

while true; do

  if [ "$START_WM" = "yes" ]; then
    $WINDOWMANAGER &
  fi

  $IONICE $XBMC_BIN $XBMC_ARGS $@ > /dev/null 2>&1
  RET=$?
  echo "Exited with code $RET"

  [ "$RET" == 0 ] && sync && poweroff
  [ "$RET" == 64 ] && sync && poweroff
  [ "$RET" == 66 ] && sync && reboot

done
