From f2bcc06841435fe2f1130c92e49d71d1dbd25215 Mon Sep 17 00:00:00 2001
From: wsnipex <wsnipex@a1.net>
Date: Sat, 3 May 2014 08:25:57 +0200
Subject: [PATCH 1/2] [configure] use pkg-config for rtmp detection. fixes
 linking with newer librtmp versions

---
 configure.in | 32 ++++++++++++++++++--------------
 1 file changed, 18 insertions(+), 14 deletions(-)

diff --git a/configure.in b/configure.in
index d8d06df..ff31138 100644
--- a/configure.in
+++ b/configure.in
@@ -1528,20 +1528,24 @@ fi
 
 # libRTMP
 if test "$use_librtmp" != "no"; then
-  AC_CHECK_HEADERS([librtmp/log.h librtmp/amf.h librtmp/rtmp.h],,
-   [if test "$use_librtmp" = "yes"; then
-      AC_MSG_ERROR($librtmp_not_found)
-    elif test "$use_librtmp" != "no"; then
-      AC_MSG_NOTICE($librtmp_not_found)
-      use_librtmp="no"
-    fi
-   ])
-  if test "$use_librtmp" != "no"; then
-    XB_FIND_SONAME([RTMP], [rtmp], [use_librtmp])
-  fi
-  if test "$use_librtmp" != "no"; then
-    AC_DEFINE([HAS_LIBRTMP], [1], [Whether to use libRTMP library.])
-  fi
+  PKG_CHECK_MODULES([LIBRTMP], [librtmp],
+    [INCLUDES="$INCLUDES $LIBRTMP_CFLAGS"; LIBS="$LIBS $LIBRTMP_LIBS";
+      AC_DEFINE([HAS_LIBRTMP], [1], [Whether to use libRTMP library.])],
+    [AC_CHECK_HEADERS([librtmp/log.h librtmp/amf.h librtmp/rtmp.h],,
+      [if test "$use_librtmp" = "yes"; then
+        AC_MSG_ERROR($librtmp_not_found)
+      elif test "$use_librtmp" != "no"; then
+        AC_MSG_NOTICE($librtmp_not_found)
+        use_librtmp="no"
+      fi
+      ])
+      if test "$use_librtmp" != "no"; then
+        XB_FIND_SONAME([RTMP], [rtmp], [use_librtmp])
+      fi
+      if test "$use_librtmp" != "no"; then
+        AC_DEFINE([HAS_LIBRTMP], [1], [Whether to use libRTMP library.])
+      fi
+    ])
 else
   AC_MSG_NOTICE($librtmp_disabled)
 fi
-- 
1.9.1


From a2b7ded9fd35c6323355fb8af88f250db8a8bebe Mon Sep 17 00:00:00 2001
From: wsnipex <wsnipex@a1.net>
Date: Sat, 3 May 2014 12:41:42 +0200
Subject: [PATCH 2/2] [configure] fix static linking when ffmpeg found
 nettle/hogweed

---
 Makefile.in  | 2 +-
 configure.in | 6 +++++-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/Makefile.in b/Makefile.in
index 1db6ee2..754f153 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -481,7 +481,7 @@ FFMPEGOBJS = lib/ffmpeg/libavcodec/libavcodec.a \
              lib/ffmpeg/libpostproc/libpostproc.a \
              lib/ffmpeg/libswscale/libswscale.a
 DYNOBJSXBMC+= $(FFMPEGOBJS)
-LIBS+= @GNUTLS_ALL_LIBS@ @VORBISENC_ALL_LIBS@
+LIBS+= @GNUTLS_ALL_LIBS@ @VORBISENC_ALL_LIBS@ @HOGWEED_ALL_LIBS@
 
 $(FFMPEGOBJS): dvdpcodecs
 endif
diff --git a/configure.in b/configure.in
index ff31138..f3e142f 100644
--- a/configure.in
+++ b/configure.in
@@ -880,6 +880,7 @@ if test "$use_static_ffmpeg" = "yes"; then
   # ffmpeg may depend on gnutls and vorbisenc, we add those libs at the end of linker
   # command in order to resolve any missing symbols
   GNUTLS_ALL_LIBS=`${PKG_CONFIG} --static --libs-only-l --silence-errors gnutls`
+  HOGWEED_ALL_LIBS=`${PKG_CONFIG} --static --libs-only-l --silence-errors hogweed nettle`
   VORBISENC_ALL_LIBS=`${PKG_CONFIG} --static --libs-only-l --silence-errors vorbisenc`
 fi 
 
@@ -1530,7 +1531,9 @@ fi
 if test "$use_librtmp" != "no"; then
   PKG_CHECK_MODULES([LIBRTMP], [librtmp],
     [INCLUDES="$INCLUDES $LIBRTMP_CFLAGS"; LIBS="$LIBS $LIBRTMP_LIBS";
-      AC_DEFINE([HAS_LIBRTMP], [1], [Whether to use libRTMP library.])],
+      AC_DEFINE([HAS_LIBRTMP], [1], [Whether to use libRTMP library.])
+      RTMP_ALL_LIBS=$(${PKG_CONFIG} --static --libs-only-l --silence-errors librtmp)
+      test "$use_static_ffmpeg" = "yes" && LIBS="$LIBS $RTMP_ALL_LIBS"],
     [AC_CHECK_HEADERS([librtmp/log.h librtmp/amf.h librtmp/rtmp.h],,
       [if test "$use_librtmp" = "yes"; then
         AC_MSG_ERROR($librtmp_not_found)
@@ -2671,6 +2674,7 @@ AC_SUBST(GTEST_CONFIGURED)
 AC_SUBST(USE_DOXYGEN)
 AC_SUBST(USE_PVR_ADDONS)
 AC_SUBST(GNUTLS_ALL_LIBS)
+AC_SUBST(HOGWEED_ALL_LIBS)
 AC_SUBST(VORBISENC_ALL_LIBS)
 
 # pushd and popd are not available in other shells besides bash, so implement
-- 
1.9.1

