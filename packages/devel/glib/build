#!/bin/sh

. config/options

$SCRIPTS/build toolchain
$SCRIPTS/build zlib
$SCRIPTS/build pcre
$SCRIPTS/build glib-host

# Fails to compile with GCC's link time optimization.
  CFLAGS=`echo $CFLAGS | sed -e "s|-flto||" -e "s|-fuse-linker-plugin||"`
  LDFLAGS=`echo $LDFLAGS | sed -e "s|-flto||" -e "s|-fuse-linker-plugin||"`

cd $PKG_BUILD

mkdir -p .build-target

cd .build-target

ac_cv_func_mmap_fixed_mapped='yes' \
ac_cv_func_posix_getpwuid_r='yes' \
ac_cv_func_posix_getgrgid_r='yes' \
ac_cv_func_printf_unix98='yes' \
ac_cv_func_snprintf_c99='yes' \
ac_cv_func_vsnprintf_c99='yes' \
glib_cv_stack_grows='no' \
glib_cv_uscore='no' \
glib_cv_va_val_copy='no' \
../configure --host=$TARGET_NAME \
             --build=$HOST_NAME \
             --prefix=/usr \
             --sysconfdir=/etc \
             --localstatedir=/var \
             --cache-file=config.cache \
             --enable-shared \
             --disable-static \
             --disable-debug \
             --disable-silent-rules \
             --disable-selinux \
             --disable-fam \
             --enable-xattr \
             --enable-regex \
             --with-gnu-ld \
             --with-threads=posix \
             --disable-man \
             --disable-rebuilds \
             --disable-gtk-doc \
             --with-pcre=system \

make

$MAKEINSTALL

mkdir -p $SYSROOT_PREFIX/usr/include/glib-2.0
  cp glibconfig.h $SYSROOT_PREFIX/usr/include/glib-2.0
mkdir -p $SYSROOT_PREFIX/usr/lib/pkgconfig
  cp g*-2.0.pc $SYSROOT_PREFIX/usr/lib/pkgconfig
