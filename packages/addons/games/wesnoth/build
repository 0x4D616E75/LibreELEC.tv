#!/bin/sh

. config/options

$SCRIPTS/build toolchain
$SCRIPTS/build boost
$SCRIPTS/build lua
$SCRIPTS/build zlib
$SCRIPTS/build libX11
$SCRIPTS/build pango
$SCRIPTS/build fontconfig
$SCRIPTS/build SDL
$SCRIPTS/build SDL_image
$SCRIPTS/build SDL_mixer
$SCRIPTS/build SDL_net
$SCRIPTS/build SDL_ttf

ADDON_ID="addon.games.$1"
ADDON_VERSION="1"

PKG_DIR=`find $ROOT/$PACKAGES -type d -name $1`

cd $PKG_BUILD

rm -rf build
mkdir -p build
cd build

cmake -DCMAKE_TOOLCHAIN_FILE=$CMAKE_CONF \
      -DCMAKE_INSTALL_PREFIX=/usr/games/$1 \
      ..

make

cd ..

mkdir -p .addons/$ADDON_ID
  cp -R data fonts images sounds translations .addons/$ADDON_ID
  cp l10n-track .addons/$ADDON_ID
  cp -R $PKG_DIR/scripts/* .addons/$ADDON_ID
  $SED "s|@ADDON_VERSION@|$OS_VERSION.$ADDON_VERSION|g" -i .addons/$ADDON_ID/addon.xml
  $SED "s|@ADDON_ID@|$ADDON_ID|g" -i .addons/$ADDON_ID/addon.xml

mkdir -p .addons/$ADDON_ID/bin
  cp build/wesnoth .addons/$ADDON_ID/bin

cd .addons
  zip -rq $ADDON_ID-$OS_VERSION.$ADDON_VERSION.zip $ADDON_ID
