#!/bin/sh

. config/options

$SCRIPTS/build toolchain
$SCRIPTS/build SDL
$SCRIPTS/build expat
$SCRIPTS/build zlib

ADDON_NAME="plugin.emulators.$1"
ADDON_VERSION="2"

PKG_DIR=`find $ROOT/$PACKAGES -type d -name $1`

cd $PKG_BUILD

# some hacks to build hosttools
  setup_toolchain host

  mkdir -p obj/sdl/mame/build \
           obj/sdl/mame/osd/sdl \
           obj/sdl/mame/lib/util \
           obj/sdl/mame/lib/zlib \
           obj/sdl/mame/emu/cpu/m68000 \
           obj/sdl/mame/emu/cpu/tms57002

  make BUILD_EXPAT=1 SDL_INSTALL_ROOT="/usr" obj/sdl/mame/build/file2str
  make BUILD_EXPAT=1 SDL_INSTALL_ROOT="/usr" obj/sdl/mame/build/png2bdc
  make BUILD_EXPAT=1 SDL_INSTALL_ROOT="/usr" obj/sdl/mame/build/m68kmake
  make BUILD_EXPAT=1 SDL_INSTALL_ROOT="/usr" obj/sdl/mame/build/tmsmake

  cp obj/sdl/mame/build/file2str $ROOT/$TOOLCHAIN/bin/mame-file2str
  cp obj/sdl/mame/build/png2bdc $ROOT/$TOOLCHAIN/bin/mame-png2bdc
  cp obj/sdl/mame/build/m68kmake $ROOT/$TOOLCHAIN/bin/mame-m68kmake
  cp obj/sdl/mame/build/tmsmake $ROOT/$TOOLCHAIN/bin/mame-tmsmake

  make clean

# now build
  setup_toolchain target

  if [ "$TARGET_ARCH" = x86_64 ]; then
    ARCH_OPTS="PTR64=1"
  else
    ARCH_OPTS="PTR64=0"
  fi

  if [ "$DEBUG" = yes ]; then
    DEBUG_OPTS="OPTIMIZE=0 DEBUG=1 SYMBOLS=1 PROFILER=1 PROFILE=1"
  else
    DEBUG_OPTS="OPTIMIZE=3"
  fi

  make CC="$TARGET_CC" \
       AR="$TARGET_AR" \
       LD="$TARGET_CXX" \
       ARCHOPTS="$TARGET_CFLAGS" \
       OPT_FLAGS='-DINI_PATH="\".\""' \
       NO_DEBUGGER=1 \
       NOWERROR=1 \
       BUILD_EXPAT=0 \
       BUILD_ZLIB=0 \
       SUFFIX64="" \
       $ARCH_OPTS \
       $DEBUG_OPTS

mkdir -p .addons/$ADDON_NAME
  cp -R $PKG_DIR/scripts/* .addons/$ADDON_NAME
  $SED "s|@ADDON_VERSION@|$OS_VERSION.$ADDON_VERSION|g" -i .addons/$ADDON_NAME/addon.xml
  cp $PKG_DIR/config/mame.ini .addons/$ADDON_NAME

mkdir -p .addons/$ADDON_NAME/bin
  cp mame .addons/$ADDON_NAME/bin

cd .addons
  zip -rq $ADDON_NAME-$OS_VERSION.$ADDON_VERSION.zip $ADDON_NAME
