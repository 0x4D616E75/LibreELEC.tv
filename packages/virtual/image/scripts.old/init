#!/bin/sh

/bin/echo "### mount ###"
/bin/mount -n -t proc none /proc
/bin/mount -n -t sysfs none /sys
/bin/mount -n -t ramfs none /dev
/bin/mount -n -t ramfs none /tmp
/bin/mount -n -t ramfs none /var

export PATH=/bin:/sbin:/usr/bin:/usr/sbin

mkdir -p /var/run
mkdir -p /var/log
mkdir -p /var/lock

echo -n "" > /tmp/mtab
echo -n "" > /tmp/fstab
echo -n "" > /tmp/mnts

busybox mknod /dev/null c 1 3

echo geexbox > /proc/sys/kernel/hostname
echo > /proc/sys/kernel/hotplug

udevd --daemon
udevadm trigger
udevadm settle --timeout=180
udevadm monitor 2>&1 >/var/log/udev &

progress() {
  [ -f /proc/splash ] && echo "show $1" > /proc/splash
  echo "### $2 ###"
}

udhcpc -q -H geexbox -n

# parse command line arguments
for arg in $(cat /proc/cmdline); do
  case $arg in
    debugging)
      DEBUG=yes
      ;;
  esac
done

progress 11000 "HDD Boot Device Detection"
for DEV in `grep '^/dev/disk' /tmp/mnts | cut -f1`; do
  DIR=`grep "^$DEV	" /tmp/mnts | cut -f2-`
  echo $DIR
  if [ -f "$DIR/openelec.system" ]; then
    progress 25000 "mounting read only filesystem"
    mkdir -p /mnt/system
    mount -o loop -t squashfs "$DIR/openelec.system" /mnt/system && break
  fi
done

#if test -n "$OPENELEC" ; then
#  progress 25000 "copying system into ram (/etc)"
#  ln -s /mnt/system/etc/* /etc
#  progress 27000 "copying system into ram (/lib)"
#  ln -s /mnt/system/lib/* /lib
#  progress 29000 "copying system into ram (/sbin)"
#  ln -s /mnt/system/sbin/* /sbin
#  progress 30500 "copying system into ram (/usr)"
#  ln -s /mnt/system/usr/* /usr
#  progress 42000 "copying system into ram (/codecs)"
#  ln -s /mnt/system/codecs /
#  progress 45000 "copying system into ram (/firmware)"
#  ln -s /mnt/system/firmware /
#  progress 46000 "copying system into ram (/themes)"
#  ln -s /mnt/system/themes /
#  INIT=/sbin/init
##else
##  INIT=/sbin/nosystem
##  progress 65535 "cleaning ram disk"
##fi

# Rebuild module dependancies (initramfs + bin archive)
#depmod -a

#udevadm trigger
#udevadm settle --timeout=180

#debug
/sbin/console </dev/tty2 >/dev/tty2 2>&1 &

/bin/sh $INIT $RUNLEVEL </dev/tty1 >/dev/tty1 2>&1

poweroff
